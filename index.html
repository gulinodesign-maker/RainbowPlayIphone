<!DOCTYPE html>
<html lang="it">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#46d1c6" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Music Rainbow" />
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="icons/icon-512.png" />
  <link rel="manifest" href="manifest.webmanifest" />

  <meta charset="UTF-8" />
  <title>Music Rainbow ‚Äî Livelli</title>

  <!-- Font morbido e grande -->
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    * { box-sizing: border-box; }
    
    html, body {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
    }

    
body {
  margin: 0;
  padding: 0;

  /* BASE ACQUAMARINA (tinta unita) */
  background: #74E7DF;
  background-color: #74E7DF;

  width: 100%;
  min-height: 100dvh;
  height: 100dvh;

  /* Evita barre bianche su iOS */
  overflow: hidden;
}

html {
  width: 100%;
  height: 100%;
  background: #74E7DF;
  background-color: #74E7DF;
}


    /* ===========================
       HOME: SELEZIONE LIVELLI
       =========================== */
    
.home-screen {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100%;
  height: 100%;
}
    .home-container {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      gap: 32px;
      text-align: left;
      color: #0f172a;
      padding: 32px 32px 40px;
      max-width: 960px;
      width: 100%;
    }

    .home-left, .home-right {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .home-left {
      transform: none;
    }

    @media (max-width: 820px) {
      .home-left {
        transform: translateY(-24px);
      }
      .home-container {
        padding-top: 24px;
      }
    }

    .home-levels {
      width: 100%;
    }

    .home-gender-wrapper {
      margin-top: 8px;
      margin-bottom: 8px;
      width: 100%;
      display: flex;
      justify-content: center;
    }

    
/* Titolo home identico a quello dei livelli */
.home-screen .rainbow-title {
  font-size: 2.8rem;
  margin: 0 0 20px 0;
  text-align: center;
  line-height: 1.05;
}


    

/* Titolo nei livelli: massimizzato ma sempre dentro la top-bar (senza invadere i tasti) */
.rainbow-title-level {
  margin: 0 !important;
  padding: 0 !important;
  line-height: 0.9;
  white-space: nowrap;
  max-width: 100%;
  min-width: 0;
  justify-self: center;
}
.top-row > .rainbow-title-level {
  min-width: 0;
}
.home-title {
      font-size: 2.6rem;
      margin-bottom: 20px;
    }

    .home-subtitle {
      font-size: 1.2rem;
      margin-bottom: 20px;
      opacity: 0.9;
    }

    .home-player-box {
      background: linear-gradient(135deg, #fef9c3, #e0f2fe);
      border-radius: 20px;
      padding: 18px 18px 20px;
      box-shadow: 0 8px 18px rgba(15,23,42,0.25);
      margin-bottom: 20px;
      text-align: left;
      border: 2px solid #bfdbfe;
    }

    .home-player-label {
      font-size: 1.1rem;
      margin-bottom: 20px;
      font-weight: 700;
    }

    .home-player-input {
      width: 100%;
      border-radius: 999px;
      border: 3px solid #fbbf24;
      padding: 10px 16px;
      font-size: 1.25rem;
      margin-bottom: 20px;
      font-family: "Baloo 2", sans-serif;
      box-shadow: 0 4px 10px rgba(148,163,184,0.45);
      background: #fefce8;
    }

    .home-player-input::placeholder {
      color: #9ca3af;
    }

    
    
.home-gender-select {
  display: flex;
  flex-direction: row;
  gap: 12px;
  align-items: center;
  justify-content: center;
  margin: 12px auto 16px;
}



    
    
    
    .home-gender-option {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
      font-weight: 700;
      border-radius: 20px;
      padding: 14px 22px;
      cursor: pointer;
      user-select: none;

      /* Liquid Glass */
      border: 2px solid rgba(255,255,255,0.85);
      box-shadow: 0 8px 16px rgba(15,23,42,0.45), inset 0 0 12px rgba(255,255,255,0.65);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      opacity: 0.96;
      background-clip: padding-box;
      transition: transform 0.12s, box-shadow 0.12s, color 0.12s;
    }
    



    .home-gender-option input[type="radio"] {
      display: none;
    }

    .home-gender-option span {
      font-size: 1rem;
    }

    .home-gender-option.active {
      background: #0ea5e9;
      color: #4b0082;
      box-shadow: 0 3px 10px rgba(14,165,233,0.7);
      transform: translateY(-1px);
    }

    .home-gender-option:active {
      transform: translateY(1px);
      box-shadow: 0 1px 4px rgba(148,163,184,0.7);
    }

    
    
.home-gender-option:nth-child(1) {
  background: #bfdbfe !important;
  color: #1e3a8a !important;
}


    
.home-gender-option:nth-child(2) {
  background: #fbcfe8 !important;
  color: #9d174d !important;
}


    .home-gender-option.active:nth-child(1) {
      background: #1d4ed8;
      color: #4b0082;
    }

    .home-gender-option.active:nth-child(2) {
      background: #db2777;
      color: #4b0082;
    }

    
    .home-levels {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      max-width: 360px;
      width: 100%;
      margin: 0 auto;
    }


    .home-levels-separator {
      height: 8px;
    }

    .home-version-label {
      margin-top: 12px;
      font-size: 0.85rem;
      color: #4b0082;
      text-align: center;
      opacity: 0.9;
    }
    .home-test-switch {
      margin-top: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      font-size: 0.9rem;
      color: #0f172a;
    }

    .home-test-toggle-wrapper {
      position: relative;
      width: 46px;
      height: 24px;
    }

    .home-test-toggle-input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .home-test-toggle-slider {
      position: absolute;
      cursor: pointer;
      inset: 0;
      background: rgba(15,23,42,0.3);
      border-radius: 999px;
      box-shadow: inset 0 0 4px rgba(15,23,42,0.6);
      transition: background 0.18s ease, box-shadow 0.18s ease;
    }

    .home-test-toggle-slider::before {
      content: "";
      position: absolute;
      height: 18px;
      width: 18px;
      left: 3px;
      top: 3px;
      border-radius: 999px;
      background: #e5e7eb;
      box-shadow: 0 2px 4px rgba(15,23,42,0.4);
      transition: transform 0.18s ease, background 0.18s ease;
    }

    .home-test-toggle-input:checked + .home-test-toggle-slider {
      background: linear-gradient(135deg, #22c55e, #0ea5e9);
      box-shadow:
        0 0 6px rgba(56,189,248,0.8),
        0 0 14px rgba(34,197,94,0.75);
    }

    .home-test-toggle-input:checked + .home-test-toggle-slider::before {
      transform: translateX(20px);
      background: #f9fafb;
    }

    .home-test-label {
      font-weight: 600;
      letter-spacing: 0.03em;
    }


    .home-level-btn {
      border-radius: 999px;
      padding: 14px 22px;
      font-size: 1.25rem;
      font-weight: 800;
      cursor: pointer;

      /* BASE: pill vetrosa neutra */
      color: #f9fafb;
      border: 2px solid rgba(255,255,255,0.9);
      background: rgba(15,23,42,0.24);
      box-shadow:
        0 10px 20px rgba(15,23,42,0.55),
        inset 0 0 14px rgba(255,255,255,0.55);
      backdrop-filter: blur(16px) saturate(185%);
      -webkit-backdrop-filter: blur(16px) saturate(185%);
      opacity: 0.99;
      background-clip: padding-box;

      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;

      transition: transform 0.12s, box-shadow 0.12s, filter 0.12s;
    }

    .home-level-btn:active {
      transform: translateY(1px) scale(0.99);
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.5);
    }

    .home-level-btn:hover {
      filter: brightness(1.06);
    }

    .home-level-btn-icon {
      font-size: 1.4rem;
      filter: drop-shadow(0 0 8px rgba(255,255,255,0.7));
    }

    .home-level-btn-label {
      flex: 1;
      text-align: left;
      letter-spacing: 0.03em;
    }

    .home-level-btn:active {
      transform: translateY(1px);
      box-shadow: 0 3px 8px rgba(15, 23, 42, 0.3);
    }

    .home-level-btn:hover {
      filter: brightness(1.05);
    }

    /* Livelli e scrigno: stile ‚Äúscrigno‚Äù dorato uguale alla pagina trofei */
    .home-level-main {
      background: linear-gradient(to bottom, #22c55e, #16a34a);
      color: #052e16;
    }
    .home-level-learn {
      background: linear-gradient(to bottom, #38bdf8, #0ea5e9);
      color: #0f172a;
    }
    .home-level-1,
    .home-level-2,
    .home-level-3,
    .home-level-trophy {
      background: linear-gradient(to bottom, #facc15, #eab308);
      color: #78350f;
    }

    
    
    .home-audio-reset {
      background: #0ea5e9;
      color: #4b0082;
      max-width: 360px;
      width: 100%;
      margin: 0 auto 16px;
    }



    /* Stato del tasto Play in home */
    .home-play-active {
      background: linear-gradient(to bottom, #a855f7, #6d28d9);
      color: #f9fafb;
    }

    .home-play-disabled {
      background: #9ca3af;
      color: #111827;
      cursor: default;
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.2);
      filter: none !important;
      transform: none !important;
    }

    .home-rainbow-graphic {
      width: 320px;
      height: 200px;
      margin: 0 auto 16px;
    }

    .home-rainbow-graphic svg {
      width: 100%;
      height: 100%;
      overflow: visible;
    }

        /* ===========================
       STILE GENERALE PAGINE LIVELLO
       =========================== */

    body {
      font-family: "Baloo 2", sans-serif;
    }

    .page-container {
      height: calc(var(--vh) * 100);
      min-height: 0;
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: stretch;
      overflow: hidden;
    }

    .app {
  margin: 0;
  padding-left: 10px;
  padding-right: 10px;
  padding-top: 0;
  padding-bottom: calc(10px + env(safe-area-inset-bottom, 0px));
  width: 100%;
  height: 100%;
  background: transparent;
  border-radius: 12px;
  position: relative;
  z-index: 1;
  display: flex;
  flex-direction: column;
  min-height: 0;
}

.top-panel {
  /* Niente pill/glass: tutto appoggiato sulla base acquamarina */
  border-radius: 0;
  padding: 6px 14px 0;
  background: transparent;
  border: none;
  box-shadow: none;
  backdrop-filter: none;
  -webkit-backdrop-filter: none;
}

    .top-row {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 4px;
      margin-bottom: 20px;
      margin-top: 0;
    }

    .top-row h1 {
      font-size:  4.4rem;
      margin: 0;
      text-align: center;
      justify-self: center;
      line-height: 0.85;
      padding: 0;
    }

    .top-left-controls {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: flex-start;
    
      justify-self: start;
}

    .clef-btn {
      border-radius: 999px;
      border: 2px solid #e5e7eb;
      background: #ffffff;
      padding: 4px 9px 6px;
      font-size: 1.1rem;
      line-height: 1;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 1px 2px rgba(15,23,42,0.08);
      height:48px;
  min-width:48px;
  font-size:28px;
  padding:0 12px;
  border-radius:12px;
}

    .clef-btn.active-clef {
      border-color: #4f46e5;
      background: #eef2ff;
      box-shadow: 0 0 0 1px rgba(79,70,229,0.18);
    }

    .clef-hidden { display: none !important; }


    .top-right-controls {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: flex-end;
    
      justify-self: end;
}

    
    .rainbow-title span {
      display: inline-block;
      font-weight: 800;
      letter-spacing: 0.04em;

      /* LIQUID GLASS TEXT: ogni carattere vetroso + NEON pulsante */
      color: currentColor;
      text-shadow:
        0 0 4px rgba(255,255,255,0.75),
        0 0 10px currentColor,
        0 0 18px currentColor;
      filter: saturate(150%);
      animation: neonTitlePulse 1.8s ease-in-out infinite;
    }
    .rainbow-title span:nth-child(7n+1){color:#ef4444;}
    .rainbow-title span:nth-child(7n+2){color:#f97316;}
    .rainbow-title span:nth-child(7n+3){color:#eab308;}
    .rainbow-title span:nth-child(7n+4){color:#22c55e;}
    .rainbow-title span:nth-child(7n+5){color:#38bdf8;}
    .rainbow-title span:nth-child(7n+6){color:#a855f7;}
    .rainbow-title span:nth-child(7n){color:#4f46e5;}

    @keyframes neonTitlePulse {
      0%, 100% {
        text-shadow:
          0 0 4px rgba(255,255,255,0.75),
          0 0 10px currentColor,
          0 0 18px currentColor;
        transform: translateY(0);
      }
      50% {
        text-shadow:
          0 0 6px rgba(255,255,255,0.95),
          0 0 16px currentColor,
          0 0 30px currentColor;
        transform: translateY(-1px);
      }
    }



    /* Switch auto-color livello 1 */
    .auto-toggle {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 0.8rem;
      color: #111827;
      cursor: pointer;
      user-select: none;
    }

    .auto-toggle-input {
      opacity: 0;
      width: 0;
      height: 0;
      position: absolute;
    }

    .auto-slider {
      position: relative;
      width: 34px;
      height: 18px;
      background-color: #e5e7eb;
      border-radius: 999px;
      transition: background-color 0.15s;
      box-shadow: inset 0 1px 3px rgba(15,23,42,0.2);
    }

    .auto-slider::before {
      content: "";
      position: absolute;
      height: 14px;
      width: 14px;
      left: 2px;
      top: 2px;
      background-color: #4b0082;
      border-radius: 50%;
      transition: transform 0.15s;
      box-shadow: 0 1px 3px rgba(15,23,42,0.5);
    }

    .auto-toggle-input:checked + .auto-slider {
      background: linear-gradient(90deg, #38bdf8, #a855f7);
    }

    .auto-toggle-input:checked + .auto-slider::before {
      transform: translateX(16px);
    }

    .auto-label {
      font-size: 0.8rem;
      padding-right: 2px;
    }

    .reset-btn {
      padding: 10px 16px;
      border-radius: 999px;
      font-weight: 700;
      font-size: 1.05rem;
      cursor: pointer;
      border: none;
      color: #4b0082;
      background: #7c3aed;
      box-shadow: 0 4px 10px rgba(80, 30, 140, 0.25);
      transition: 0.15s;
    }
    .reset-btn:hover { filter: brightness(1.1); }
    .reset-btn:active {
      transform: translateY(1px);
      box-shadow: 0 2px 6px rgba(80, 30, 140, 0.2);
    }

    .menu-btn,
    .trophy-btn,
    
    .hint-btn {
      padding: 10px 16px;
      min-width: 44px;
      min-height: 44px;
      border-radius: 999px;
      font-weight: 700;
      font-size: 1.1rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;

      /* verde acqua originale + liquid glass */
      color: #0f172a;
      background: rgba(209, 250, 229, 0.95);

      border: 2px solid rgba(255,255,255,0.8);
      box-shadow:
        0 6px 14px rgba(16,185,129,0.4),
        inset 0 0 10px rgba(255,255,255,0.65);
      backdrop-filter: blur(12px) saturate(175%);
      -webkit-backdrop-filter: blur(12px) saturate(175%);
      background-clip: padding-box;

      transition: 0.15s;
    }

    .hint-btn:disabled {
      opacity: 0.5;
      cursor: default;
      box-shadow: none;
      filter: none;
    }


    .hint-btn:disabled {
      opacity: 0.5;
      cursor: default;
      box-shadow: none;
      filter: none;
    }

    
    .menu-btn {
      padding: 10px 16px;
      min-width: 44px;
      min-height: 44px;
      border-radius: 999px;
      font-weight: 700;
      font-size: 1.1rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;

      /* colore originale + liquid glass */
      color: #111827;
      background: rgba(229, 231, 235, 0.92);

      border: 2px solid rgba(255,255,255,0.75);
      box-shadow:
        0 6px 14px rgba(15,23,42,0.35),
        inset 0 0 10px rgba(255,255,255,0.65);
      backdrop-filter: blur(12px) saturate(170%);
      -webkit-backdrop-filter: blur(12px) saturate(170%);
      background-clip: padding-box;

      transition: 0.15s;
    }


    
    .trophy-btn {
      padding: 10px 16px;
      min-width: 44px;
      min-height: 44px;
      border-radius: 999px;
      font-weight: 700;
      font-size: 1.1rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;

      /* dorato originale + liquid glass */
      color: #78350f;
      background: linear-gradient(
        to bottom,
        rgba(250, 204, 21, 0.96),
        rgba(234, 179, 8, 0.96)
      );

      border: 2px solid rgba(255,255,255,0.85);
      box-shadow:
        0 7px 16px rgba(180,83,9,0.45),
        inset 0 0 12px rgba(255,255,255,0.7);
      backdrop-filter: blur(14px) saturate(180%);
      -webkit-backdrop-filter: blur(14px) saturate(180%);
      background-clip: padding-box;

      transition: 0.15s;
    }


    .hint-btn {
      color: #0f172a;
      background: #d1fae5;
      box-shadow: 0 3px 8px rgba(16,185,129,0.35);
    }

    .menu-btn:hover,
    .trophy-btn:hover,
    .hint-btn:hover { filter: brightness(1.05); }

    .menu-btn:active,
    .trophy-btn:active,
    .hint-btn:active {
      transform: translateY(1px);
      box-shadow: 0 1px 4px rgba(15,23,42,0.4);
    }

    .hint-btn.hint-pulse {
      transform: scale(1.1);
    }


    
    .rainbow-counter {
      font-size: 1.05rem;
      padding: 8px 14px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;

      border: 2px solid rgba(255,255,255,0.85);

      /* azzurro originale + liquid glass */
      background: rgba(238, 242, 255, 0.94);
      color: #1e3a8a;

      box-shadow:
        0 6px 14px rgba(15,23,42,0.3),
        inset 0 0 10px rgba(255,255,255,0.7);
      backdrop-filter: blur(12px) saturate(170%);
      -webkit-backdrop-filter: blur(12px) saturate(170%);
      background-clip: padding-box;
    }
    .rainbow-counter span {
      font-weight: 800;
      font-size: 1.4rem;
    }
    .rainbow-hidden-count {
      display: none;
    }

    .rainbow-counter span {
      font-weight: 800;
      font-size: 1.4rem;
    }
    .rainbow-hidden-count {
      display: none;
    }

    .medals-panel-container {
      border-radius: 16px;
      border: 1px solid #e0e3f0;
      padding: 6px 10px;
      background: #f9fafb;
    }

    .medals-panel-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .tokens-panel {
      display: flex;
      flex-wrap: wrap;
      justify-content: flex-end;
      align-items: center;
      gap: 6px;
      min-height: 32px;
      min-width: 80px;
    }
    .token-label {
      font-size: 0.8rem;
      color: #374151;
      margin-right: 4px;
    }
    .token-icon-btn {
      border: none;
      background: transparent;
      padding: 0;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .token-icon-btn:disabled {
      opacity: 0.4;
      cursor: default;
    }
    .token-svg {
      width: 32px;
      height: 32px;
      filter: drop-shadow(0 2px 4px rgba(15,23,42,0.4));
    }

    /* Gettoni nella bacheca della pagina Trofei: 3 volte pi√π grandi */
    #trophyTokensRow .token-svg {
      width: 96px;
      height: 96px;
    }

    #trophyTokensRow .trophy-token-btn {
      padding: 4px;
    }

    
    /* ===========================
       SELEZIONE LIVELLO - OVERLAY
       =========================== */
    .level-select-overlay {
      position: fixed;
      inset: 0;
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10500;

      /* SFONDO PRINCIPALE ACQUAMARINA + VETRO LIQUIDO */
      backdrop-filter: blur(10px) saturate(170%);
      -webkit-backdrop-filter: blur(10px) saturate(170%);
      background: radial-gradient(circle at center,
        rgba(70, 209, 198, 0.98),
        rgba(34, 197, 151, 0.94),
        rgba(15, 23, 42, 0.88));
    }

    .level-select-overlay.active {
      display: flex;
    }

    .level-select-box {
      background: rgba(15,23,42,0.98);
      border-radius: 24px;
      padding: 22px 20px 18px;
      width: min(360px, 88%);
      box-shadow: 0 18px 40px rgba(15,23,42,0.85);
      border: 2px solid rgba(129,140,248,0.9);
      text-align: center;
    }

    .level-select-title {
      font-size: 1.4rem;
      margin-bottom: 20px;
      color: #e5e7eb;
    }

    .level-select-subtitle {
      font-size: 0.95rem;
      margin-bottom: 20px;
      color: #c7d2fe;
    }

    .level-select-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      margin-bottom: 20px;
    }

    
.level-select-btn {
  border-radius: 999px;
  padding: 20px 12px;
  font-size: 2rem;
  font-weight: 800;
  cursor: pointer;

  /* Liquid Glass style like home */
  color: #f9fafb;
  border: 2px solid rgba(255,255,255,0.9);
  background: rgba(15,23,42,0.24);
  box-shadow:
    0 10px 20px rgba(15,23,42,0.55),
    inset 0 0 14px rgba(255,255,255,0.55);
  backdrop-filter: blur(16px) saturate(185%);
  -webkit-backdrop-filter: blur(16px) saturate(185%);
  opacity: 0.99;
  background-clip: padding-box;

  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;

  transition: transform 0.12s, box-shadow 0.12s, filter 0.12s;
}
/* Colored Liquid Glass buttons for level select */
.level-select-btn:nth-child(1) {
  background: rgba(239,68,68,0.35);
  border-color: rgba(239,68,68,0.9);
  box-shadow:
    0 0 16px rgba(239,68,68,0.9),
    0 0 32px rgba(239,68,68,0.9),
    inset 0 0 10px rgba(255,255,255,0.4);
}

.level-select-btn:nth-child(2) {
  background: rgba(249,115,22,0.35);
  border-color: rgba(249,115,22,0.9);
  box-shadow:
    0 0 16px rgba(249,115,22,0.9),
    0 0 32px rgba(249,115,22,0.9),
    inset 0 0 10px rgba(255,255,255,0.4);
}

.level-select-btn:nth-child(3) {
  background: rgba(234,179,8,0.35);
  border-color: rgba(234,179,8,0.9);
  box-shadow:
    0 0 16px rgba(234,179,8,0.9),
    0 0 32px rgba(234,179,8,0.9),
    inset 0 0 10px rgba(255,255,255,0.4);
}

.level-select-btn:nth-child(4) {
  background: rgba(34,197,94,0.35);
  border-color: rgba(34,197,94,0.9);
  box-shadow:
    0 0 16px rgba(34,197,94,0.9),
    0 0 32px rgba(34,197,94,0.9),
    inset 0 0 10px rgba(255,255,255,0.4);
}



    /* Colori neon per ogni tasto livello */
    

    

    

    

    
      50% {
        transform: translateY(-2px) scale(1.03);
        filter: brightness(1.1);
      }
      100% {
        transform: translateY(0) scale(1);
        filter: brightness(1.02);
      }
    }

    .level-select-btn:hover {
      filter: brightness(1.05);
    }

    .level-select-btn:active {
      transform: translateY(1px);
      box-shadow: 0 2px 5px rgba(15,23,42,0.6);
    }

    .level-select-actions {
      display: flex;
      justify-content: center;
    }

    .level-select-close {
      border-radius: 999px;
      padding: 8px 18px;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;

      /* Liquid Glass per il tasto Chiudi */
      border: 2px solid rgba(255,255,255,0.85);
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      box-shadow:
        0 8px 16px rgba(15,23,42,0.75),
        inset 0 0 10px rgba(255,255,255,0.55);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      opacity: 0.97;
      background-clip: padding-box;
    }

    .level-select-close:active {
      transform: translateY(1px);
      box-shadow: 0 1px 4px rgba(15,23,42,0.8);
    }



    /* ===========================
       POPUP SCRIGNI TROFEI
       =========================== */
    
.token-icon {
  width: 42px;
  height: 42px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.token-svg {
  width: 42px;
  height: 42px;
}

.trophy-overlay {
      position: fixed;
      inset: 0;
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 12000;
      backdrop-filter: blur(4px);
      background: radial-gradient(circle at center,
        rgba(15,23,42,0.88),
        rgba(30,64,175,0.94),
        rgba(15,23,42,0.96));
    }

    .trophy-overlay.active {
      display: flex;
    }

    .trophy-overlay-box {
      position: relative;
      background: #f9fafb;
      border-radius: 24px;
      padding: 22px 22px 18px;
      width: min(90%, 520px);
      max-width: 520px;
      box-shadow: 0 18px 42px rgba(0,0,0,0.5);
      border: 2px solid #e5e7eb;
    }

    .trophy-overlay-content {
      max-height: min(60vh, 420px);
      overflow-y: auto;
    }

    
.trophy-overlay-close {
  position: absolute;
  top: 8px;
  right: 8px;
  width: 44px;
  height: 44px;
  border-radius: 999px;
  border: none;
  background: #f97316;
  color: #4b0082;
  font-size: 1.8rem;
  font-weight: 700;
  cursor: pointer;
  box-shadow: 0 8px 18px rgba(0,0,0,0.6);
  display: flex;
  align-items: center;
  justify-content: center;
}


    .trophy-overlay-close:active {
      transform: translateY(1px);
      box-shadow: 0 3px 8px rgba(0,0,0,0.7);
    }


    .token-overlay {
      position: fixed;
      inset: 0;
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 11000;
      backdrop-filter: blur(4px);
      background: radial-gradient(circle at center,
        rgba(255,255,255,0.96),
        rgba(252,211,77,0.85),
        rgba(245,158,11,0.55));
    }
    .token-overlay.active {
      display: flex;
    }
    .token-box {
      background: rgba(255,255,255,0.98);
      padding: 24px 26px 20px;
      border-radius: 24px;
      box-shadow: 0 12px 15px rgba(0,0,0,0.35);
      text-align: center;
      max-width: 360px;
    }
    .token-big-svg {
      width: 80px;
      height: 80px;
      margin-bottom: 20px;
      filter: drop-shadow(0 6px 12px rgba(146,64,14,0.6));
    }
    .token-message-main {
      font-size: 1.4rem;
      font-weight: 700;
      margin-bottom: 20px;
      color: #92400e;
    }
    .token-message-sub {
      font-size: 0.95rem;
      color: #78350f;
    }

    
    .play-timer-pill {
      padding: 8px 16px;
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,0.85);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 80px;
      font-family: "Baloo 2", sans-serif;
      font-size: 1.2rem;
      font-weight: 700;
      cursor: default;

      /* acquamarina originale + liquid glass */
      background: rgba(70, 209, 198, 0.96);
      color: #4b0082;

      box-shadow:
        0 6px 14px rgba(15,23,42,0.35),
        inset 0 0 10px rgba(255,255,255,0.7);
      backdrop-filter: blur(14px) saturate(180%);
      -webkit-backdrop-filter: blur(14px) saturate(180%);
      background-clip: padding-box;
    }

    
    .metronome-pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;

      /* colore scuro originale + liquid glass */
      background: rgba(15, 23, 42, 0.4);
      border: 2px solid rgba(255,255,255,0.7);

      box-shadow:
        0 5px 12px rgba(15,23,42,0.5),
        inset 0 0 8px rgba(255,255,255,0.35);
      backdrop-filter: blur(12px) saturate(170%);
      -webkit-backdrop-filter: blur(12px) saturate(170%);
      background-clip: padding-box;
    }

    .metronome-bpm-input {
      width: 56px;
      border: none;
      border-radius: 999px;
      padding: 4px 8px;
      font-size: 0.85rem;
      text-align: center;
      outline: none;
      font-family: "Baloo 2", sans-serif;
    }
    .metronome-dot {
      width: 14px;
      height: 14px;
      border-radius: 999px;
      background: #22c55e;
      opacity: 0.4;
      
      transition: transform 0.12s ease-out, opacity 0.12s ease-out;
    }
    .metronome-dot.active {
      opacity: 1;
      
    }
    .metronome-switch {
      position: relative;
      display: inline-flex;
      width: 44px;
      height: 24px;
      flex: 0 0 auto;
    }
    .metronome-switch input {
      position: absolute;
      opacity: 0;
      width: 0;
      height: 0;
    }
    .metronome-slider {
      position: absolute;
      inset: 0;
      border-radius: 999px;
      background: rgba(255,255,255,0.20);
      border: 2px solid rgba(255,255,255,0.65);
      box-shadow: inset 0 0 6px rgba(255,255,255,0.25);
      transition: background 0.15s ease-out;
    }
    .metronome-slider:before {
      content: "";
      position: absolute;
      width: 18px;
      height: 18px;
      left: 2px;
      top: 2px;
      border-radius: 999px;
      background: #ffffff;
      box-shadow: 0 2px 6px rgba(15,23,42,0.35);
      transition: transform 0.15s ease-out;
    }
    .metronome-switch input:checked + .metronome-slider {
      background: rgba(34, 197, 94, 0.45);
    }
    .metronome-switch input:checked + .metronome-slider:before {
      transform: translateX(20px);
    }

    

    .error-pill {
      margin-left: 6px;
    }

    .play-timer-pill span {
      font-variant-numeric: tabular-nums;
      letter-spacing: 0.03em;
    }
    .play-timeup-overlay {
      position: absolute;
      inset: 0;
      background: rgba(15,23,42,0.65);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 20;
    }
    .play-timeup-overlay.active {
      display: flex;
    }
    .play-timeup-box {
      background: #ffffff;
      padding: 20px 24px;
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.35);
      max-width: 320px;
      text-align: center;
    }

    .medals-panel {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      min-height: 32px;
      justify-content: center;
    }

    .medal-icon {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      box-shadow: 0 3px 7px rgba(15,23,42,0.25);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      font-size: 0.95rem;
      font-weight: 700;
    }
    .medal-icon::after {
      content: "üèÖ";
      position: absolute;
      top: -9px;
      font-size: 1rem;
    }

    .medal-icon.bronze { background: radial-gradient(circle at 30% 30%, #fecaca, #ef4444, #7f1d1d); border:2px solid #ef4444; color:#7f1d1d; }
    .medal-icon.silver { background: radial-gradient(circle at 30% 30%, #ffedd5, #f97316, #7c2d12); border:2px solid #f97316; color:#7c2d12; }
    .medal-icon.green { background: radial-gradient(circle at 30% 30%, #dcfce7, #22c55e, #14532d); border:2px solid #22c55e; color:#14532d; }
.medal-icon.gold { background: radial-gradient(circle at 30% 30%, #fef9c3, #eab308, #92400e); border:2px solid #eab308; color:#92400e; }
.staff-container {
  padding: 6px;
  margin: 0;

  /* STAFF WHITE BACKPLATE */
  background: #ffffff;
  border: none;
  box-shadow: 0 10px 22px rgba(15,23,42,0.25);
  border-radius: 18px;
  overflow: visible;

  width: 100%;
  flex: 1 1 auto;
  min-height: 0;
  display: flex;
  align-items: center;
  justify-content: center;
}
svg.staff {
      width: 100%;
      max-width: none;
      height: auto;
      display: block;
      margin: 0 auto;
      cursor: pointer;
      overflow: visible;
    }

    .note-circle {
      stroke: #111827;
      stroke-width: 2.4;
      fill: white;
      fill-opacity: 0.96;
      filter: drop-shadow(0 6px 14px rgba(15,23,42,0.45));
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      transition: transform 0.18s ease,
                  stroke-width 0.18s ease,
                  opacity 0.18s ease,
                  filter 0.18s ease;
      cursor: pointer;
    }

.note-symbol {
  pointer-events: none;
  transition: transform 0.15s ease-out;
}
    .note-symbol.note-played {
  transform-origin: center;
  animation: notePulse 0.35s ease-out;
  filter: drop-shadow(0 6px 14px rgba(15,23,42,0.55));
}
/* Override: nel Livello 4 le note NON devono lampeggiare quando vengono suonate */
#level4Page .note-symbol.note-played {
  animation: none !important;
  filter: none !important;
  transform: none !important;
}
/* Disattiva animazione nel Livello Impara Tempo */
#learnTempoPage .note-symbol.note-played { animation:none !important; transform:none !important; filter:none !important; opacity:0.77 !important; }



#level1Page .note-symbol.note-played .note-head,
#level2Page .note-symbol.note-played .note-head {
  stroke: rgba(255,255,255,0.9);
  stroke-width: 2.4;
  fill-opacity: 0.96;
}

#level1Page .note-symbol.note-played .note-stem,
#level2Page .note-symbol.note-played .note-stem,
#level1Page .note-symbol.note-played .note-flag,
#level2Page .note-symbol.note-played .note-flag {
  stroke-width: 2.4;
}


.note-head {
  stroke: #111827;
  stroke-width: 2;
  fill: #ffffff;
}
.note-head.filled {
  fill: #111827;
}

.note-stem {
      stroke: #111827;
      stroke-width: 2;
    }
    .note-flag {
      stroke: #111827;
      stroke-width: 2;
      fill: none;
    }

    .hint-circle {
      stroke: #111827;
      stroke-width: 2;
      cursor: default;
    }

    /* TARGET PER LIVELLO */
    #level1Page .note-circle.target {
      /* versione compatibile con Safari / iPad:
         niente gradient url(), bordo spesso e interno evidenziato */
      stroke: #111827;
      stroke-width: 4;
      fill: white;
      filter: none;
    }

    #level2Page .note-circle.target,
    #level3Page .note-circle.target {
      stroke: #000000;
      stroke-width: 4;
      filter: none;
    }

    
    /* Neon pulsante per i pallini del Livello 1 */
    #level1Page .note-circle.neon-pulse-l1 {
      animation: neonPulseL1 0.9s ease-in-out infinite alternate;
      transform-origin: center;
    }

    @keyframes neonPulseL1 {
      0% {
        transform: scale(1);
      }
      100% {
        transform: scale(1.15);
      }
    }

.ledger-line {
      stroke: #111827;
      stroke-width: 2;
    }

    .error-x {
      font-size: 22px;
      fill: #dc2626;
      pointer-events: none;
      animation: pop-fade 0.6s ease-out forwards;
    }
    @keyframes pop-fade {
      0%{opacity:0.0;}
      40%{opacity:0.77;}
      100%{opacity:0.0; translateY(-10px);}
    }

    /* Barra di stato: solo Note / Errori */
    .status-bar {
      text-align: center;
      font-size: 0.95rem;
      font-weight: 700;
      min-height: 1.6em;
      margin-top: 10px;
    }
    .status-pills {
      display: inline-flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
    }
    .stat-pill {
      padding: 4px 10px;
      border-radius: 999px;
      min-width: 80px;
      font-size: 0.9rem;
      display: inline-flex;
      justify-content: center;
      align-items: center;
      box-shadow: 0 2px 4px rgba(15,23,42,0.15);
      height:48px;
  line-height:48px;
  font-size:22px;
  padding:0 14px;
  border-radius:12px;
}
    .stat-notes {
      background: #dcfce7;
      color: #166534;
    }
    .stat-errors-normal {
      background: #fef9c3;
      color: #92400e;
    }
    .stat-errors-high {
      background: #fee2e2;
      color: #991b1b;
    }

    .keyboard-container {
  margin: 0;
  width: 100%;
  flex: 0 0 auto;

  /* IMPORTANTE (iPhone): non ‚Äúancorare‚Äù la tastiera al fondo con margin-top:auto,
     perch√© il blocco staff (flex:1) la spinge sempre gi√π.
     Lasciamo che stia subito sotto lo staff e creiamo un gap reale sotto. */
  margin-top: 10px;

  /* Gap costante + safe-area: cos√¨ i tasti non restano a filo bordo */
  margin-bottom: calc(22px + env(safe-area-inset-bottom, 0px));
  padding-bottom: 0;
}

    .piano-keys {
      position: relative;
      display: flex;
      width: 100%;
      max-width: none;
      margin: 0;
      height: clamp(120px, min(calc((100vw - 20px) * 0.32), 35vh), 320px);
    }

    .white-key {
  border: 2px solid rgba(255,255,255,0.85);
  box-shadow: 0 8px 16px rgba(15,23,42,0.45), inset 0 0 12px rgba(255,255,255,0.65);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  opacity: 0.96;

      flex: 1;
      margin: 0 1px;
      border-radius: 0 0 12px 12px;
      border: 1px solid #9ca3af;
      background: linear-gradient(to bottom, #ffffff 0%, #f3f4f6 40%, #e5e7eb 100%);
      box-shadow: 0 3px 6px rgba(15,23,42,0.25);
      display: flex;
      justify-content: center;
      align-items: flex-end;
      font-size: 0.9rem;
      font-weight: 700;
      color: #111827;
      padding-bottom: 6px;
      cursor: pointer;
      transition: 0.12s;
      box-sizing: border-box;
      position: relative;
      z-index: 1;
    }
    .white-key:active {
      transform: translateY(1px);
      box-shadow: 0 2px 4px rgba(15,23,42,0.3);
    }

    .black-key {
  border: 2px solid rgba(255,255,255,0.6);
  box-shadow: 0 6px 12px rgba(0,0,0,0.55), inset 0 0 10px rgba(255,255,255,0.4);
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
  opacity: 0.9;

      position: absolute;
      top: 0;
      transform: translateX(-50%);
      width: calc(100% / 14 * 0.9);
      height: 70%;
      border-radius: 0 0 10px 10px;
      background: linear-gradient(to bottom, #111827 0%, #020617 70%);
      border: 1px solid #020617;
      box-shadow: 0 4px 8px rgba(0,0,0,0.6);
      display: flex;
      justify-content: center;
      align-items: flex-end;
      font-size: 0.75rem;
      font-weight: 700;
      color: #e5e7eb;
      padding-bottom: 4px;
      cursor: pointer;
      transition: 0.08s;
      z-index: 2;
    }
    .black-key:active {
      transform: translateX(-50%) translateY(1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.7);
    }

    .white-key.key-pressed {
      transform: translateY(4px);
      box-shadow: 0 1px 3px rgba(15,23,42,0.35);
    }

    .black-key.key-pressed {
      transform: translateX(-50%) translateY(4px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.7);
    }

    .note-buttons-container { text-align: center; margin: 0 10px 10px; }

    
    .tempo-action-container {
      margin: 24px 16px 12px;
      display: flex;
      justify-content: center;
    }
    .tempo-action-btn {
      width: 100%;
      max-width: 520px;
      aspect-ratio: 5 / 1; /* barra orizzontale 5:1 */
      border-radius: 24px;
      font-size: 1.6rem;
      font-weight: 800;
      cursor: pointer;
      border: 2px solid rgba(255,255,255,0.9);
      background: #0ea5e9;
      color: #4b0082;
      box-shadow:
        0 10px 20px rgba(15,23,42,0.45),
        inset 0 0 14px rgba(255,255,255,0.65);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .tempo-action-btn:active {
      transform: translateY(1px);
      box-shadow: 0 4px 10px rgba(15,23,42,0.5);
    }
.note-buttons-wrapper {
      width: 100%;
      max-width: none;
      margin: 12px 0 0 0;
      background: #d4d4d8;
      padding: 16px 12px 22px;
      border-radius: 18px;
      box-shadow: 0 4px 10px rgba(15,23,42,0.18);
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 12px;
    
  
  
  
  }

    .note-button {
  border-radius: 999px;
  padding: 12px 18px;
  font-size: 1.1rem;
  font-weight: 800;
  color: #4b0082;
  cursor: pointer;

  /* Liquid glass pill + larghezza uniforme */
  border: 2px solid rgba(255,255,255,0.85);
  box-shadow: 0 8px 16px rgba(15,23,42,0.45), inset 0 0 12px rgba(255,255,255,0.65);
  transition: transform 0.1s, box-shadow 0.1s, filter 0.1s;
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  opacity: 0.96;
  background-clip: padding-box;

  /* Tutti i tasti DO‚ÄìSI stessa larghezza */
  flex: 1 1 0;
  text-align: center;
}

    .note-button:active {
      transform: translateY(1px);
      box-shadow: 0 1px 4px rgba(15,23,42,0.4);
    }

    .note-button:hover {
      filter: brightness(1.05);
    }

    .note-button.selected {
      outline: none;
      box-shadow: none;
    }
    /* Pressione visiva dei tasti nota nel Livello 1 */

/* Neon molto luminoso per i tasti DO‚ÄìSI nel Livello 1 quando vengono premuti */
#level1Page .btn-do.note-pressed  { box-shadow: 0 0 22px #ef4444, 0 0 52px #ef4444; }
#level1Page .btn-re.note-pressed  { box-shadow: 0 0 22px #f97316, 0 0 52px #f97316; }
#level1Page .btn-mi.note-pressed  { box-shadow: 0 0 22px #eab308, 0 0 52px #eab308; }
#level1Page .btn-fa.note-pressed  { box-shadow: 0 0 22px #22c55e, 0 0 52px #22c55e; }
#level1Page .btn-sol.note-pressed { box-shadow: 0 0 22px #38bdf8, 0 0 52px #38bdf8; }
#level1Page .btn-la.note-pressed  { box-shadow: 0 0 22px #a855f7, 0 0 52px #a855f7; }
#level1Page .btn-si.note-pressed  { box-shadow: 0 0 22px #4f46e5, 0 0 52px #4f46e5; }
    


#level1Page .note-button.note-pressed {
  transform: translateY(4px);
}






/* Neon molto luminoso per i tasti DO‚ÄìSI nella MAPPA (learnNotesPage) quando vengono premuti */
#learnNotesPage .btn-do.note-pressed  { box-shadow: 0 0 22px #ef4444, 0 0 52px #ef4444; }
#learnNotesPage .btn-re.note-pressed  { box-shadow: 0 0 22px #f97316, 0 0 52px #f97316; }
#learnNotesPage .btn-mi.note-pressed  { box-shadow: 0 0 22px #eab308, 0 0 52px #eab308; }
#learnNotesPage .btn-fa.note-pressed  { box-shadow: 0 0 22px #22c55e, 0 0 52px #22c55e; }
#learnNotesPage .btn-sol.note-pressed { box-shadow: 0 0 22px #38bdf8, 0 0 52px #38bdf8; }
#learnNotesPage .btn-la.note-pressed  { box-shadow: 0 0 22px #a855f7, 0 0 52px #a855f7; }
#learnNotesPage .btn-si.note-pressed  { box-shadow: 0 0 22px #4f46e5, 0 0 52px #4f46e5; }

#learnNotesPage .note-button.note-pressed {
  transform: translateY(4px);
}


#level2Page .note-button.note-pressed {
  animation: innerPulseL1 0.25s alternate infinite;
      transform: translateY(4px);
      box-shadow: 0 2px 6px rgba(15,23,42,0.45);
    }

    /* Illuminazione forte del colore corrispondente mentre il tasto √® premuto (Livello 1)
   + neon esterno per ogni nota DO‚ÄìSI nel Livello 1 */

/* Neon molto luminoso per i tasti DO‚ÄìSI nel Livello 1 quando vengono premuti */
#level1Page .btn-do.note-pressed  { box-shadow: 0 0 22px #ef4444, 0 0 52px #ef4444; }
#level1Page .btn-re.note-pressed  { box-shadow: 0 0 22px #f97316, 0 0 52px #f97316; }
#level1Page .btn-mi.note-pressed  { box-shadow: 0 0 22px #eab308, 0 0 52px #eab308; }
#level1Page .btn-fa.note-pressed  { box-shadow: 0 0 22px #22c55e, 0 0 52px #22c55e; }
#level1Page .btn-sol.note-pressed { box-shadow: 0 0 22px #38bdf8, 0 0 52px #38bdf8; }
#level1Page .btn-la.note-pressed  { box-shadow: 0 0 22px #a855f7, 0 0 52px #a855f7; }
#level1Page .btn-si.note-pressed  { box-shadow: 0 0 22px #4f46e5, 0 0 52px #4f46e5; }

/* Affondamento dolce del tasto nel Livello 1 */
#level1Page .note-button.note-pressed {
  transform: translateY(4px);
}


    .note-button.hint-glow {
      box-shadow:
        0 0 0 4px rgba(255,255,255,1),
        0 0 16px rgba(252,165,165,1),
        0 0 26px rgba(248,113,113,0.95),
        inset 0 0 5px rgba(255,255,255,0.05);
      filter: brightness(1.2);
      transform: translateY(-3px) scale(1.12);
      animation: hintGlowPulse 0.75s ease-in-out infinite;
    }

    @keyframes hintGlowPulse {
      0% {
        box-shadow:
          0 0 0 4px rgba(255,255,255,1),
          0 0 24px rgba(252,165,165,0.9),
          0 0 40px rgba(248,113,113,0.85),
          inset 0 0 22px rgba(255,255,255,0.95);
        transform: translateY(-3px) scale(1.08);
      }
      50% {
        box-shadow:
          0 0 0 5px rgba(255,255,255,1),
          0 0 40px rgba(252,165,165,1),
          0 0 64px rgba(248,113,113,1),
          inset 0 0 34px rgba(255,255,255,0.05);
        transform: translateY(-4px) scale(1.16);
      }
      100% {
        box-shadow:
          0 0 0 4px rgba(255,255,255,1),
          0 0 24px rgba(252,165,165,0.9),
          0 0 40px rgba(248,113,113,0.85),
          inset 0 0 22px rgba(255,255,255,0.95);
        transform: translateY(-3px) scale(1.08);
      }
    }

    .btn-do  { background:#ef4444; box-shadow: none; }
    .btn-re  { background:#f97316; box-shadow: none; }
    .btn-mi  { background:#eab308; box-shadow: none; }
    .btn-fa  { background:#22c55e; box-shadow: none; }
    .btn-sol { background:#38bdf8; box-shadow: none; }
    .btn-la  { background:#a855f7; box-shadow: none; }
    .btn-si  { background:#4f46e5; box-shadow: none; }

    .rainbow-overlay {
      position: fixed;
      inset: 0;
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      backdrop-filter: blur(4px);
      background: radial-gradient(circle at center,
        rgba(255,255,255,0.95),
        rgba(255,255,255,0.85),
        rgba(230,240,255,0.7));
    }
    .rainbow-overlay.active { display:flex; }

    .rainbow-box {
      background: rgba(255,255,255,0.98);
      padding: 28px 30px 24px;
      border-radius: 24px;
      box-shadow: 0 10px 26px rgba(0,0,0,0.18);
      text-align: center;
      max-width: 460px;
    }

    .rainbow-graphic {
      position:relative;
      width:320px;
      height:200px;
      margin:0 auto 16px;
    }
    .rainbow-graphic svg { width:100%;height:100%;overflow:visible; }

    .medal-in-arc {
      position:absolute;
      top:56%; left:50%;
      transform:translate(-50%,-50%);
      display:flex;
    }

    .medal-circle {
      width:140px;height:140px;
      border-radius:50%;
      box-shadow:0 6px 16px rgba(0,0,0,0.25);
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      border-width:4px;
      border-style:solid;
    }
    .medal-circle::after {
      content:"üèÖ";
      position:absolute;
      top:-22px;
      font-size:2rem;
    }

    .medal-circle span {
      font-size:3.2rem;
      font-weight:800;
    }

    #rainbowOverlayL1 .medal-circle {
      background:radial-gradient(circle at 30% 30%, #fecaca, #ef4444, #7f1d1d);
      border-color:#ef4444;
      color:#7f1d1d;
    }

    #rainbowOverlay .medal-circle {
      background:radial-gradient(circle at 30% 30%, #ffedd5, #f97316, #7c2d12);
      border-color:#f97316;
      color:#7c2d12;
    }

    #rainbowOverlayL3 .medal-circle {
      background:radial-gradient(circle at 30% 30%, #fef9c3, #eab308, #92400e);
      border-color:#eab308;
      color:#92400e;
    }

    #rainbowOverlayL4 .medal-circle {
      background:radial-gradient(circle at 30% 30%, #dcfce7, #22c55e, #14532d);
      border-color:#22c55e;
      color:#14532d;
    }

    #finalOverlayL1 .medal-circle,
    #finalOverlayL2 .medal-circle,
    #finalOverlayL3 .medal-circle {
      width:180px;
      height:180px;
    }

    #finalOverlayL1 .medal-circle {
      background:radial-gradient(circle at 30% 30%, #fecaca, #ef4444, #7f1d1d);
      border-color:#ef4444;
      color:#7f1d1d;
    }
    #finalOverlayL2 .medal-circle {
      background:radial-gradient(circle at 30% 30%, #ffedd5, #f97316, #7c2d12);
      border-color:#f97316;
      color:#7c2d12;
    }
    #finalOverlayL3 .medal-circle {
      background:radial-gradient(circle at 30% 30%, #fef9c3, #eab308, #92400e);
      border-color:#eab308;
      color:#92400e;
    }

    .rainbow-message-main {
      font-size:1.4rem;
      font-weight:700;
      margin-bottom: 20px;
    }
    .rainbow-message-sub {
      font-size:1rem;
      opacity:0.0.9;
    }


    .home-level-trophy {
      font-size: 1.3rem;
      padding: 16px 20px;
    }

    /* Griglia scrigni (6x6) nella pagina trofei */
    .chest-grid-container {
      margin-top: 16px;
      margin-bottom: 20px;
    }

    .chest-grid {
      display: grid;
      grid-template-columns: repeat(6, minmax(0, 1fr));
      gap: 8px;
      justify-items: stretch;
      margin-left: 20px;
  margin-right: 20px;
}

    .chest-btn {
      border-radius: 12px;
      padding: 8px 6px;
      font-size: 0.8rem;
      font-weight: 700;
      border: none;
      cursor: pointer;
      box-shadow: 0 3px 8px rgba(15,23,42,0.25);
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      min-height: 80px;
      line-height: 1.1;
    }

    .chest-btn-filled {
      background: linear-gradient(to bottom, #facc15, #eab308);
      color: #78350f;
    }

    .chest-btn-filled:hover {
      filter: brightness(1.05);
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(180,83,9,0.45);
    }

    .chest-btn-filled:active {
      transform: translateY(1px);
      box-shadow: 0 2px 6px rgba(180,83,9,0.6);
    }

    .chest-btn-empty {
      background: #f3f4f6;
      color: #9ca3af;
      box-shadow: none;
      cursor: default;
    }

    .clear-chests-btn {
      margin-top: 12px;
      margin-bottom: 20px;
      padding: 10px 18px;
      border-radius: 999px;
      border: none;
      font-weight: 800;
      font-size: 1rem;
      color: #f9fafb;
      background: #ef4444;
      box-shadow: 0 4px 10px rgba(127,29,29,0.4);
      cursor: pointer;
      transition: 0.15s;
    }

    .clear-chests-btn:hover {
      filter: brightness(1.05);
      transform: translateY(-1px);
    }

    .clear-chests-btn:active {
      transform: translateY(1px);
      box-shadow: 0 2px 6px rgba(127,29,29,0.5);
    }


    /* ===========================
       PAGINA TROFEI
       =========================== */
    #trophyPage .app { padding-bottom:40px; margin: 20px; padding:0; width: calc(100% - 40px); height: calc(100% - 40px); background: transparent; border-radius:12px; position:relative; z-index:1; display:flex; flex-direction:column; }

    .trophy-main {
      text-align: center;
      padding: 16px 8px 8px;
    }

    .trophy-chest {
      border: none;
      border-radius: 24px;
      padding: 18px 24px;
      background: linear-gradient(to bottom, #facc15, #eab308);
      color: #78350f;
      font-weight: 700;
      font-size: 1.1rem;
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      box-shadow: 0 6px 16px rgba(180,83,9,0.45);
      transition: 0.15s;
      min-width: 260px;
    }

    .trophy-chest:hover {
      filter: brightness(1.05);
      transform: translateY(-1px);
    }

    .trophy-chest:active {
      transform: translateY(1px);
      box-shadow: 0 3px 8px rgba(180,83,9,0.6);
    }

    .trophy-chest-emoji {
      font-size: 2.4rem;
    }

    .trophy-chest.opened .trophy-chest-emoji {
      transform: translateY(2px);
    }

    .trophy-content {
      margin-top: 24px;
      text-align: left;
      max-width: 640px;
      margin-left: auto;
      margin-right: auto;
      padding: 16px 18px 8px;
      border-radius: 20px;
      border: 2px solid #e0e3f0;
      background: #f9fafb;
    }

    .trophy-section {
      margin-bottom: 20px;
    }

    .trophy-section h2 {
      font-size: 1.1rem;
      margin: 0 0 6px;
      color: #111827;
    }

    .trophy-medals-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      min-height: 34px;
    }

    .trophy-empty {
      font-size: 0.95rem;
      color: #6b7280;
      font-style: italic;
    }

    .trophy-note {
      margin-top: 8px;
      font-size: 0.85rem;
      color: #6b7280;
      text-align: center;
    }

  
    /* Auto toggle pi√π grande nel Livello 1 */
    #level1Page .auto-toggle {
      font-size: 1.1rem;
      gap: 8px;
    }

    #level1Page .auto-slider {
      width: 60px;
      height: 30px;
    }

    #level1Page .auto-slider::before {
      width: 24px;
      height: 24px;
      top: 3px;
      left: 3px;
    }

    #level1Page .auto-toggle-input:checked + .auto-slider::before {
      transform: translateX(30px);
    }

    /* PATCH: icone per i pulsanti Attiva audio (solo icona, niente testo) */
    #audioResetBtn,
    #resetAudioBtnL1,
    #resetAudioBtnL2,
    #resetAudioBtnL3,
    #resetAudioBtnL4,
    #resetAudioBtnPlay,
#resetAudioBtnLearn {
      position: relative;
      font-size: 0; /* nasconde il testo interno */
    }

    #audioResetBtn::before,
    #resetAudioBtnL1::before,
    #resetAudioBtnL2::before,
    #resetAudioBtnL3::before,
    #resetAudioBtnL4::before,
    #resetAudioBtnPlay,
#resetAudioBtnLearn::before {
      content: "üîä";
      font-size: 1.3rem;
    }

    #resetAudioBtnL1 span,
    #resetAudioBtnL2 span,
    #resetAudioBtnL3 span,
    #resetAudioBtnL4 span,
    #resetAudioBtnPlay,
#resetAudioBtnLearn span {
      display: none;
    }


    /* Stato pulsanti audio: verde ON, grigio OFF */
    .audio-on {
      background-color: #22c55e !important;
    }
    .audio-off {
      background-color: #9ca3af !important;
    }

    /* Rendi visibile il testo interno dei pulsanti audio */
    #audioResetBtn,
    #resetAudioBtnL1,
    #resetAudioBtnL2,
    #resetAudioBtnL3,
    #resetAudioBtnL4,
    #resetAudioBtnPlay,
#resetAudioBtnLearn {
      font-size: 0.9rem;
    }

    #audioResetBtn::before,
    #resetAudioBtnL1::before,
    #resetAudioBtnL2::before,
    #resetAudioBtnL3::before,
    #resetAudioBtnL4::before,
    #resetAudioBtnPlay,
#resetAudioBtnLearn::before {
      margin-right: 0.35rem;
    }


    /* OVERRIDE 2025-11: layout dei pulsanti audio
       - Home: icona + testo in grassetto
       - Livelli/Play: solo icona, nessun testo visibile */
    #audioResetBtn {
      font-size: 0.95rem;
      font-weight: 700;
      position: relative;
    }

    #audioResetBtn::before {
      content: "üîä";
      font-size: 1.3rem;
      margin-right: 0.35rem;
    }

    #resetAudioBtnL1,
    #resetAudioBtnL2,
    #resetAudioBtnL3,
    #resetAudioBtnL4,
    #resetAudioBtnPlay,
#resetAudioBtnLearn {
      position: relative;
      font-size: 0; /* nasconde il testo interno */
    }

    #resetAudioBtnL1::before,
    #resetAudioBtnL2::before,
    #resetAudioBtnL3::before,
    #resetAudioBtnL4::before,
    #resetAudioBtnPlay,
#resetAudioBtnLearn::before {
      content: "üîä";
      font-size: 1.3rem;
    }



    /* Icona audio anche per Impara Tempo */
    #resetAudioBtnTempo {
      position: relative;
      font-size: 0; /* nasconde il testo interno */
    }
    #resetAudioBtnTempo::before {
      content: "üîä";
      font-size: 1.3rem;
    }
    #resetAudioBtnTempo span {
      display: none;
    }
:root {
  /* fix per 100vh sui mobile browser */
  --vh: 1vh;
  --safe-bottom: env(safe-area-inset-bottom);
  --safe-left: env(safe-area-inset-left);
  --safe-right: env(safe-area-inset-right);
}

/* Override body per fullscreen su iPhone in landscape */
body {
  height: calc(var(--vh) * 100);
  overflow: hidden;
  touch-action: manipulation;
  -webkit-user-select: none;
  user-select: none;
  -webkit-tap-highlight-color: transparent;
  /* padding che rispetta i safe area inset (Dynamic Island, bordi) */
  padding: max(12px, env(safe-area-inset-top))
           max(12px, env(safe-area-inset-right))
           max(12px, env(safe-area-inset-bottom))
           max(12px, env(safe-area-inset-left));
}

/* Overlay mostrato solo in portrait */
#rotateOverlay {
  position: fixed;
  inset: 0;
  display: none;
  align-items: center;
  justify-content: center;
  background: #46d1c6;
  color: #0f172a;
  text-align: center;
  padding: 32px;
  z-index: 20000;
  font-family: "Baloo 2", sans-serif;
}

#rotateOverlay h1 {
  font-size: 2rem;
  margin-bottom: 20px;
}

#rotateOverlay p {
  font-size: 1.1rem;
  margin: 0;
}

/* In portrait: mostra il messaggio e blocca l'app sotto */
@media (orientation: portrait) {
  #rotateOverlay {
    display: flex;
  }
}

/* Ottimizzazioni per landscape "basso" (es. iPhone 16 Pro Max: 956√ó440) */
@media (orientation: landscape) and (max-height: 480px) {
  


.top-panel {
  /* Niente pill/glass: tutto appoggiato sulla base acquamarina */
  border-radius: 0;
  padding: 6px 14px 0;
  background: transparent;
  border: none;
  box-shadow: none;
  backdrop-filter: none;
  -webkit-backdrop-filter: none;
}
.staff-container {
  padding: 6px;
  margin-top: 4px;
  margin-bottom: 20px;
  margin-left: 20px;
  margin-right: 20px;

  /* STAFF WHITE BACKPLATE */
  background: #ffffff;
  border: none;
  box-shadow: 0 10px 22px rgba(15,23,42,0.25);
  border-radius: 18px;
  overflow: visible;
}
svg.staff {
    max-height: 160px;
  }

  .keyboard-container {
  margin: 0;
  width: 100%;
  flex: 0 0 auto;
  margin-top: auto;

  /* Pi√π spazio sopra la Home Bar (iPhone) cos√¨ i tasti restano cliccabili */
  padding-bottom: calc(44px + env(safe-area-inset-bottom));
  margin-bottom: 0;
}

  .piano {
  width: 100%;
  margin: 0;
  background: transparent;
  padding: 14px 16px 18px;
  border-radius: 18px;
  box-shadow: none;
}

  /* altezza piano gestita via JS */

  .trophy-main {
    padding: 10px 8px 4px;
  }

  .trophy-chest {
    padding: 14px 18px;
    font-size: 1rem;
  }

  .note-buttons-container {
    
  
  
  
  
  
  margin-left: 20px;
  margin-right: 20px;
  
  margin-top: 20px;}

  .note-buttons-wrapper {
    padding: 10px 6px 12px;
    gap: 8px;
  
  
  
  
  }

  .home-container {
    padding: 20px 16px 24px;
  }
}


    /* ===============================
       PATCH iOS ‚Äî Miglioramento note
       LIVELLO 4 (Music Rainbow)
       =============================== */

    /* Stroke non deformati quando lo SVG viene scalato su Safari iOS */
    #level4Page .note-head,
    #level4Page .note-stem,
    #level4Page .note-flag,
    #level4Page .ledger-line {
      vector-effect: non-scaling-stroke;
    }

    /* Spessori aumentati solo nel livello 4 per maggiore leggibilit√† */
    #level4Page .note-head {
      stroke-width: 2.6;
    }

    #level4Page .note-stem,
    #level4Page .note-flag,
    #level4Page .ledger-line {
      stroke-width: 3;
    }

    /* In landscape basso su iPhone permette una migliore dimensione delle note */
    @media (orientation: landscape) and (max-height: 480px) {
      #level4Page svg.staff {
        max-height: 190px !important;
      }
    }

/* Nasconde completamente la pillola degli errori in tutti i livelli */
.error-pill,
.stat-errors-normal,
.stat-errors-high {
  display: none !important;
}


  /* Colori dei pallini nella Mappa delle note (coerenti con i bottoni DO‚ÄìSI) */
  .learn-do  { fill:#ef4444; }
  .learn-re  { fill:#f97316; }
  .learn-mi  { fill:#eab308; }
  .learn-fa  { fill:#22c55e; }
  .learn-sol { fill:#38bdf8; }
  .learn-la  { fill:#a855f7; }
  .learn-si  { fill:#4f46e5; }


  
  
  .learn-do.learn-highlight  { filter: drop-shadow(0 0 8px #ef4444); }
  .learn-re.learn-highlight  { filter: drop-shadow(0 0 8px #f97316); }
  .learn-mi.learn-highlight  { filter: drop-shadow(0 0 8px #eab308); }
  .learn-fa.learn-highlight  { filter: drop-shadow(0 0 8px #22c55e); }
  .learn-sol.learn-highlight { filter: drop-shadow(0 0 8px #38bdf8); }
  .learn-la.learn-highlight  { filter: drop-shadow(0 0 8px #a855f7); }
  .learn-si.learn-highlight  { filter: drop-shadow(0 0 8px #4f46e5); }

  .learn-note circle {
  stroke: #111827;          /* bordo nero */
  stroke-width: 2.4;
  fill-opacity: 0.96;
  filter: drop-shadow(0 6px 14px rgba(15,23,42,0.45));
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  transition: transform 0.18s ease,
              stroke-width 0.18s ease,
              opacity 0.18s ease,
              filter 0.18s ease;
}
  .learn-note circle {
  stroke: #111827;          /* bordo nero */
  stroke-width: 2.4;
  fill-opacity: 0.96;
  filter: drop-shadow(0 6px 14px rgba(15,23,42,0.45));
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  transition: transform 0.18s ease,
              stroke-width 0.18s ease,
              opacity 0.18s ease,
              filter 0.18s ease;
}

  .learn-note circle.learn-highlight {
    stroke: #ffffff;
    stroke-width: 2.8;
    
    filter:
      drop-shadow(0 0 3px  #ef4444)
      drop-shadow(0 0 6px  #f97316)
      drop-shadow(0 0 9px  #eab308)
      drop-shadow(0 0 12px #22c55e)
      drop-shadow(0 0 15px #38bdf8)
      drop-shadow(0 0 18px #a855f7)
      drop-shadow(0 0 21px #4f46e5);
  }

.learn-note circle.learn-highlight { transform-origin:center center; }

#homeLearnNotesBtn { background: #4f46e5 !important; color:white !important; }
#homeLearnTempoBtn { background: #0ea5e9 !important; color:white !important; }

/* Override for MAPPA: remove frame around pentagram */
#learnNotesPage 
.staff-container {
  padding: 6px;
  margin-top: 4px;
  margin-bottom: 20px;
  margin-left: 20px;
  margin-right: 20px;

  /* STAFF WHITE BACKPLATE */
  background: #ffffff;
  border: none;
  box-shadow: 0 10px 22px rgba(15,23,42,0.25);
  border-radius: 18px;
  overflow: visible;
}
@keyframes notePulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.15); }
  100% { transform: scale(1); }
}


@keyframes innerPulseL1 {
  0%   { box-shadow: inset 0 0 0px rgba(255,255,255,0.05); }
  100% { box-shadow: inset 0 0 3px rgba(255,255,255,0.05); }
}
  100% { box-shadow: inset 0 0 5px rgba(255,255,255,0.05); }
}


@keyframes neonKeyPulseL1 {
  0%, 100% {
    box-shadow:
      0 0 4px rgba(255,255,255,0.75),
      0 0 10px currentColor,
      0 0 18px currentColor;
  }
  50% {
    box-shadow:
      0 0 6px rgba(255,255,255,0.95),
      0 0 16px currentColor,
      0 0 30px currentColor;
  }
}
  50% {
    box-shadow: 0 0 52px currentColor, 0 0 92px currentColor;
  }
}
  50% {
    box-shadow: 0 0 26px currentColor, 0 0 46px currentColor;
  }
}


/* GLOBAL APP BACKGROUND ACQUAMARINA */
body {
  background: radial-gradient(circle at center,
    #88f7e2 0%,
    #5cdccb 40%,
    #36b5aa 75%,
    #1c8f82 100%);
  background-attachment: fixed;
}


/* HOME BACKGROUND ACQUAMARINA */
#homePage {
  background: radial-gradient(circle at center,
    #88f7e2 0%, #5cdccb 40%, #36b5aa 75%, #1c8f82 100%) !important;
}

 .learn-popup button {text-align:center;} </style>

<style>
/* Raddoppio altezza tasti Livello 1 e Mappa */
#level1Page .note-button,
#learnNotesPage .note-button {
    padding-top: 24px !important;
    padding-bottom: 24px !important;
}
 .learn-popup button {text-align:center;} </style>


<style>
/* Effetto titolo (neon + animazione) per i tasti DO‚ÄìSI
   nel Livello 1 e nella Mappa delle note */
#level1Page .note-button,
#learnNotesPage .note-button {
  position: relative;
}

/* DO */
#level1Page .btn-do,
#learnNotesPage .btn-do {
  text-shadow:
    0 0 4px rgba(255,255,255,0.75),
    0 0 10px #ef4444,
    0 0 18px #ef4444;
  box-shadow:
    0 0 6px rgba(255,255,255,0.8),
    0 0 16px #ef4444,
    0 0 30px #ef4444,
    inset 0 0 10px rgba(255,255,255,0.65);
  animation: neonTitlePulse 1.8s ease-in-out infinite;
}

/* RE */
#level1Page .btn-re,
#learnNotesPage .btn-re {
  text-shadow:
    0 0 4px rgba(255,255,255,0.75),
    0 0 10px #f97316,
    0 0 18px #f97316;
  box-shadow:
    0 0 6px rgba(255,255,255,0.8),
    0 0 16px #f97316,
    0 0 30px #f97316,
    inset 0 0 10px rgba(255,255,255,0.65);
  animation: neonTitlePulse 1.8s ease-in-out infinite;
}

/* MI */
#level1Page .btn-mi,
#learnNotesPage .btn-mi {
  text-shadow:
    0 0 4px rgba(255,255,255,0.75),
    0 0 10px #eab308,
    0 0 18px #eab308;
  box-shadow:
    0 0 6px rgba(255,255,255,0.8),
    0 0 16px #eab308,
    0 0 30px #eab308,
    inset 0 0 10px rgba(255,255,255,0.65);
  animation: neonTitlePulse 1.8s ease-in-out infinite;
}

/* FA */
#level1Page .btn-fa,
#learnNotesPage .btn-fa {
  text-shadow:
    0 0 4px rgba(255,255,255,0.75),
    0 0 10px #22c55e,
    0 0 18px #22c55e;
  box-shadow:
    0 0 6px rgba(255,255,255,0.8),
    0 0 16px #22c55e,
    0 0 30px #22c55e,
    inset 0 0 10px rgba(255,255,255,0.65);
  animation: neonTitlePulse 1.8s ease-in-out infinite;
}

/* SOL */
#level1Page .btn-sol,
#learnNotesPage .btn-sol {
  text-shadow:
    0 0 4px rgba(255,255,255,0.75),
    0 0 10px #38bdf8,
    0 0 18px #38bdf8;
  box-shadow:
    0 0 6px rgba(255,255,255,0.8),
    0 0 16px #38bdf8,
    0 0 30px #38bdf8,
    inset 0 0 10px rgba(255,255,255,0.65);
  animation: neonTitlePulse 1.8s ease-in-out infinite;
}

/* LA */
#level1Page .btn-la,
#learnNotesPage .btn-la {
  text-shadow:
    0 0 4px rgba(255,255,255,0.75),
    0 0 10px #a855f7,
    0 0 18px #a855f7;
  box-shadow:
    0 0 6px rgba(255,255,255,0.8),
    0 0 16px #a855f7,
    0 0 30px #a855f7,
    inset 0 0 10px rgba(255,255,255,0.65);
  animation: neonTitlePulse 1.8s ease-in-out infinite;
}

/* SI */
#level1Page .btn-si,
#learnNotesPage .btn-si {
  text-shadow:
    0 0 4px rgba(255,255,255,0.75),
    0 0 10px #4f46e5,
    0 0 18px #4f46e5;
  box-shadow:
    0 0 6px rgba(255,255,255,0.8),
    0 0 16px #4f46e5,
    0 0 30px #4f46e5,
    inset 0 0 10px rgba(255,255,255,0.65);
  animation: neonTitlePulse 1.8s ease-in-out infinite;
}
 .learn-popup button {text-align:center;} </style>


<style>
/* Abbassa icone e titolo del top panel di 5px (esclusa bacheca medaglie) */
.top-left-controls,
.top-row h1 {
  margin-top: 5px !important;
}
 .learn-popup button {text-align:center;} </style>




<style>
/* Forza il titolo a stare su un‚Äôunica riga */
.rainbow-title {
  white-space: nowrap !important;
  display: inline-block !important;
}
 .learn-popup button {text-align:center;} </style>




<style>
/* Build p1.067 ‚Äì rimozione barra medaglie in tutti i livelli */
#level1Page .medals-panel-container,
#level2Page .medals-panel-container,
#level3Page .medals-panel-container,
#level4Page .medals-panel-container {
    display: none !important;
}
</style>


<style>
/* Build p1.018 ‚Äì rimuove la top panel ma lascia le icone */
.top-panel {
  background: none !important;
  border: none !important;
  box-shadow: none !important;
  padding: 0 !important;
  margin: 0 !important;
}
.top-row {
  margin: 0 !important;
}
</style>


<style>
/* Build p1.018 ‚Äì rimozione titoli in Learn e Play */

</style>


<style>
}
</style>


<style>
/* Build p1.018 ‚Äì nasconde solo la barra medaglie in Impara Tempo */
}
</style>


<style>
/* Build p1.018 ‚Äì Home in landscape: titolo+arcobaleno a sinistra, tasti a destra */
@media (orientation: landscape) {
  .home-screen {
    flex-direction: row;
    align-items: center;
    justify-content: center;
  }

  .home-container {
    display: grid;
    grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr);
    column-gap: 24px;
    max-width: 1000px;
    text-align: left;
  }

  /* Colonna sinistra: arcobaleno + titolo + sottotitolo */
  .home-rainbow-graphic,
  .home-screen .rainbow-title,
  .home-subtitle {
    grid-column: 1;
  }

  /* Colonna destra: selezione giocatore + tasti */
  .home-gender-select,
  .home-player-box,
  .home-levels,
  .home-audio-reset {
    grid-column: 2;
  }
}
</style>


<style>
/* Build override: nasconde tutte le linee di taglio (ledger-line) ovunque */
.ledger-line {
  display: none !important;
}
</style>


<style>
/* Titolo arcobaleno nei livelli 1‚Äì4, centrato e alto quanto le icone */
#level1Page .top-row .rainbow-title-level,
#level2Page .top-row .rainbow-title-level,
#level3Page .top-row .rainbow-title-level,
#level4Page .top-row .rainbow-title-level {
  font-size: 1.9rem;
  line-height: 1;
  margin: 0;
}
</style>

<style>
/* Titolo arcobaleno nelle pagine Impara: leggermente pi√π piccolo ma allineato alle icone */
#learnNotesPage .top-row .rainbow-title-level,
#learnTempoPage .top-row .rainbow-title-level {
  font-size: 1.9rem;
  line-height: 1;
  margin: 0;
}
</style>


<style>
/* Sposta di 100px a destra il titolo nella Mappa delle Note */
#learnNotesPage .top-row .rainbow-title-level {
  transform: translateX(200px);
}
</style>


<style>
#learnTempoPage .medals-panel-container{
 display:none !important;
}
</style>


<style>

</style>


<style>
/* Bigger, brighter, bouncing icons for Impara popup */


@keyframes bounceIcon {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}
</style>


<style>
#learnSelectOverlay .level-select-btn .home-level-btn-label {
  margin-left: 40px !important;
  font-size: 3.4rem !important;
  filter: brightness(1.4);
  animation: bounceIcon 1.2s infinite ease-in-out;
}

/* ===========================
   RESPONSIVE CLEANUP (Build 2.021)
   - full background coverage (iPad)
   - centered layout on large screens
   - safe-area spacing (iPhone swipe)
   =========================== */

html {
  height: 100%;
  min-height: 100%;
  /* Keep the aquamarine background even if body height is shorter */
  background: linear-gradient(
      135deg,
      rgba(70, 209, 198, 0.45),
      rgba(70, 209, 198, 0.30),
      rgba(255, 255, 255, 0.25)
  );
}

body {
  min-height: 100svh;
  min-height: 100dvh;
  height: auto;
  background: transparent;
}

/* Ensure every page fills the viewport */
.page-container,
.home-screen {
  height: 100%;
  min-height: 100%;
}

/* Center core blocks on tablets/large screens */
.top-panel,
.staff-container,
.keyboard-container {
  width: min(100%, 1400px);
  margin-left: auto;
  margin-right: auto;
}

/* Give the keyboard a safer bottom spacing (avoid iOS swipe area) */
.keyboard-container {
  padding-bottom: calc(18px + env(safe-area-inset-bottom, 0px));
  margin-bottom: calc(10px + env(safe-area-inset-bottom, 0px));
}

/* Make the piano breathe less on small screens so keys can grow */
@media (orientation: landscape) and (max-height: 480px) {
  .app {
    padding-left: 8px;
    padding-right: 8px;
    padding-bottom: calc(18px + env(safe-area-inset-bottom, 0px));
  }

  .top-panel {
    margin-bottom: 10px;
  }

  .staff-container {
    padding: 4px;
  }

  .keyboard-container {
    margin-bottom: calc(10px + env(safe-area-inset-bottom, 0px));
    padding: 4px 0 calc(18px + env(safe-area-inset-bottom, 0px));
  }

  .piano {
    padding: 10px 10px 12px;
  }
}

</style>


<style>
/* PATCH Build 2.021 ‚Äî UI allineamenti */
.top-row { grid-template-columns: 1fr auto 1fr !important; }
.top-left-controls { justify-self: start !important; }
.top-right-controls { justify-self: end !important; }

/* Titolo sempre centrato (no offset hack) */
#learnNotesPage .top-row .rainbow-title-level { transform: none !important; }

/* MAPPA NOTE: pentagramma appoggiato sullo sfondo (niente pannello bianco) */
#learnNotesPage .staff-container {
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
  padding: 0 !important;
}
</style>

</head>

<body>
  <div id="rotateOverlay">
    <div>
      <h1>Ruota il tuo iPhone</h1>
      <p>Music Rainbow funziona solo in orizzontale (landscape).</p>
    </div>
  </div>


<!-- ===========================
     HOME
     =========================== -->

<div id="homeScreen" class="home-screen">
  <div class="home-container">
    <div class="home-left">
<div class="home-rainbow-graphic">
      
      <svg viewBox="0 0 300 180" aria-hidden="true">
        <defs>
          <!-- Effetto Liquid Glass per l'arcobaleno -->
          <filter id="liquidGlassRainbow" x="-20%" y="-20%" width="140%" height="140%">
            <!-- Alone morbido -->
            <feGaussianBlur in="SourceGraphic" stdDeviation="3" result="blur"/>
            <!-- Aumenta leggermente la luminosit√† -->
            <feColorMatrix in="blur" type="matrix"
              values="1 0 0 0 0
                      0 1 0 0 0
                      0 0 1 0 0
                      0 0 0 1.2 0"
              result="bright"/>
            <!-- Unisce alone e forma originale -->
            <feMerge>
              <feMergeNode in="bright"/>
              <feMergeNode in="SourceGraphic"/>
            </feMerge>
          </filter>
        </defs>

        <path d="M30 150 Q150 20 270 150"
              stroke="#ef4444" stroke-width="18" fill="none"
              stroke-linecap="round" stroke-opacity="0.9"
              filter="url(#liquidGlassRainbow)"/>
        <path d="M40 150 Q150 30 260 150"
              stroke="#f97316" stroke-width="18" fill="none"
              stroke-linecap="round" stroke-opacity="0.9"
              filter="url(#liquidGlassRainbow)"/>
        <path d="M50 150 Q150 40 250 150"
              stroke="#eab308" stroke-width="18" fill="none"
              stroke-linecap="round" stroke-opacity="0.9"
              filter="url(#liquidGlassRainbow)"/>
        <path d="M60 150 Q150 50 240 150"
              stroke="#22c55e" stroke-width="18" fill="none"
              stroke-linecap="round" stroke-opacity="0.9"
              filter="url(#liquidGlassRainbow)"/>
        <path d="M70 150 Q150 60 230 150"
              stroke="#38bdf8" stroke-width="18" fill="none"
              stroke-linecap="round" stroke-opacity="0.9"
              filter="url(#liquidGlassRainbow)"/>
        <path d="M80 150 Q150 70 220 150"
              stroke="#a855f7" stroke-width="18" fill="none"
              stroke-linecap="round" stroke-opacity="0.9"
              filter="url(#liquidGlassRainbow)"/>
        <path d="M90 150 Q150 80 210 150"
              stroke="#4f46e5" stroke-width="18" fill="none"
              stroke-linecap="round" stroke-opacity="0.9"
              filter="url(#liquidGlassRainbow)"/>
      </svg>

    </div>
      <h1 class="rainbow-title"><span>M</span><span>u</span><span>s</span><span>i</span><span>c</span><span>&nbsp;</span><span>R</span><span>a</span><span>i</span><span>n</span><span>b</span><span>o</span><span>w</span></h1>
      <div class="home-gender-wrapper">
<div class="home-gender-select">
        <label class="home-gender-option">
          <input type="radio" name="gender" value="M" checked />
          <span>Maschio</span>
        </label>
        <label class="home-gender-option">
          <input type="radio" name="gender" value="F" />
          <span>Femmina</span>
        </label>
      </div>
      </div>
      <div class="home-version-label">Build 2.021</div>
    </div>
    <div class="home-right">
<div class="home-levels">
      <button id="btnOpenLevelSelect" class="home-level-btn home-level-main" type="button">
        Scegli il livello
      </button>

      <div class="home-levels-separator"></div>

      <button id="homePlayBtn" class="home-level-btn home-level-play home-play-disabled" type="button" disabled>
        Modalit√† Play
      </button>
      <button id="homeLearnMainBtn" class="home-level-btn home-level-learn" type="button">
        Impara
      </button>
      <button id="homeTrophyBtn" class="home-level-btn home-level-trophy" type="button">
        Scrigno dei trofei
      </button>
    </div>

    </div>
  </div>
</div>

<div id="levelSelectOverlay" class="level-select-overlay">
  <div class="level-select-box">
    <h2 class="level-select-title">Scegli il livello</h2>
    <p class="level-select-subtitle">Puoi cambiare livello in qualsiasi momento.</p>
    <div class="level-select-grid">
      <button type="button" class="level-select-btn" data-level="level1Page">
        1
      </button>
      <button type="button" class="level-select-btn" data-level="level2Page">
        2
      </button>
      <button type="button" class="level-select-btn" data-level="level3Page">
        3
      </button>
      <button type="button" class="level-select-btn" data-level="level4Page">
        4
      </button>
    </div>
    <div class="level-select-actions">
      <button type="button" id="btnLevelSelectClose" class="level-select-close">
        Chiudi
      </button>
    </div>
  </div>
</div>


<div id="learnSelectOverlay" class="level-select-overlay">
  <div class="level-select-box">
    <h2 class="level-select-title">Impara</h2>
    <p class="level-select-subtitle">Scegli cosa vuoi allenare.</p>
    <div class="level-select-grid">
      <button type="button" id="homeLearnNotesBtn" class="level-select-btn">
        <span class="home-level-btn-label" aria-label="Impara le note">üéµ</span>
      </button>
      <button type="button" id="homeLearnTempoBtn" class="level-select-btn">
        <span class="home-level-btn-label" aria-label="Impara il tempo">‚è±Ô∏è</span>
      </button>
    </div>
    <div class="level-select-actions">
      <button type="button" id="learnSelectClose" class="level-select-close">
        Chiudi
      </button>
    </div>
  </div>
</div>

<!-- ===========================
     POPUP PREMI NORMALI
     =========================== -->
<div class="rainbow-overlay" id="rainbowOverlayL1">
  <div class="rainbow-box">
    <div class="rainbow-graphic">
      <svg viewBox="0 0 300 180">
        <path d="M30 150 Q150 20 270 150" stroke="#ef4444" stroke-width="18" fill="none" stroke-linecap="round"/>
        <path d="M40 150 Q150 30 260 150" stroke="#f97316" stroke-width="18" fill="none" stroke-linecap="round"/>
        <path d="M50 150 Q150 40 250 150" stroke="#eab308" stroke-width="18" fill="none" stroke-linecap="round"/>
        <path d="M60 150 Q150 50 240 150" stroke="#22c55e" stroke-width="18" fill="none" stroke-linecap="round"/>
        <path d="M70 150 Q150 60 230 150" stroke="#38bdf8" stroke-width="18" fill="none" stroke-linecap="round"/>
        <path d="M80 150 Q150 70 220 150" stroke="#a855f7" stroke-width="18" fill="none" stroke-linecap="round"/>
        <path d="M90 150 Q150 80 210 150" stroke="#4f46e5" stroke-width="18" fill="none" stroke-linecap="round"/>
      </svg>

      <div class="medal-in-arc">
        <div class="medal-circle">
          <span id="rainbowWinIndexL1">1</span>
        </div>
      </div>
    </div>

    <div id="rainbowOverlayL1Main" class="rainbow-message-main">Che bravura!</div>
    <div id="rainbowOverlayL1Sub" class="rainbow-message-sub">Hai colorato tutte le note. Ora ascolta la tua melodia.</div>
  </div>
</div>

<div class="rainbow-overlay" id="rainbowOverlay">
  <div class="rainbow-box">
    <div class="rainbow-graphic">
      <svg viewBox="0 0 300 180">
        <path d="M30 150 Q150 20 270 150" stroke="#ef4444" stroke-width="18" fill="none" stroke-linecap="round"/>
        <path d="M40 150 Q150 30 260 150" stroke="#f97316" stroke-width="18" fill="none" stroke-linecap="round"/>
        <path d="M50 150 Q150 40 250 150" stroke="#eab308" stroke-width="18" fill="none" stroke-linecap="round"/>
        <path d="M60 150 Q150 50 240 150" stroke="#22c55e" stroke-width="18" fill="none" stroke-linecap="round"/>
        <path d="M70 150 Q150 60 230 150" stroke="#38bdf8" stroke-width="18" fill="none" stroke-linecap="round"/>
        <path d="M80 150 Q150 70 220 150" stroke="#a855f7" stroke-width="18" fill="none" stroke-linecap="round"/>
        <path d="M90 150 Q150 80 210 150" stroke="#4f46e5" stroke-width="18" fill="none" stroke-linecap="round"/>
      </svg>

      <div class="medal-in-arc">
        <div class="medal-circle">
          <span id="rainbowWinIndex">1</span>
        </div>
      </div>
    </div>

    <div id="rainbowOverlayL2Main" class="rainbow-message-main">Grande musica!</div>
    <div id="rainbowOverlayL2Sub" class="rainbow-message-sub">Hai indovinato tutte le note. Ora ascolta la melodia.</div>
  </div>
</div>

<div class="rainbow-overlay" id="rainbowOverlayL3">
  <div class="rainbow-box">
    <div class="rainbow-graphic">
      <svg viewBox="0 0 300 180">
        <path d="M30 150 Q150 20 270 150" stroke="#ef4444" stroke-width="18" fill="none" stroke-linecap="round"/>
        <path d="M40 150 Q150 30 260 150" stroke="#f97316" stroke-width="18" fill="none" stroke-linecap="round"/>
        <path d="M50 150 Q150 40 250 150" stroke="#eab308" stroke-width="18" fill="none" stroke-linecap="round"/>
        <path d="M60 150 Q150 50 240 150" stroke="#22c55e" stroke-width="18" fill="none" stroke-linecap="round"/>
        <path d="M70 150 Q150 60 230 150" stroke="#38bdf8" stroke-width="18" fill="none" stroke-linecap="round"/>
        <path d="M80 150 Q150 70 220 150" stroke="#a855f7" stroke-width="18" fill="none" stroke-linecap="round"/>
        <path d="M90 150 Q150 80 210 150" stroke="#4f46e5" stroke-width="18" fill="none" stroke-linecap="round"/>
      </svg>

      <div class="medal-in-arc">
        <div class="medal-circle">
          <span id="rainbowWinIndexL3">1</span>
        </div>
      </div>
    </div>

    <div id="rainbowOverlayL3Main" class="rainbow-message-main">Che orecchio musicale!</div>
    <div id="rainbowOverlayL3Sub" class="rainbow-message-sub">Hai riconosciuto tutte le note. Ora ascolta la melodia.</div>
  </div>
</div>


<div class="rainbow-overlay" id="rainbowOverlayL4">
  <div class="rainbow-box">
    <div class="rainbow-graphic">
      <svg viewBox="0 0 300 180">
        <path d="M30 150 Q150 20 270 150" stroke="#ef4444" stroke-width="18" fill="none" stroke-linecap="round"/>
        <path d="M40 150 Q150 30 260 150" stroke="#f97316" stroke-width="18" fill="none" stroke-linecap="round"/>
        <path d="M50 150 Q150 40 250 150" stroke="#eab308" stroke-width="18" fill="none" stroke-linecap="round"/>
        <path d="M60 150 Q150 50 240 150" stroke="#22c55e" stroke-width="18" fill="none" stroke-linecap="round"/>
        <path d="M70 150 Q150 60 230 150" stroke="#38bdf8" stroke-width="18" fill="none" stroke-linecap="round"/>
        <path d="M80 150 Q150 70 220 150" stroke="#a855f7" stroke-width="18" fill="none" stroke-linecap="round"/>
        <path d="M90 150 Q150 80 210 150" stroke="#4f46e5" stroke-width="18" fill="none" stroke-linecap="round"/>
      </svg>

      <div class="medal-in-arc">
        <div class="medal-circle">
          <span id="rainbowWinIndexL4">1</span>
        </div>
      </div>
    </div>

    <div id="rainbowOverlayL4Main" class="rainbow-message-main">Che ritmo perfetto!</div>
    <div id="rainbowOverlayL4Sub" class="rainbow-message-sub">Hai suonato tutto a tempo. Ora ascolta la melodia.</div>
  </div>
</div>

<!-- ===========================
     POPUP FINALI (10 MEDAGLIE)
     =========================== -->
<div class="rainbow-overlay" id="finalOverlayL1">
  <div class="rainbow-box">
    <div class="rainbow-graphic">
      <svg viewBox="0 0 300 180">
        <path d="M30 150 Q150 20 270 150" stroke="#ef4444" stroke-width="18" fill="none" stroke-linecap="round"/>
        <path d="M40 150 Q150 30 260 150" stroke="#f97316" stroke-width="18" fill="none" stroke-linecap="round"/>
        <path d="M50 150 Q150 40 250 150" stroke="#eab308" stroke-width="18" fill="none" stroke-linecap="round"/>
        <path d="M60 150 Q150 50 240 150" stroke="#22c55e" stroke-width="18" fill="none" stroke-linecap="round"/>
        <path d="M70 150 Q150 60 230 150" stroke="#38bdf8" stroke-width="18" fill="none" stroke-linecap="round"/>
        <path d="M80 150 Q150 70 220 150" stroke="#a855f7" stroke-width="18" fill="none" stroke-linecap="round"/>
        <path d="M90 150 Q150 80 210 150" stroke="#4f46e5" stroke-width="18" fill="none" stroke-linecap="round"/>
      </svg>

      <div class="medal-in-arc">
        <div class="medal-circle">
          <span>10</span>
        </div>
      </div>
    </div>

    <div id="finalOverlayL1Main" class="rainbow-message-main">Livello 1 completato!</div>
    <div id="finalOverlayL1Sub" class="rainbow-message-sub">
      Hai vinto 10 medaglie di rame. Ora passi al secondo livello!
    </div>
  </div>
</div>

<div class="rainbow-overlay" id="finalOverlayL2">
  <div class="rainbow-box">
    <div class="rainbow-graphic">
      <svg viewBox="0 0 300 180">
        <path d="M30 150 Q150 20 270 150" stroke="#ef4444" stroke-width="18" fill="none" stroke-linecap="round"/>
        <path d="M40 150 Q150 30 260 150" stroke="#f97316" stroke-width="18" fill="none" stroke-linecap="round"/>
        <path d="M50 150 Q150 40 250 150" stroke="#eab308" stroke-width="18" fill="none" stroke-linecap="round"/>
        <path d="M60 150 Q150 50 240 150" stroke="#22c55e" stroke-width="18" fill="none" stroke-linecap="round"/>
        <path d="M70 150 Q150 60 230 150" stroke="#38bdf8" stroke-width="18" fill="none" stroke-linecap="round"/>
        <path d="M80 150 Q150 70 220 150" stroke="#a855f7" stroke-width="18" fill="none" stroke-linecap="round"/>
        <path d="M90 150 Q150 80 210 150" stroke="#4f46e5" stroke-width="18" fill="none" stroke-linecap="round"/>
      </svg>

      <div class="medal-in-arc">
        <div class="medal-circle">
          <span>10</span>
        </div>
      </div>
    </div>

    <div id="finalOverlayL2Main" class="rainbow-message-main">Livello 2 completato!</div>
    <div id="finalOverlayL2Sub" class="rainbow-message-sub">
      Hai vinto 10 medaglie d‚Äôargento. Ora passi al terzo livello!
    </div>
  </div>
</div>

<div class="rainbow-overlay" id="finalOverlayL3">
  <div class="rainbow-box">
    <div class="rainbow-graphic">
      <svg viewBox="0 0 300 180">
        <path d="M30 150 Q150 20 270 150" stroke="#ef4444" stroke-width="18" fill="none" stroke-linecap="round"/>
        <path d="M40 150 Q150 30 260 150" stroke="#f97316" stroke-width="18" fill="none" stroke-linecap="round"/>
        <path d="M50 150 Q150 40 250 150" stroke="#eab308" stroke-width="18" fill="none" stroke-linecap="round"/>
        <path d="M60 150 Q150 50 240 150" stroke="#22c55e" stroke-width="18" fill="none" stroke-linecap="round"/>
        <path d="M70 150 Q150 60 230 150" stroke="#38bdf8" stroke-width="18" fill="none" stroke-linecap="round"/>
        <path d="M80 150 Q150 70 220 150" stroke="#a855f7" stroke-width="18" fill="none" stroke-linecap="round"/>
        <path d="M90 150 Q150 80 210 150" stroke="#4f46e5" stroke-width="18" fill="none" stroke-linecap="round"/>
      </svg>

      <div class="medal-in-arc">
        <div class="medal-circle">
          <span>10</span>
        </div>
      </div>
    </div>

    <div id="finalOverlayL3Main" class="rainbow-message-main">Tutti i livelli completati!</div>
    <div id="finalOverlayL3Sub" class="rainbow-message-sub">
      Hai vinto 10 medaglie d‚Äôoro. Puoi continuare a giocare quanto vuoi!
    </div>
  </div>
</div>

<!-- ===========================
     POPUP GETTONI PLAY
     =========================== -->
<div class="token-overlay" id="tokenOverlay">
  <div class="token-box">
    <svg class="token-big-svg" viewBox="0 0 100 100" aria-hidden="true">
      <circle cx="50" cy="50" r="45" fill="#facc15" stroke="#92400e" stroke-width="4"/>
      <circle cx="50" cy="50" r="35" fill="#fde68a" stroke="#fbbf24" stroke-width="3"/>
      <rect x="30" y="27" width="4" height="46" fill="#eab308"/>
      <rect x="47" y="27" width="4" height="46" fill="#eab308"/>
      <rect x="63" y="27" width="4" height="46" fill="#eab308"/>
    </svg>
    <div class="token-message-main">Hai vinto un gettone!</div>
    <div class="token-message-sub">Usalo per attivare 5 minuti di Modalit√† Play.</div>
  </div>
</div>


<!-- ===========================
     MAPPA DELLE NOTE
     =========================== -->
<div id="learnNotesPage" class="page-container" style="display:none">
  <div class="app">
    <div class="top-panel">
      <div class="top-row">
        <div class="top-left-controls">
          <button class="menu-btn" id="menuBtnLearn" aria-label="Menu">üè†</button>
          
        
          <button class="clef-btn clef-treble-btn active-clef" id="clefTrebleBtnLearn" aria-label="Chiave di violino">&#119070;</button>
          <button class="clef-btn clef-bass-btn" id="clefBassBtnLearn" aria-label="Chiave di basso">&#119074;</button>
          </div>
        <h1 class="rainbow-title rainbow-title-level"><span>M</span><span>u</span><span>s</span><span>i</span><span>c</span><span>&nbsp;</span><span>R</span><span>a</span><span>i</span><span>n</span><span>b</span><span>o</span><span>w</span></h1>
        <div class="top-right-controls">
<button class="rainbow-counter" id="resetAudioBtnLearn" type="button">
            Attiva audio
          </button>
</div>
      </div>

          </div>

    <div class="staff-container">
      <svg id="learnStaffSvg" class="staff" overflow="visible" viewBox="0 0 1000 200">
        <defs>
          <linearGradient id="rainbowStroke" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stop-color="#ef4444"/>
            <stop offset="16%" stop-color="#f97316"/>
            <stop offset="32%" stop-color="#eab308"/>
            <stop offset="48%" stop-color="#22c55e"/>
            <stop offset="64%" stop-color="#38bdf8"/>
            <stop offset="80%" stop-color="#a855f7"/>
            <stop offset="100%" stop-color="#4f46e5"/>
          </linearGradient>
          <filter id="rainbowGlow" x="-80%" y="-80%" width="260%" height="260%">
            <feGaussianBlur stdDeviation="3" result="blur"/>
            <feMerge>
              <feMergeNode in="blur"/>
              <feMergeNode in="SourceGraphic"/>
            </feMerge>
          </filter>
        </defs>

        <line x1="20" y1="92.31" x2="980" y2="92.31" stroke="#111827" stroke-width="2"/>
        <line x1="20" y1="107.69" x2="980" y2="107.69" stroke="#111827" stroke-width="2"/>
        <line x1="20" y1="123.08" x2="980" y2="123.08" stroke="#111827" stroke-width="2"/>
        <line x1="20" y1="138.46" x2="980" y2="138.46" stroke="#111827" stroke-width="2"/>
        <line x1="20" y1="153.85" x2="980" y2="153.85" stroke="#111827" stroke-width="2"/>
        
        <!-- Barra iniziale a sinistra -->
        <line x1="20" y1="92.31" x2="20" y2="153.85" stroke="#111827" stroke-width="3"/>

        <!-- Doppia barra finale a destra -->
        <line x1="970" y1="92.31" x2="970" y2="153.85" stroke="#111827" stroke-width="2"/>
        <line x1="980" y1="91.54" x2="980" y2="154.62" stroke="#111827" stroke-width="4"/>
        <g class="clef-group"><text x="40" y="164" font-size="115" class="clef-symbol">&#119070;</text>
        <circle class="bass-dot" cx="95" cy="131" r="4" fill="#111827" />
        <circle class="bass-dot" cx="95" cy="146" r="4" fill="#111827" /></g>
      
        <!-- Riga aggiuntiva per il DO centrale -->
        

        <!-- Note per chiave di SOL: righi e spazi -->
        <g id="learnNotesGroupTreble">
          <!-- RIGHI (dal basso: MI - SOL - SI - RE - FA) -->
          <g class="learn-note">
            <circle cx="150" cy="153.85" r="10" class="note-circle learn-mi"></circle>
            
          </g>
          <g class="learn-note">
            <circle cx="210" cy="138.46" r="10" class="note-circle learn-sol"></circle>
            
          </g>
          <g class="learn-note">
            <circle cx="270" cy="123.08" r="10" class="note-circle learn-si"></circle>
            
          </g>
          <g class="learn-note">
            <circle cx="330" cy="107.69" r="10" class="note-circle learn-re"></circle>
            
          </g>
          <g class="learn-note">
            <circle cx="390" cy="92.31" r="10" class="note-circle learn-fa"></circle>
            
          </g>

          <!-- SPAZI (dal basso: FA - LA - DO - MI) -->
          <g class="learn-note">
            <circle cx="470" cy="146.15" r="10" class="note-circle learn-fa"></circle>
            
          </g>
          <g class="learn-note">
            <circle cx="530" cy="130.77" r="10" class="note-circle learn-la"></circle>
            
          </g>
          <g class="learn-note">
            <circle cx="590" cy="115.38" r="10" class="note-circle learn-do"></circle>
            
          </g>
          <g class="learn-note">
            <circle cx="650" cy="100.00" r="10" class="note-circle learn-mi"></circle>
            
          </g>
        </g>

        <!-- Note per chiave di FA: righi e spazi -->
        <g id="learnNotesGroupBass" style="display:none;">
          <!-- RIGHI (dal basso: SOL - SI - RE - FA - LA) -->
          <g class="learn-note">
            <circle cx="150" cy="153.85" r="10" class="note-circle learn-sol"></circle>
            
          </g>
          <g class="learn-note">
            <circle cx="210" cy="138.46" r="10" class="note-circle learn-si"></circle>
            
          </g>
          <g class="learn-note">
            <circle cx="270" cy="123.08" r="10" class="note-circle learn-re"></circle>
            
          </g>
          <g class="learn-note">
            <circle cx="330" cy="107.69" r="10" class="note-circle learn-fa"></circle>
            
          </g>
          <g class="learn-note">
            <circle cx="390" cy="92.31" r="10" class="note-circle learn-la"></circle>
            
          </g>

          <!-- SPAZI (dal basso: LA - DO - MI - SOL) -->
          <g class="learn-note">
            <circle cx="470" cy="146.15" r="10" class="note-circle learn-la"></circle>
            
          </g>
          <g class="learn-note">
            <circle cx="530" cy="130.77" r="10" class="note-circle learn-do"></circle>
            
          </g>
          <g class="learn-note">
            <circle cx="590" cy="115.38" r="10" class="note-circle learn-mi"></circle>
            
          </g>
          <g class="learn-note">
            <circle cx="650" cy="100.00" r="10" class="note-circle learn-sol"></circle>
            
          </g>
        </g>

      </svg>
      <div class="status-bar" id="statusBarLearn"></div>
    </div>

    <div class="note-buttons-container">
      <div class="note-buttons-wrapper">
        <button class="note-button btn-do"  data-note="do">DO</button>
        <button class="note-button btn-re"  data-note="re">RE</button>
        <button class="note-button btn-mi"  data-note="mi">MI</button>
        <button class="note-button btn-fa"  data-note="fa">FA</button>
        <button class="note-button btn-sol" data-note="sol">SOL</button>
        <button class="note-button btn-la"  data-note="la">LA</button>
        <button class="note-button btn-si"  data-note="si">SI</button>
      </div>
    </div>
  </div>
</div>
<!-- ===========================
     LIVELLO 1
     =========================== -->
<div id="level1Page" class="page-container" style="display:none">
  <div class="app">
    <div class="top-panel">
      <div class="top-row">
        <div class="top-left-controls">
          <button class="reset-btn" id="resetBtnL1" aria-label="Reset">‚Üª</button>
          <button class="menu-btn" id="menuBtnL1" aria-label="Menu">üè†</button>
<button class="clef-btn clef-treble-btn active-clef" id="clefTrebleBtnL1" aria-label="Chiave di violino">&#119070;</button>
          <button class="clef-btn clef-bass-btn" id="clefBassBtnL1" aria-label="Chiave di basso">&#119074;</button>
          
          
          <div class="stat-pill stat-errors-normal error-pill" id="errorPillL1">
            Errori: 0
          
          
          </div>
        </div>
        <h1 class="rainbow-title rainbow-title-level"><span>M</span><span>u</span><span>s</span><span>i</span><span>c</span><span>&nbsp;</span><span>R</span><span>a</span><span>i</span><span>n</span><span>b</span><span>o</span><span>w</span></h1>
        <div class="top-right-controls">
<button class="hint-btn" id="hintBtnL1" aria-label="Suggerimento">üí°</button>
<button class="rainbow-counter" id="resetAudioBtnL1" type="button">
            Attiva audio
            <span id="rainbowCountL1" class="rainbow-hidden-count">0</span>
          </button>
        </div>
      </div>
      <div class="medals-panel-container">
        <div class="medals-panel" id="medalsPanelL1"></div>
        <div class="tokens-panel" id="tokensPanelL1"></div>
      </div>
    </div>

    
      <svg id="staffSvgL1" class="staff" overflow="visible" viewBox="0 0 1000 200">
        <defs>
          <linearGradient id="rainbowStroke" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stop-color="#ef4444"/>
            <stop offset="16%" stop-color="#f97316"/>
            <stop offset="32%" stop-color="#eab308"/>
            <stop offset="48%" stop-color="#22c55e"/>
            <stop offset="64%" stop-color="#38bdf8"/>
            <stop offset="80%" stop-color="#a855f7"/>
            <stop offset="100%" stop-color="#4f46e5"/>
          </linearGradient>
          <filter id="rainbowGlow" x="-80%" y="-80%" width="260%" height="260%">
            <feGaussianBlur stdDeviation="3" result="blur"/>
            <feMerge>
              <feMergeNode in="blur"/>
              <feMergeNode in="SourceGraphic"/>
            </feMerge>
          </filter>
        </defs>

        <line x1="20" y1="92.31" x2="980" y2="92.31" stroke="#111827" stroke-width="2"/>
        <line x1="20" y1="107.69" x2="980" y2="107.69" stroke="#111827" stroke-width="2"/>
        <line x1="20" y1="123.08" x2="980" y2="123.08" stroke="#111827" stroke-width="2"/>
        <line x1="20" y1="138.46" x2="980" y2="138.46" stroke="#111827" stroke-width="2"/>
        <line x1="20" y1="153.85" x2="980" y2="153.85" stroke="#111827" stroke-width="2"/>
        
        <!-- Barra iniziale a sinistra -->
        <line x1="20" y1="92.31" x2="20" y2="153.85" stroke="#111827" stroke-width="3"/>

        <!-- Doppia barra finale a destra -->
        <line x1="970" y1="92.31" x2="970" y2="153.85" stroke="#111827" stroke-width="2"/>
        <line x1="980" y1="91.54" x2="980" y2="154.62" stroke="#111827" stroke-width="4"/>
        <g class="clef-group"><text x="40" y="164" font-size="115" class="clef-symbol">&#119070;</text>
        <circle class="bass-dot" cx="95" cy="131" r="4" fill="#111827" />
        <circle class="bass-dot" cx="95" cy="146" r="4" fill="#111827" /></g>
      </svg>
      <div class="status-bar" id="statusBarL1">
    </div>

    <div class="note-buttons-container">
      <div class="note-buttons-wrapper">
        <button class="note-button btn-do"  data-note="do">DO</button>
        <button class="note-button btn-re"  data-note="re">RE</button>
        <button class="note-button btn-mi"  data-note="mi">MI</button>
        <button class="note-button btn-fa"  data-note="fa">FA</button>
        <button class="note-button btn-sol" data-note="sol">SOL</button>
        <button class="note-button btn-la"  data-note="la">LA</button>
        <button class="note-button btn-si"  data-note="si">SI</button>
      </div>
    </div>
  </div>
</div>

<!-- ===========================
     LIVELLO 2
     =========================== -->
<div id="level2Page" class="page-container">
  <div class="app">
    <div class="top-panel">
      <div class="top-row">
        <div class="top-left-controls">
          <button class="reset-btn" id="resetBtn" aria-label="Reset">‚Üª</button>
          <button class="menu-btn" id="menuBtnL2" aria-label="Menu">üè†</button>
<button class="clef-btn clef-treble-btn active-clef" id="clefTrebleBtnL2" aria-label="Chiave di violino">&#119070;</button>
          <button class="clef-btn clef-bass-btn" id="clefBassBtnL2" aria-label="Chiave di basso">&#119074;</button>
          
          <div class="stat-pill stat-errors-normal error-pill" id="errorPillL2">
            Errori: 0
          
          
          </div>
        </div>
        <h1 class="rainbow-title rainbow-title-level"><span>M</span><span>u</span><span>s</span><span>i</span><span>c</span><span>&nbsp;</span><span>R</span><span>a</span><span>i</span><span>n</span><span>b</span><span>o</span><span>w</span></h1>
        <div class="top-right-controls">
<button class="rainbow-counter" id="resetAudioBtnL2" type="button">
            Attiva audio
            <span id="rainbowCount" class="rainbow-hidden-count">0</span>
          </button>
        </div>
      </div>
      <div class="medals-panel-container">
        <div class="medals-panel" id="medalsPanel"></div>
        <div class="tokens-panel" id="tokensPanelL2"></div>
      </div>
    </div>

    
      <svg id="staffSvg" class="staff" overflow="visible" viewBox="0 0 1000 200">
        <defs>
          <linearGradient id="rainbowStroke" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stop-color="#ef4444"/>
            <stop offset="16%" stop-color="#f97316"/>
            <stop offset="32%" stop-color="#eab308"/>
            <stop offset="48%" stop-color="#22c55e"/>
            <stop offset="64%" stop-color="#38bdf8"/>
            <stop offset="80%" stop-color="#a855f7"/>
            <stop offset="100%" stop-color="#4f46e5"/>
          </linearGradient>
          <filter id="rainbowGlow" x="-80%" y="-80%" width="260%" height="260%">
            <feGaussianBlur stdDeviation="3" result="blur"/>
            <feMerge>
              <feMergeNode in="blur"/>
              <feMergeNode in="SourceGraphic"/>
            </feMerge>
          </filter>
        </defs>

        <line x1="20" y1="92.31" x2="980" y2="92.31" stroke="#111827" stroke-width="2"/>
        <line x1="20" y1="107.69" x2="980" y2="107.69" stroke="#111827" stroke-width="2"/>
        <line x1="20" y1="123.08" x2="980" y2="123.08" stroke="#111827" stroke-width="2"/>
        <line x1="20" y1="138.46" x2="980" y2="138.46" stroke="#111827" stroke-width="2"/>
        <line x1="20" y1="153.85" x2="980" y2="153.85" stroke="#111827" stroke-width="2"/>
        
        <!-- Barra iniziale a sinistra -->
        <line x1="20" y1="92.31" x2="20" y2="153.85" stroke="#111827" stroke-width="3"/>

        <!-- Doppia barra finale a destra -->
        <line x1="970" y1="92.31" x2="970" y2="153.85" stroke="#111827" stroke-width="2"/>
        <line x1="980" y1="91.54" x2="980" y2="154.62" stroke="#111827" stroke-width="4"/>
        <g class="clef-group"><text x="40" y="164" font-size="115" class="clef-symbol">&#119070;</text>
        <circle class="bass-dot" cx="95" cy="131" r="4" fill="#111827" />
        <circle class="bass-dot" cx="95" cy="146" r="4" fill="#111827" /></g>
      </svg>
      <div class="status-bar" id="statusBar">
    </div>

    <div class="keyboard-container">
      <div class="piano">
        <div class="piano-keys" id="pianoKeys"></div>
      </div>
    </div>
  </div>
</div>

<!-- ===========================
     LIVELLO 3
     =========================== -->
<div id="level3Page" class="page-container" style="display:none">
  <div class="app">
    <div class="top-panel">
      <div class="top-row">
        <div class="top-left-controls">
          <button class="reset-btn" id="resetBtnL3" aria-label="Reset">‚Üª</button>
          <button class="menu-btn" id="menuBtnL3" aria-label="Menu">üè†</button>
<button class="clef-btn clef-treble-btn active-clef" id="clefTrebleBtnL3" aria-label="Chiave di violino">&#119070;</button>
          <button class="clef-btn clef-bass-btn" id="clefBassBtnL3" aria-label="Chiave di basso">&#119074;</button>
          
          <div class="stat-pill stat-errors-normal error-pill" id="errorPillL3">
            Errori: 0
          
          
          </div>
        </div>
        <h1 class="rainbow-title rainbow-title-level"><span>M</span><span>u</span><span>s</span><span>i</span><span>c</span><span>&nbsp;</span><span>R</span><span>a</span><span>i</span><span>n</span><span>b</span><span>o</span><span>w</span></h1>
        <div class="top-right-controls">
<button class="rainbow-counter" id="resetAudioBtnL3" type="button">
            Attiva audio
            <span id="rainbowCountL3" class="rainbow-hidden-count">0</span>
          </button>
        </div>
      </div>
      <div class="medals-panel-container">
        <div class="medals-panel" id="medalsPanelL3"></div>
        <div class="tokens-panel" id="tokensPanelL3"></div>
      </div>
    </div>

    
      <svg id="staffSvgL3" class="staff" overflow="visible" viewBox="0 0 1000 200">
        <defs>
          <linearGradient id="rainbowStroke" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stop-color="#ef4444"/>
            <stop offset="16%" stop-color="#f97316"/>
            <stop offset="32%" stop-color="#eab308"/>
            <stop offset="48%" stop-color="#22c55e"/>
            <stop offset="64%" stop-color="#38bdf8"/>
            <stop offset="80%" stop-color="#a855f7"/>
            <stop offset="100%" stop-color="#4f46e5"/>
          </linearGradient>
          <filter id="rainbowGlow" x="-80%" y="-80%" width="260%" height="260%">
            <feGaussianBlur stdDeviation="3" result="blur"/>
            <feMerge>
              <feMergeNode in="blur"/>
              <feMergeNode in="SourceGraphic"/>
            </feMerge>
          </filter>
        </defs>

        <line x1="20" y1="92.31" x2="980" y2="92.31" stroke="#111827" stroke-width="2"/>
        <line x1="20" y1="107.69" x2="980" y2="107.69" stroke="#111827" stroke-width="2"/>
        <line x1="20" y1="123.08" x2="980" y2="123.08" stroke="#111827" stroke-width="2"/>
        <line x1="20" y1="138.46" x2="980" y2="138.46" stroke="#111827" stroke-width="2"/>
        <line x1="20" y1="153.85" x2="980" y2="153.85" stroke="#111827" stroke-width="2"/>
        
        <!-- Barra iniziale a sinistra -->
        <line x1="20" y1="92.31" x2="20" y2="153.85" stroke="#111827" stroke-width="3"/>

        <!-- Doppia barra finale a destra -->
        <line x1="970" y1="92.31" x2="970" y2="153.85" stroke="#111827" stroke-width="2"/>
        <line x1="980" y1="91.54" x2="980" y2="154.62" stroke="#111827" stroke-width="4"/>
        <g class="clef-group"><text x="40" y="164" font-size="115" class="clef-symbol">&#119070;</text>
        <circle class="bass-dot" cx="95" cy="131" r="4" fill="#111827" />
        <circle class="bass-dot" cx="95" cy="146" r="4" fill="#111827" /></g>
      </svg>
      <div class="status-bar" id="statusBarL3">
    </div>

    <div class="keyboard-container">
      <div class="piano">
        <div class="piano-keys" id="pianoKeysL3"></div>
      </div>
    </div>
  </div>
</div>

<!-- ===========================
     LIVELLO 4
     =========================== -->
<div id="level4Page" class="page-container" style="display:none">
  <div class="app">
    <div class="top-panel">
      <div class="top-row">
        <div class="top-left-controls">
          <button class="reset-btn" id="resetBtnL4" aria-label="Reset">‚Üª</button>
          <button class="menu-btn" id="menuBtnL4" aria-label="Menu">üè†</button>
<button class="clef-btn clef-treble-btn active-clef" id="clefTrebleBtnL4" aria-label="Chiave di violino">&#119070;</button>
          <button class="clef-btn clef-bass-btn" id="clefBassBtnL4" aria-label="Chiave di basso">&#119074;</button>
          
          <div class="stat-pill stat-errors-normal error-pill" id="errorPillL4">
            Errori: 0
          
          
          </div>
        </div>
        <h1 class="rainbow-title rainbow-title-level"><span>M</span><span>u</span><span>s</span><span>i</span><span>c</span><span>&nbsp;</span><span>R</span><span>a</span><span>i</span><span>n</span><span>b</span><span>o</span><span>w</span></h1>
        <div class="top-right-controls">
<div class="metronome-pill" id="metronomePillL4">
            <input id="bpmInputL4" class="metronome-bpm-input" type="number" min="40" max="160" value="80" aria-label="Tempo in BPM">
            <div class="metronome-dot" id="metronomeDotL4"></div>
            <label class="metronome-switch">
              <input type="checkbox" id="metronomeToggleSwitchL4" aria-label="Metronomo">
              <span class="metronome-slider" aria-hidden="true"></span>
            </label>
          </div>
<button class="rainbow-counter" id="resetAudioBtnL4" type="button">
            Attiva audio
            <span id="rainbowCountL4" class="rainbow-hidden-count">0</span>
          </button>
        </div>
      </div>
      <div class="medals-panel-container">
        <div class="medals-panel" id="medalsPanelL4"></div>
        <div class="tokens-panel" id="tokensPanelL4"></div>
      </div>
    </div>

    
      <svg id="staffSvgL4" class="staff" overflow="visible" viewBox="0 0 1000 200">
        <defs>
          <linearGradient id="rainbowStroke" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stop-color="#ef4444"/>
            <stop offset="16%" stop-color="#f97316"/>
            <stop offset="32%" stop-color="#eab308"/>
            <stop offset="48%" stop-color="#22c55e"/>
            <stop offset="64%" stop-color="#38bdf8"/>
            <stop offset="80%" stop-color="#a855f7"/>
            <stop offset="100%" stop-color="#4f46e5"/>
          </linearGradient>
          <filter id="rainbowGlow" x="-80%" y="-80%" width="260%" height="260%">
            <feGaussianBlur stdDeviation="3" result="blur"/>
            <feMerge>
              <feMergeNode in="blur"/>
              <feMergeNode in="SourceGraphic"/>
            </feMerge>
          </filter>
        </defs>
        <g id="staffL4Group">
        <line x1="20" y1="92.31" x2="980" y2="92.31" stroke="#111827" stroke-width="2"/>
        <line x1="20" y1="107.69" x2="980" y2="107.69" stroke="#111827" stroke-width="2"/>
        <line x1="20" y1="123.08" x2="980" y2="123.08" stroke="#111827" stroke-width="2"/>
        <line x1="20" y1="138.46" x2="980" y2="138.46" stroke="#111827" stroke-width="2"/>
        <line x1="20" y1="153.85" x2="980" y2="153.85" stroke="#111827" stroke-width="2"/>
        
        <!-- Barra iniziale a sinistra -->
        <line x1="20" y1="92.31" x2="20" y2="153.85" stroke="#111827" stroke-width="3"/>

        <!-- Doppia barra finale a destra -->
        <line x1="970" y1="92.31" x2="970" y2="153.85" stroke="#111827" stroke-width="2"/>
        <line x1="980" y1="91.54" x2="980" y2="154.62" stroke="#111827" stroke-width="4"/>
        <g class="clef-group"><text x="40" y="164" font-size="115" class="clef-symbol">&#119070;</text>
        <circle class="bass-dot" cx="95" cy="131" r="4" fill="#111827" />
        <circle class="bass-dot" cx="95" cy="146" r="4" fill="#111827" /></g>

      
        </g>
</svg>
      <div class="status-bar" id="statusBarL4">
    </div>

    <div class="keyboard-container">
      <div class="piano">
        <div class="piano-keys" id="pianoKeysL4"></div>
      </div>
    </div>
  </div>
</div>

<!-- ===========================
     IMPARA IL TEMPO
     =========================== -->
<div id="learnTempoPage" class="page-container" style="display:none">
  <div class="app">
    <div class="top-panel">
      <div class="top-row">
        <div class="top-left-controls">
          <button class="reset-btn" id="resetBtnTempo" aria-label="Reset">‚Üª</button>
          <button class="menu-btn" id="menuBtnTempo" aria-label="Menu">üè†</button>
          
        
          <button class="clef-btn clef-treble-btn active-clef" id="clefTrebleBtnTempo" aria-label="Chiave di violino">&#119070;</button>
          <button class="clef-btn clef-bass-btn" id="clefBassBtnTempo" aria-label="Chiave di basso">&#119074;</button>
          </div>
        <h1 class="rainbow-title rainbow-title-level"><span>M</span><span>u</span><span>s</span><span>i</span><span>c</span><span>&nbsp;</span><span>R</span><span>a</span><span>i</span><span>n</span><span>b</span><span>o</span><span>w</span></h1>
        <div class="top-right-controls">
<div class="metronome-pill" id="metronomePillTempo">
            <input id="bpmInputTempo" class="metronome-bpm-input" type="number" min="40" max="160" value="80" aria-label="Tempo in BPM">
            <div class="metronome-dot" id="metronomeDotTempo"></div>
            <label class="metronome-switch">
              <input type="checkbox" id="metronomeToggleSwitchTempo" aria-label="Metronomo">
              <span class="metronome-slider" aria-hidden="true"></span>
            </label>
          </div>
<button class="rainbow-counter" id="resetAudioBtnTempo" type="button">
            Attiva audio
            <span id="rainbowCountTempo" class="rainbow-hidden-count">0</span>
          </button>
        </div>
      </div>
      <div class="medals-panel-container">
        <div class="medals-panel" id="medalsPanelTempo"></div>
        <div class="tokens-panel" id="tokensPanelTempo"></div>
      </div>
    </div>

    
      <svg id="staffSvgTempo" class="staff" overflow="visible" viewBox="0 0 1000 200">
        <defs>
          <linearGradient id="rainbowStroke" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stop-color="#ef4444"/>
            <stop offset="16%" stop-color="#f97316"/>
            <stop offset="32%" stop-color="#eab308"/>
            <stop offset="48%" stop-color="#22c55e"/>
            <stop offset="64%" stop-color="#38bdf8"/>
            <stop offset="80%" stop-color="#a855f7"/>
            <stop offset="100%" stop-color="#4f46e5"/>
          </linearGradient>
          <filter id="rainbowGlow" x="-80%" y="-80%" width="260%" height="260%">
            <feGaussianBlur stdDeviation="3" result="blur"/>
            <feMerge>
              <feMergeNode in="blur"/>
              <feMergeNode in="SourceGraphic"/>
            </feMerge>
          </filter>
        </defs>
        <g id="staffTempoGroup">
        <line x1="20" y1="92.31" x2="980" y2="92.31" stroke="#111827" stroke-width="2"/>
        <line x1="20" y1="107.69" x2="980" y2="107.69" stroke="#111827" stroke-width="2"/>
        <line x1="20" y1="123.08" x2="980" y2="123.08" stroke="#111827" stroke-width="2"/>
        <line x1="20" y1="138.46" x2="980" y2="138.46" stroke="#111827" stroke-width="2"/>
        <line x1="20" y1="153.85" x2="980" y2="153.85" stroke="#111827" stroke-width="2"/>
        
        <!-- Barra iniziale a sinistra -->
        <line x1="20" y1="92.31" x2="20" y2="153.85" stroke="#111827" stroke-width="3"/>

        <!-- Doppia barra finale a destra -->
        <line x1="970" y1="92.31" x2="970" y2="153.85" stroke="#111827" stroke-width="2"/>
        <line x1="980" y1="91.54" x2="980" y2="154.62" stroke="#111827" stroke-width="4"/>
        <g class="clef-group"><text x="40" y="164" font-size="115" class="clef-symbol">&#119070;</text>
        <circle class="bass-dot" cx="95" cy="131" r="4" fill="#111827" />
        <circle class="bass-dot" cx="95" cy="146" r="4" fill="#111827" /></g>

      
        </g>
</svg>
      <div class="status-bar" id="statusBarTempo">
    </div>

    <div class="tempo-action-container">
      <button id="tempoActionBtn" class="tempo-action-btn" type="button">
        Tocca per suonare
      </button>
    </div>
  </div>
</div>

<!-- ===========================
     PAGINA PLAY
     =========================== -->
<div id="playPage" class="page-container" style="display:none">
  <div class="app">
    <div id="playTimeupOverlay" class="play-timeup-overlay">
      <div class="play-timeup-box">
        <div class="rainbow-message-main">Tempo Play terminato!</div>
        <div class="rainbow-message-sub">Vinci un altro gettone completando 5 medaglie.</div>
      </div>
    </div>
    <div class="top-panel">
      <div class="top-row">
        <div class="top-left-controls">
          <button class="reset-btn" id="resetBtnPlay" aria-label="Reset">‚Üª</button>
          <button class="menu-btn" id="menuBtnPlay" aria-label="Menu">üè†</button>

          <button class="clef-btn clef-treble-btn active-clef" id="clefTrebleBtnPlay" aria-label="Chiave di violino">&#119070;</button>
          <button class="clef-btn clef-bass-btn" id="clefBassBtnPlay" aria-label="Chiave di basso">&#119074;</button>
          </div>
        <h1 class="rainbow-title"><span>M</span><span>u</span><span>s</span><span>i</span><span>c</span><span>&nbsp;</span><span>R</span><span>a</span><span>i</span><span>n</span><span>b</span><span>o</span><span>w</span></h1>
        <div class="top-right-controls">
<button class="rainbow-counter" id="resetAudioBtnPlay" type="button">
            Attiva audio
            <span id="rainbowCountPlay" class="rainbow-hidden-count">0</span>
          </button>
          <button class="play-timer-pill" type="button" aria-label="Tempo rimanente Modalit√† Play">
            <span id="playTimerText">05:00</span>
          </button>
        </div>
      </div>
    </div>

    
      <svg id="staffSvgPlay" class="staff" overflow="visible" viewBox="0 0 1000 200">
        <line x1="20" y1="92.31" x2="980" y2="92.31" stroke="#111827" stroke-width="2"/>
        <line x1="20" y1="107.69" x2="980" y2="107.69" stroke="#111827" stroke-width="2"/>
        <line x1="20" y1="123.08" x2="980" y2="123.08" stroke="#111827" stroke-width="2"/>
        <line x1="20" y1="138.46" x2="980" y2="138.46" stroke="#111827" stroke-width="2"/>
        <line x1="20" y1="153.85" x2="980" y2="153.85" stroke="#111827" stroke-width="2"/>
        
        <!-- Barra iniziale a sinistra -->
        <line x1="20" y1="92.31" x2="20" y2="153.85" stroke="#111827" stroke-width="3"/>

        <!-- Doppia barra finale a destra -->
        <line x1="970" y1="92.31" x2="970" y2="153.85" stroke="#111827" stroke-width="2"/>
        <line x1="980" y1="91.54" x2="980" y2="154.62" stroke="#111827" stroke-width="4"/>
        <g class="clef-group"><text x="40" y="164" font-size="115" class="clef-symbol">&#119070;</text>
        <circle class="bass-dot" cx="95" cy="131" r="4" fill="#111827" />
        <circle class="bass-dot" cx="95" cy="146" r="4" fill="#111827" /></g>
      </svg>

    <div class="keyboard-container">
      <div class="piano">
        <div class="piano-keys" id="pianoKeysPlay"></div>
      </div>
    </div>
  </div>
</div>

<!-- ===========================
     PAGINA TROFEI
     =========================== -->

<div id="trophyPage" class="page-container" style="display:none">
  <div class="app">
    <div class="top-panel">
      <div class="top-row">
        <div class="top-left-controls">
          <button class="menu-btn" id="trophyBackBtn">‚è™</button>
          <button class="menu-btn" id="trophyHomeBtn">üè†</button>
        </div>
        <h1 class="rainbow-title"><span>M</span><span>u</span><span>s</span><span>i</span><span>c</span><span>&nbsp;</span><span>R</span><span>a</span><span>i</span><span>n</span><span>b</span><span>o</span><span>w</span></h1>
        <div class="top-right-controls"></div>
      </div>
    </div>

    <div class="trophy-main">
      <div class="chest-grid-container">
        <div id="chestGrid" class="chest-grid"></div>
      </div>

      <button id="clearChestsBtn" class="clear-chests-btn" type="button">
        Cancella tutti gli scrigni
      </button>

      <div id="trophyContent" class="trophy-content" style="display:none"></div>

      <div id="trophyOverlay" class="trophy-overlay">
        <div class="trophy-overlay-box">
          <button id="trophyOverlayClose" class="trophy-overlay-close" type="button" aria-label="Chiudi scrigno">‚úï</button>
          <div id="trophyOverlayContent" class="trophy-overlay-content"></div>
        </div>
      </div>


      
        
      </div>

      
    </div>
  </div>
</div>

  </div>
</div>

<script>
/* ===========================
   COSTANTI COMUNI
   =========================== */

const NOTES = [
  { name: "do",  color: "#ef4444" },
  { name: "re",  color: "#f97316" },
  { name: "mi",  color: "#eab308" },
  { name: "fa",  color: "#22c55e" },
  { name: "sol", color: "#38bdf8" },
  { name: "la",  color: "#a855f7" },
  { name: "si",  color: "#4f46e5" }
];

const NOTE_FREQS = {
  "do": 261.63,
  "re": 293.66,
  "mi": 329.63,
  "fa": 349.23,
  "sol": 392.00,
  "la": 440.00,
  "si": 493.88,
  "do#": 277.18, "re#": 311.13, "fa#": 369.99, "sol#": 415.30, "la#": 466.16
};

const CLEF_TREBLE = "treble";
const CLEF_BASS   = "bass";

let currentClef = CLEF_TREBLE;

// Posizioni del pentagramma in chiave di violino (setup originale)
const STAFF_CORE_POSITIONS_TREBLE = [
  { y:153.85, noteName:"mi",  octave:1 },
  { y:146.15, noteName:"fa",  octave:1 },
  { y:138.46, noteName:"sol", octave:1 },
  { y:130.77, noteName:"la",  octave:1 },
  { y:123.08, noteName:"si",  octave:1 },
  { y:115.38, noteName:"do",  octave:2 },
  { y:107.69, noteName:"re",  octave:2 },
  { y:100.0, noteName:"mi",  octave:2 },
  { y:92.31, noteName:"fa",  octave:2 }
];

const STAFF_LEDGER_LOW_TREBLE = [
  { y:161.54, noteName:"re", octave:1 },
  { y:169.23, noteName:"do", octave:1 }
];

const STAFF_LEDGER_HIGH_TREBLE = [
  { y:84.62, noteName:"sol", octave:2 },
  { y:76.92, noteName:"la",  octave:2 }
];

// Posizioni del pentagramma in chiave di basso
// (stesse linee/spazi, ma con nomi delle note secondo la lettura in chiave di basso)
const STAFF_CORE_POSITIONS_BASS = [
  { y:153.85, noteName:"sol", octave:1 }, // linea 1 (in basso)
  { y:146.15, noteName:"la",  octave:1 },
  { y:138.46, noteName:"si",  octave:1 },
  { y:130.77, noteName:"do",  octave:2 },
  { y:123.08, noteName:"re",  octave:2 },
  { y:115.38, noteName:"mi",  octave:2 },
  { y:107.69, noteName:"fa",  octave:2 },
  { y:100.0, noteName:"sol", octave:2 },
  { y:92.31, noteName:"la",  octave:2 }  // linea 5 (in alto)
];

// Per semplicit√†, le note di taglio in alto/basso restano le stesse in entrambe le chiavi
const STAFF_LEDGER_LOW_BASS  = [
  { y:161.54, noteName:"fa", octave:1 },
  { y:169.23, noteName:"mi", octave:1 }
];
const STAFF_LEDGER_HIGH_BASS = STAFF_LEDGER_HIGH_TREBLE.slice();

// Questi sono i riferimenti effettivamente usati dal resto del codice.
// Vengono reindirizzati automaticamente quando si cambia chiave.
let STAFF_CORE_POSITIONS = STAFF_CORE_POSITIONS_TREBLE;
let STAFF_LEDGER_LOW     = STAFF_LEDGER_LOW_TREBLE;
let STAFF_LEDGER_HIGH    = STAFF_LEDGER_HIGH_TREBLE;

function setClef(clef) {
  currentClef = (clef === CLEF_BASS) ? CLEF_BASS : CLEF_TREBLE;
  if (currentClef === CLEF_BASS) {
    STAFF_CORE_POSITIONS = STAFF_CORE_POSITIONS_BASS;
    STAFF_LEDGER_LOW     = STAFF_LEDGER_LOW_BASS;
    STAFF_LEDGER_HIGH    = STAFF_LEDGER_HIGH_BASS;
  } else {
    STAFF_CORE_POSITIONS = STAFF_CORE_POSITIONS_TREBLE;
    STAFF_LEDGER_LOW     = STAFF_LEDGER_LOW_TREBLE;
    STAFF_LEDGER_HIGH    = STAFF_LEDGER_HIGH_TREBLE;
  }
  updateStaffClefSymbols();
}

// inizializza in chiave di violino
setClef(CLEF_TREBLE);

const MELODY_STEP_MS = 250;

const AudioContextWeb = window.AudioContext || window.webkitAudioContext;
let audioCtx = null;
let audioUnlocked = false;
let hasPlayedHomeJingle = false;
let homeIntroTimeoutId = null;
let homeIntroTimerElapsed = false;

// Preferenza audio (persistente)
const AUDIO_PREF_KEY = "musicRainbowAudioEnabled";
let audioPreferenceExplicit = false;
let audioEnabled = false;
let isAudioInit = true;
try {
  const v = localStorage.getItem(AUDIO_PREF_KEY);
  if (v !== null) {
    audioPreferenceExplicit = true;
    audioEnabled = (v === "1" || v === "true");
  }
} catch (e) {
  // ignore
}
// Stato globale per i jingle finali degli spartiti
let isJinglePlaying = false;
let activeJingleTimeouts = [];
let currentJingleLevel = null;

let nextScoreTimeoutL1 = null;
let nextScoreTimeoutL2 = null;
let nextScoreTimeoutL3 = null;
let nextScoreTimeoutL4 = null;


function clearJingleTimeouts() {
  if (!activeJingleTimeouts || !activeJingleTimeouts.length) return;
  activeJingleTimeouts.forEach(id => clearTimeout(id));
  activeJingleTimeouts = [];
}

function stopGlobalJinglePlayback() {
  if (!isJinglePlaying) return;
  isJinglePlaying = false;
  clearJingleTimeouts();

  if (typeof nextScoreTimeoutL1 !== "undefined" && nextScoreTimeoutL1) {
    clearTimeout(nextScoreTimeoutL1);
    nextScoreTimeoutL1 = null;
  }
  if (typeof nextScoreTimeoutL2 !== "undefined" && nextScoreTimeoutL2) {
    clearTimeout(nextScoreTimeoutL2);
    nextScoreTimeoutL2 = null;
  }
  if (typeof nextScoreTimeoutL3 !== "undefined" && nextScoreTimeoutL3) {
    clearTimeout(nextScoreTimeoutL3);
    nextScoreTimeoutL3 = null;
  }
  if (typeof nextScoreTimeoutL4 !== "undefined" && nextScoreTimeoutL4) {
    clearTimeout(nextScoreTimeoutL4);
    nextScoreTimeoutL4 = null;
  }

  currentJingleLevel = null;

  try {
    // Ferma immediatamente anche l'audio attuale
    resetAudioOnEnable();
  } catch (e) {
    // ignore
  }
}


function getAudioCtx() {
  // Crea o ricrea il contesto se non esiste o √® stato chiuso
  if (!audioCtx || audioCtx.state === "closed") {
    audioCtx = new AudioContextWeb();
  }
  return audioCtx;
}

// Sblocco esplicito per Safari / iOS: viene chiamato al primo tap/click
function unlockAudioOnce() {
  if (audioUnlocked) return;
  const ctx = getAudioCtx();
  if (ctx && ctx.state === "suspended") {
    ctx.resume().catch(() => {});
  }
  audioUnlocked = true;
}

// Agganciamo l‚Äôunlock al primo gesto dell‚Äôutente
window.addEventListener("touchstart", unlockAudioOnce, { once: true });
window.addEventListener("mousedown", unlockAudioOnce, { once: true });
window.addEventListener("pointerdown", unlockAudioOnce, { once: true });

// Qualsiasi tap/click mentre sta suonando un jingle finale interrompe subito il jingle
window.addEventListener("pointerdown", function(ev) {
  if (!isJinglePlaying) return;

  // Salva il livello per sapere quale spartito avanzare
  const level = typeof currentJingleLevel !== "undefined" ? currentJingleLevel : null;

  stopGlobalJinglePlayback();

  try {
    if (level === 1) {
      // LIVELLO 1: chiudi eventuali overlay e passa allo spartito/step successivo
      if (typeof finalOverlayL1 !== "undefined" && finalOverlayL1 && finalOverlayL1.classList.contains("active")) {
        finalOverlayL1.classList.remove("active");
        level1PageEl.style.display = "none";
        level2PageEl.style.display = "flex";
        level3PageEl.style.display = "none";
        playPageEl.style.display  = "none";
        lastGamePageId = "level2Page";
        softResetLevel2();
      } else {
        if (typeof rainbowOverlayL1 !== "undefined" && rainbowOverlayL1) {
          rainbowOverlayL1.classList.remove("active");
        }
        if (typeof createNotesL1 === "function") {
          createNotesL1();
        }
      }
    } else if (level === 2) {
      // LIVELLO 2: chiudi overlay e avanza come se il jingle fosse terminato
      if (typeof finalOverlayL2 !== "undefined" && finalOverlayL2 && finalOverlayL2.classList.contains("active")) {
        finalOverlayL2.classList.remove("active");
        level2PageEl.style.display = "none";
        level3PageEl.style.display = "flex";
        playPageEl.style.display  = "none";
        lastGamePageId = "level3Page";
        softResetLevel3();
      } else {
        if (typeof rainbowOverlay !== "undefined" && rainbowOverlay) {
          rainbowOverlay.classList.remove("active");
        }
        if (typeof createNotes === "function") {
          createNotes();
        }
      }
    } else if (level === 3) {
      // LIVELLO 3: chiudi overlay e rigenera lo spartito
      if (typeof finalOverlayL3 !== "undefined" && finalOverlayL3 && finalOverlayL3.classList.contains("active")) {
        finalOverlayL3.classList.remove("active");
      }
      if (typeof rainbowOverlayL3 !== "undefined" && rainbowOverlayL3) {
        rainbowOverlayL3.classList.remove("active");
      }
      if (typeof createNotesL3 === "function") {
        createNotesL3();
      }
    } else if (level === 4) {
      // LIVELLO 4: chiudi overlay e passa subito allo spartito successivo
      if (typeof rainbowOverlayL4 !== "undefined" && rainbowOverlayL4) {
        rainbowOverlayL4.classList.remove("active");
      }
      if (typeof createNotesL4 === "function") {
        createNotesL4();
      }
    }
  } catch (e) {
    // ignora eventuali errori
  }
});



function hardResetAudio() {
  try {
    if (audioCtx && audioCtx.state !== "closed") {
      audioCtx.close();
    }
  } catch (e) {
    // ignore
  }

  audioCtx = null;
  audioUnlocked = false;

  try {
    unlockAudioOnce();
  } catch (e) {
    // ignore
  }

  alert("Audio reimpostato! Se non senti ancora i suoni, prova a toccare di nuovo lo schermo.");
}

function playTone(freq, durationMs) {
  // Non suonare nulla se l'audio √® disattivato
  if (!audioEnabled) return;

  const ctx = getAudioCtx();
  if (!ctx) return;

  const doPlay = () => {
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    const effectiveFreq = (typeof currentClef !== "undefined" && currentClef === CLEF_BASS)
      ? freq * 0.5
      : freq;
    o.frequency.value = effectiveFreq;
    o.type = "sine";
    o.connect(g);
    g.connect(ctx.destination);

    const now = ctx.currentTime;
    const durationSec = (typeof durationMs === "number" && durationMs > 0)
      ? (durationMs / 1000)
      : 0.5;

    g.gain.setValueAtTime(0.4, now);
    g.gain.exponentialRampToValueAtTime(0.001, now + durationSec);
    o.start(now);
    o.stop(now + durationSec + 0.05);
  };

  if (ctx.state === "suspended" && typeof ctx.resume === "function") {
    try {
      const resumeResult = ctx.resume();
      if (resumeResult && typeof resumeResult.then === "function") {
        resumeResult.then(doPlay).catch(doPlay);
      } else {
        // resume non restituisce una Promise: proviamo comunque a suonare
        doPlay();
      }
    } catch (e) {
      // in caso di errore, proviamo comunque a suonare
      doPlay();
    }
  } else {
    doPlay();
  }
}

function playHomeJingle() {
  // Piccola musichetta introduttiva: do, re, mi
  try {
    const seq = [
      NOTE_FREQS["do"] || 261.63,
      NOTE_FREQS["re"] || 293.66,
      NOTE_FREQS["mi"] || 329.63
    ];
    let delay = 0;
    const step = 250;

    seq.forEach(freq => {
      setTimeout(() => {
        if (audioUnlocked && audioEnabled) {
          playTone(freq);
        }
      }, delay);
      delay += step;
    });
  } catch (e) {
    // se qualcosa va storto, ignoriamo la musichetta
  }
}


// Aggiorna il testo del pulsante audio mantenendo eventuali span interni
function setButtonAudioLabel(btn, text) {
  if (!btn) return;
  const nodes = Array.from(btn.childNodes);
  let textNode = nodes.find(n => n.nodeType === Node.TEXT_NODE);
  if (textNode) {
    textNode.textContent = text + " ";
  } else {
    btn.insertBefore(document.createTextNode(text + " "), btn.firstChild);
  }
}

// Aggiorna aspetto (colore + label) di tutti i pulsanti audio
function updateAudioButtonsUI() {
  const homeBtn = document.getElementById("audioResetBtn");
  const otherButtons = [
    document.getElementById("resetAudioBtnL1"),
    document.getElementById("resetAudioBtnL2"),
    document.getElementById("resetAudioBtnL3"),
    document.getElementById("resetAudioBtnL4"),
    document.getElementById("resetAudioBtnPlay"),
    document.getElementById("resetAudioBtnTempo"),
    document.getElementById("resetAudioBtnLearn")
  ].filter(Boolean);

  // Aggiorna classi colore per tutti
  if (homeBtn) {
    homeBtn.classList.toggle("audio-on", audioEnabled);
    homeBtn.classList.toggle("audio-off", !audioEnabled);
  }
  otherButtons.forEach(btn => {
    btn.classList.toggle("audio-on", audioEnabled);
    btn.classList.toggle("audio-off", !audioEnabled);
  });

  // La label testuale va solo sul pulsante della home
  if (homeBtn) {
    setButtonAudioLabel(homeBtn, audioEnabled ? "Disattiva audio" : "Attiva audio");
  }
}

// Imposta lo stato audio globale
// Piccolo reset audio ogni volta che si ri-attiva l'audio (utile per iOS/iPadOS)
function resetAudioOnEnable() {
  try {
    if (audioCtx && audioCtx.state !== "closed") {
      audioCtx.close();
    }
  } catch (e) {
    // ignore
  }
  audioCtx = null;
  audioUnlocked = false;

  try {
    unlockAudioOnce();
  } catch (e) {
    // ignore
  }
}

function setAudioEnabled(enabled, persist = true) {
  const wasEnabled = audioEnabled;
  audioEnabled = !!enabled;

  if (persist) {
    audioPreferenceExplicit = true;
    try {
      localStorage.setItem(AUDIO_PREF_KEY, audioEnabled ? "1" : "0");
    } catch (e) {
      // ignore
    }
  }

  updateAudioButtonsUI();

  // Se lo stiamo appena attivando, fai un reset veloce dell\'audio (per iPad/iOS)
  if (audioEnabled && !wasEnabled) {
    resetAudioOnEnable();

    // Suona il jingle iniziale do‚Äìre‚Äìmi solo la prima volta (mai durante init)
    if (!hasPlayedHomeJingle && !isAudioInit) {
      playHomeJingle();
      hasPlayedHomeJingle = true;
    }
  }
}


// Toggle rapido (usato dai pulsanti)
function toggleAudio() {
  setAudioEnabled(!audioEnabled);
}

function playError() { playTone(150); }

function getNoteColor(noteName) {
  const base = noteName.replace("#","");
  return (NOTES.find(n => n.name === base) || {color:"#ffffff"}).color;
}

function colorNoteElementByName(noteObj) {
  if (!noteObj || !noteObj.element) return;
  const color = getNoteColor(noteObj.noteName || "");
  const el = noteObj.element;
  const head = el.querySelector(".note-head");
  const parts = el.querySelectorAll(".note-stem, .note-flag");

  if (head) {
    head.style.stroke = color;
    head.style.fill = color;
  }
  parts.forEach(p => {
    p.style.stroke = color;
  });

  // Manteniamo la classe come marcatore logico
  if (el.classList) {
    el.classList.add("note-played");
  }
}


function setStatusBar(el, levelLabel, notes, errors, threshold) {
  // Versione 3.300: le pillole Note/Errori sono state rimosse dall'area sotto lo spartito.
  // Manteniamo la funzione per compatibilit√† ma non mostriamo pi√π nulla qui.
  if (!el) return;
  el.innerHTML = "";
}

function updateErrorPill(el, errors, threshold) {
  if (!el) return;
  const high = errors >= threshold;
  el.textContent = `Errori: ${errors}`;
  el.classList.remove("stat-errors-normal", "stat-errors-high");
  el.classList.add(high ? "stat-errors-high" : "stat-errors-normal");
}

function getStaffY(noteName, octave) {
  const pool = STAFF_CORE_POSITIONS.concat(STAFF_LEDGER_LOW, STAFF_LEDGER_HIGH);
  const found = pool.find(p => p.noteName === noteName && p.octave === octave);
  return found ? found.y : null;
}

function updateStaffClefSymbols() {
  const trebleChar = "\uD834\uDD1E"; // ùÑû
  const bassChar   = "\uD834\uDD22"; // ùÑ¢
  const symbol = (currentClef === CLEF_BASS) ? bassChar : trebleChar;
  const clefNodes = document.querySelectorAll(".clef-symbol");
  clefNodes.forEach(el => {
    el.textContent = symbol;
    // Dimensioni diverse per le due chiavi, adattate al pentagramma 5:1:
    // - Violino: ~115 (centro sulla seconda linea dal basso)
    // - Basso:   ~58, un po' pi√π piccolo e pi√π in alto
    if (currentClef === CLEF_BASS) {
      el.setAttribute("font-size", "58");
      el.setAttribute("y", "133");  // posizione adattata per la chiave di FA
    } else {
      el.setAttribute("font-size", "115");
      el.setAttribute("y", "164");  // chiave di SOL centrata sulla seconda linea dal basso
    }
  });
  const dots=document.querySelectorAll('.bass-dot');
  dots.forEach(d=>{ if(currentClef==="bass"){ d.style.display="none";} else { d.style.display="block";}});

}

/* ===========================
   GIOCATORE (nome + genere)
   =========================== */
let playerName = "";
let playerGender = "M";

function getNameFragment() {
  return playerName ? " " + playerName : "";
}

function setNormalOverlayTexts(level) {
  const nameFrag = getNameFragment();
  const g = playerGender;

  if (level === 1) {
    const mainEl = document.getElementById("rainbowOverlayL1Main");
    const subEl  = document.getElementById("rainbowOverlayL1Sub");
    if (!mainEl || !subEl) return;
    mainEl.textContent = (g === "F" ? "Brava" : "Bravo") + nameFrag + "!";
    subEl.textContent = "Hai colorato tutte le note. Ora ascolta la tua melodia.";
  } else if (level === 2) {
    const mainEl = document.getElementById("rainbowOverlayL2Main");
    const subEl  = document.getElementById("rainbowOverlayL2Sub");
    if (!mainEl || !subEl) return;
    mainEl.textContent = (g === "F" ? "Brava" : "Bravo") + nameFrag + ", che orecchio!";
    subEl.textContent = "Hai indovinato tutte le note. Ora ascolta la melodia.";
  } else if (level === 3) {
    const mainEl = document.getElementById("rainbowOverlayL3Main");
    const subEl  = document.getElementById("rainbowOverlayL3Sub");
    if (!mainEl || !subEl) return;
    mainEl.textContent = (g === "F" ? "Brava" : "Bravo") + nameFrag + ", che memoria musicale!";
    subEl.textContent = "Hai riconosciuto tutte le note. Ora ascolta la melodia.";
  } else if (level === 4) {
    const mainEl = document.getElementById("rainbowOverlayL4Main");
    const subEl  = document.getElementById("rainbowOverlayL4Sub");
    if (!mainEl || !subEl) return;
    mainEl.textContent = (g === "F" ? "Brava" : "Bravo") + nameFrag + ", che ritmo perfetto!";
    subEl.textContent = "Hai suonato tutto a tempo. Ora ascolta la melodia.";
  }
}
function setFinalOverlayTexts(level) {
  const nameFrag = getNameFragment();
  const g = playerGender;

  if (level === 1) {
    const mainEl = document.getElementById("finalOverlayL1Main");
    const subEl  = document.getElementById("finalOverlayL1Sub");
    if (!mainEl || !subEl) return;
    mainEl.textContent = "Livello 1 completato!";
    subEl.textContent = (g === "F"
      ? "Brava" + nameFrag + "! Hai vinto 10 medaglie di rame. Ora passi al secondo livello!"
      : "Bravo" + nameFrag + "! Hai vinto 10 medaglie di rame. Ora passi al secondo livello!");
  } else if (level === 2) {
    const mainEl = document.getElementById("finalOverlayL2Main");
    const subEl  = document.getElementById("finalOverlayL2Sub");
    if (!mainEl || !subEl) return;
    mainEl.textContent = "Livello 2 completato!";
    subEl.textContent = (g === "F"
      ? "Brava" + nameFrag + "! Hai vinto 10 medaglie d‚Äôargento. Ora passi al terzo livello!"
      : "Bravo" + nameFrag + "! Hai vinto 10 medaglie d‚Äôargento. Ora passi al terzo livello!");
  } else if (level === 3) {
    const mainEl = document.getElementById("finalOverlayL3Main");
    const subEl  = document.getElementById("finalOverlayL3Sub");
    if (!mainEl || !subEl) return;
    mainEl.textContent = "Tutti i livelli completati!";
    subEl.textContent = (g === "F"
      ? "Brava" + nameFrag + "! Hai vinto 10 medaglie d‚Äôoro. Puoi continuare a giocare quanto vuoi!"
      : "Bravo" + nameFrag + "! Hai vinto 10 medaglie d‚Äôoro. Puoi continuare a giocare quanto vuoi!");
  }
}

/* ===========================
   VARIABILI GLOBALI TROFEI
   =========================== */
/* ===========================
   SCRIGNI DI SESSIONE (LOCALSTORAGE)
   =========================== */
const SESSIONS_KEY = "musicRainbowChests";
let sessions = [];
let currentSessionId = null;

const CHEST_COUNTER_KEY = "musicRainbowChestCounter";
let lastChestNumber = 0;

function loadSessionsFromStorage() {
  try {
    const raw = localStorage.getItem(SESSIONS_KEY);
    if (!raw) {
      sessions = [];
    } else {
      const parsed = JSON.parse(raw);
      if (Array.isArray(parsed)) {
        sessions = parsed;
      } else {
        sessions = [];
      }
    }

    // Carica il contatore globale degli scrigni
    const rawCounter = localStorage.getItem(CHEST_COUNTER_KEY);
    if (rawCounter) {
      const parsedCounter = parseInt(rawCounter, 10);
      if (!isNaN(parsedCounter) && parsedCounter > 0) {
        lastChestNumber = parsedCounter;
      }
    }

    // Assegna numeri sequenziali agli scrigni non vuoti che non hanno ancora un numero di visualizzazione
    const nonEmptyWithoutNumber = sessions
      .filter(s => ((s.bronze || 0) + (s.silver || 0) + (s.gold || 0)) > 0 && typeof s.displayNumber !== "number")
      .sort((a, b) => a.id - b.id);

    nonEmptyWithoutNumber.forEach(s => {
      lastChestNumber++;
      s.displayNumber = lastChestNumber;
    });

  } catch (e) {
    console.warn("Errore nel leggere gli scrigni:", e);
    sessions = [];
    lastChestNumber = 0;
  }
}

function saveSessionsToStorage() {
  try {
    localStorage.setItem(SESSIONS_KEY, JSON.stringify(sessions));
    localStorage.setItem(CHEST_COUNTER_KEY, String(lastChestNumber || 0));
  } catch (e) {
    console.warn("Errore nel salvare gli scrigni:", e);
  }
}

function startNewSessionChest() {
  // Crea sempre una nuova sessione quando si parte a giocare da Home
  const nextId = sessions.length ? (sessions[sessions.length - 1].id + 1) : 1;
  const newSession = {
    id: nextId,
    createdAt: Date.now(),
    bronze: 0,
    silver: 0,
    gold: 0,
    tokens: 0,
    tokenMedalCount: 0
  };
  sessions.push(newSession);
  saveSessionsToStorage();
  currentSessionId = newSession.id;
}


function getCurrentSessionChest() {
  if (!currentSessionId) return null;
  return sessions.find(s => s.id === currentSessionId) || null;
}

function incrementSessionMedal(type) {
  if (!currentSessionId) return;
  const s = sessions.find(sess => sess.id === currentSessionId);
  if (!s) return;

  const hadMedalsBefore =
    ((s.bronze || 0) + (s.silver || 0) + (s.gold || 0) + (s.green || 0)) > 0;

  if (type === "bronze") {
    s.bronze = (s.bronze || 0) + 1;
  } else if (type === "silver") {
    s.silver = (s.silver || 0) + 1;
  } else if (type === "gold") {
    s.gold = (s.gold || 0) + 1;
  } else if (type === "green") {
    s.green = (s.green || 0) + 1;
  }

  const hasMedalsNow =
    ((s.bronze || 0) + (s.silver || 0) + (s.gold || 0) + (s.green || 0)) > 0;

  if (!hadMedalsBefore && hasMedalsNow && typeof s.displayNumber !== "number") {
    lastChestNumber++;
    s.displayNumber = lastChestNumber;
  }

  saveSessionsToStorage();
}

function clearAllSessionChests() {
  sessions = [];
  currentSessionId = null;
  lastChestNumber = 0;
  try {
    localStorage.removeItem(SESSIONS_KEY);
    localStorage.removeItem(CHEST_COUNTER_KEY);
  } catch (e) {
    console.warn("Errore nel cancellare gli scrigni:", e);
  }
}

let totalBronze = 0;
let totalSilver = 0;
let totalGold   = 0;

const rainbowCountElL1   = document.getElementById("rainbowCountL1");
const rainbowCountEl     = document.getElementById("rainbowCount");
const rainbowCountElL3   = document.getElementById("rainbowCountL3");
const rainbowCountElPlay = document.getElementById("rainbowCountPlay");

const TOKENS_KEY = "musicRainbowPlayTokens";


// ===========================
//   GETTONI PLAY (persistenti)
// ===========================
let mintedTokens = 0;      // gettoni guadagnati in questa esecuzione
let spentTokens  = 0;      // gettoni usati
let lastTotalMedalsForTokens = 0; // conteggio medaglie alla precedente verifica

function loadTokensFromStorage() {
  try {
    const raw = localStorage.getItem(TOKENS_KEY);
    if (!raw) return;
    const data = JSON.parse(raw);
    if (!data || typeof data !== "object") return;

    if (typeof data.minted === "number") {
      mintedTokens = data.minted;
    }
    if (typeof data.spent === "number") {
      spentTokens = data.spent;
    }
    if (typeof data.lastTotal === "number") {
      lastTotalMedalsForTokens = data.lastTotal;
    }
  } catch (e) {
    console.warn("Errore nel leggere i gettoni Play:", e);
  }
}

function saveTokensToStorage() {
  try {
    const data = {
      minted: mintedTokens || 0,
      spent: spentTokens || 0,
      lastTotal: lastTotalMedalsForTokens || 0
    };
    localStorage.setItem(TOKENS_KEY, JSON.stringify(data));
  } catch (e) {
    console.warn("Errore nel salvare i gettoni Play:", e);
  }
}


function getAvailableTokens() {
  const s = getCurrentSessionChest();
  if (!s) return 0;
  const tokens = typeof s.tokens === "number" ? s.tokens : 0;
  return Math.max(0, tokens);
}

function getTokenSvgMarkup(className) {
  const cls = className || "token-svg";
  return '<svg class="' + cls + '" viewBox="0 0 100 100" aria-hidden="true">'
    + '<circle cx="50" cy="50" r="45" fill="#facc15" stroke="#92400e" stroke-width="4"/>'
    + '<circle cx="50" cy="50" r="35" fill="#fde68a" stroke="#fbbf24" stroke-width="3"/>'
    + '<rect x="30" y="27" width="4" height="46" fill="#eab308"/>'
    + '<rect x="47" y="27" width="4" height="46" fill="#eab308"/>'
    + '<rect x="63" y="27" width="4" height="46" fill="#eab308"/>'
    + '</svg>';
}

function showTokenWonPopup() {
  const overlay = document.getElementById("tokenOverlay");
  if (!overlay) return;
  overlay.classList.add("active");
  setTimeout(() => {
    overlay.classList.remove("active");
  }, 2200);
}


function checkForNewToken() {
  const s = getCurrentSessionChest();
  if (!s) return;

  const prevTotal = typeof s.tokenMedalCount === "number" ? s.tokenMedalCount : 0;
  const currentTotal = (s.bronze || 0)
    + (s.silver || 0)
    + (s.gold   || 0)
    + (s.green  || 0);
  s.tokenMedalCount = currentTotal;

  const prevFloor = Math.floor(prevTotal / 5);
  const newFloor  = Math.floor(currentTotal / 5);
  if (newFloor > prevFloor) {
    const gained = newFloor - prevFloor;
    const currentTokens = typeof s.tokens === "number" ? s.tokens : 0;
    s.tokens = currentTokens + gained;
    showTokenWonPopup();
    saveSessionsToStorage();
    updateTokensUIAll();

  }
}

function renderTokensPanel(panelId) {
  const panel = document.getElementById(panelId);
  if (!panel) return;
  const available = getAvailableTokens();
  panel.innerHTML = "";
  if (available <= 0) {
    const empty = document.createElement("div");
    empty.className = "trophy-empty";
    empty.textContent = "Nessun gettone";
    panel.appendChild(empty);
    return;
  }
  const label = document.createElement("div");
  label.className = "token-label";
  label.textContent = "Gettoni:";
  panel.appendChild(label);

  for (let i = 0; i < available; i++) {
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "token-icon-btn";
    btn.innerHTML = getTokenSvgMarkup();
    btn.addEventListener("click", handleTokenClick);
    panel.appendChild(btn);
  }
}

function renderTokensInTrophyPage() {
  const row = document.getElementById("trophyTokensRow");
  if (!row) return;
  const available = getAvailableTokens();
  row.innerHTML = "";
  if (available <= 0) {
    const empty = document.createElement("div");
    empty.className = "trophy-empty";
    empty.textContent = "Nessun gettone Play disponibile.";
    row.appendChild(empty);
    return;
  }

  for (let i = 0; i < available; i++) {
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "token-icon-btn trophy-token-btn";
    // svg con classe token-svg (poi resa 3x via CSS nella bacheca)
    btn.innerHTML = getTokenSvgMarkup("token-svg");
    btn.addEventListener("click", handleTokenClick);
    row.appendChild(btn);
  }
}

function updateTokensUIAll() {
  renderTokensPanel("tokensPanelL1");
  renderTokensPanel("tokensPanelL2");
  renderTokensPanel("tokensPanelL3");
  renderTokensInTrophyPage();
}




function spendTokenFromSession(sessionId) {
  // Trova la sessione corrispondente allo scrigno
  const s = sessions.find(sess => sess.id === sessionId);
  if (!s) return;
  const available = typeof s.tokens === "number" ? s.tokens : 0;
  if (available <= 0) return;

  // Se c'√® gi√† una sessione Play attiva, avvisa e non consumare nulla
  if (playSessionActive) {
    alert("Hai gi√† una sessione Play attiva.");
    return;
  }

  const ok = window.confirm("Vuoi usare il gettone Play di questo scrigno?");
  if (!ok) return;

  // Scala di uno i gettoni di quello scrigno
  s.tokens = available - 1;
  saveSessionsToStorage();

  // Aggiorna tutta l'interfaccia che mostra i gettoni
  if (typeof updateTokensUIAll === "function") {
    updateTokensUIAll();
  }

  // Chiudi l'eventuale popup dello scrigno
  if (typeof trophyOverlayEl !== "undefined" && trophyOverlayEl) {
    trophyOverlayEl.classList.remove("active");
  }

  // Avvia la modalit√† Play usando il gettone
  if (typeof openPlayPageFromToken === "function") {
    openPlayPageFromToken();
  }
}


function handleTokenClick() {
  const s = getCurrentSessionChest();
  if (!s) return;
  spendTokenFromSession(s.id);
}

// ===========================
//   TIMER MODALIT√Ä PLAY (5 minuti)
// ===========================
let testPlayUnlocked = false;
let playTimerSeconds = 0;
let playTimerIntervalId = null;
let playSessionActive = false;

function updateHomePlayButtonState() {
  if (!homePlayBtn) return;
  homePlayBtn.classList.remove("home-play-active", "home-play-disabled");

  const canPlay = playSessionActive || testPlayUnlocked;

  if (canPlay) {
    homePlayBtn.disabled = false;
    homePlayBtn.classList.add("home-play-active");
  } else {
    homePlayBtn.disabled = true;
    homePlayBtn.classList.add("home-play-disabled");
  }
}

function formatSeconds(sec) {
  const m = Math.floor(sec / 60);
  const s = sec % 60;
  const mm = String(m).padStart(2,"0");
  const ss = String(s).padStart(2,"0");
  return mm + ":" + ss;
}

function updatePlayTimerDisplay() {
  const el = document.getElementById("playTimerText");
  if (!el) return;
  el.textContent = formatSeconds(playTimerSeconds);
}

function stopPlaySession(resetToZero) {
  playSessionActive = false;
  if (playTimerIntervalId) clearInterval(playTimerIntervalId);
  playTimerIntervalId = null;
  if (resetToZero) {
    playTimerSeconds = 0;
    updatePlayTimerDisplay();
  }
  updateHomePlayButtonState();
}

function endPlaySessionTimeUp() {
  stopPlaySession(false);
  const overlay = document.getElementById("playTimeupOverlay");
  const playVisible = playPageEl && playPageEl.style.display !== "none";
  if (overlay && playVisible) {
    overlay.classList.add("active");
    setTimeout(() => {
      overlay.classList.remove("active");
      if (playPageEl) playPageEl.style.display = "none";
      if (lastGamePageId === "level1Page") {
        if (level1PageEl) level1PageEl.style.display = "flex";
      } else if (lastGamePageId === "level3Page") {
        if (level3PageEl) level3PageEl.style.display = "flex";
      } else {
        if (level2PageEl) level2PageEl.style.display = "flex";
        lastGamePageId = "level2Page";
      }
    }, 2500);
  } else {
    if (playPageEl) playPageEl.style.display = "none";
    if (lastGamePageId === "level1Page") {
      if (level1PageEl) level1PageEl.style.display = "flex";
    } else if (lastGamePageId === "level3Page") {
      if (level3PageEl) level3PageEl.style.display = "flex";
    } else {
      if (level2PageEl) level2PageEl.style.display = "flex";
      lastGamePageId = "level2Page";
    }
  }
}

function startPlaySession() {
  playTimerSeconds = 300;
  playSessionActive = true;
  const overlay = document.getElementById("playTimeupOverlay");
  if (overlay) overlay.classList.remove("active");
  updatePlayTimerDisplay();
  updateHomePlayButtonState();
  if (playTimerIntervalId) clearInterval(playTimerIntervalId);
  playTimerIntervalId = setInterval(() => {
    playTimerSeconds--;
    if (playTimerSeconds <= 0) {
      playTimerSeconds = 0;
      updatePlayTimerDisplay();
      endPlaySessionTimeUp();
    } else {
      updatePlayTimerDisplay();
    }
  }, 1000);
}

// Apertura pagina Play solo tramite gettone
function openPlayPageFromToken() {
  const homeScreen = document.getElementById("homeScreen");
  if (homeScreen) homeScreen.style.display = "none";
  if (trophyPageEl) trophyPageEl.style.display = "none";
  if (level1PageEl) level1PageEl.style.display = "none";
  if (level2PageEl) level2PageEl.style.display = "none";
  if (level3PageEl) level3PageEl.style.display = "none";
  if (playPageEl) {
    playPageEl.style.display = "flex";
    clearPlayStaff();
    startPlaySession();
  }
}


function getTotalMedalsCount() {
  return totalBronze + totalSilver + totalGold;
}

function updateRainbowCountersGlobal() {
  const total = getTotalMedalsCount();
  if (rainbowCountElL1)   rainbowCountElL1.textContent   = total;
  if (rainbowCountEl)     rainbowCountEl.textContent     = total;
  if (rainbowCountElL3)   rainbowCountElL3.textContent   = total;
  if (rainbowCountElPlay) rainbowCountElPlay.textContent = total;
}

/* ===========================
   LIVELLO 1
   =========================== */

const staffSvgL1    = document.getElementById("staffSvgL1");
const statusBarElL1 = document.getElementById("statusBarL1");
const errorPillL1   = document.getElementById("errorPillL1");
const resetBtnL1    = document.getElementById("resetBtnL1");
const rainbowWinIndexL1 = document.getElementById("rainbowWinIndexL1");
const medalsPanelL1  = document.getElementById("medalsPanelL1");
const rainbowOverlayL1 = document.getElementById("rainbowOverlayL1");
const finalOverlayL1 = document.getElementById("finalOverlayL1");
const noteButtonsL1 = document.querySelectorAll("#level1Page .note-button");
const level1PageEl  = document.getElementById("level1Page");
const level2PageEl  = document.getElementById("level2Page");
const level3PageEl  = document.getElementById("level3Page");
const playPageEl    = document.getElementById("playPage");
const trophyPageEl  = document.getElementById("trophyPage");
const autoColorToggleL1 = document.getElementById("autoColorToggleL1");

let currentNotesL1 = [];
let currentIndexL1 = 0;
let rainbowsL1 = 0;
let consecutiveErrorsL1 = 0;
const MAX_CONSECUTIVE_ERRORS_L1 = 5;
let selectedColorL1 = null;
let autoColorL1 = true;

/* Suggerimento L1 */
let hintCircleL1 = null;
let hintTimeoutL1 = null;
let hintCountL1 = 0;
const MAX_HINTS_L1 = 5;
let hintBtnL1El = null;

function clearHintL1() {
  // Rimuove eventuali effetti di suggerimento attivi
  if (hintCircleL1) {
    hintCircleL1.remove();
    hintCircleL1 = null;
  }
  if (hintTimeoutL1) {
    clearTimeout(hintTimeoutL1);
    hintTimeoutL1 = null;
  }
  if (typeof noteButtonsL1 !== "undefined" && noteButtonsL1) {
    noteButtonsL1.forEach(btn => btn.classList.remove("hint-glow"));
  }
}

function showHintL1() {
  // Nuova logica suggerimento livello 1:
  // illumina il tasto corrispondente alla nota corrente.
  if (!currentNotesL1.length) return;
  if (currentIndexL1 >= currentNotesL1.length) return;

  const target = currentNotesL1[currentIndexL1];
  clearHintL1();

  if (typeof noteButtonsL1 !== "undefined" && noteButtonsL1) {
    const btn = Array.from(noteButtonsL1).find(b => b.dataset.note === target.noteName);
    if (btn) {
      btn.classList.add("hint-glow");
      hintTimeoutL1 = setTimeout(() => {
        btn.classList.remove("hint-glow");
      }, 2200);
    }
  }
}

function updateHintLabelL1() {
  if (!hintBtnL1El) return;
  const remaining = Math.max(0, MAX_HINTS_L1 - hintCountL1);
  hintBtnL1El.innerHTML = `üí° ${remaining}`;
}

function handleHintClickL1() {
  if (!hintBtnL1El) return;
  if (hintCountL1 >= MAX_HINTS_L1) return;

  // Animazione: il tasto suggerimento si ingrandisce del 10%
  hintBtnL1El.classList.add("hint-pulse");
  setTimeout(() => {
    if (hintBtnL1El) {
      hintBtnL1El.classList.remove("hint-pulse");
    }
  }, 180);

  showHintL1();
  hintCountL1++;
  updateHintLabelL1();

  if (hintCountL1 >= MAX_HINTS_L1) {
    hintBtnL1El.disabled = true;
  }
}

if (autoColorToggleL1) {
  autoColorToggleL1.addEventListener("change", () => {
    autoColorL1 = autoColorToggleL1.checked;
  });
}

function getNoteCountL1() {
  const base = 5;
  return base + rainbowsL1;
}

function updateStatusL1() {
  updateErrorPill(errorPillL1, consecutiveErrorsL1, 7);
}

function setSelectedColorL1(noteName) {
  selectedColorL1 = noteName;
  noteButtonsL1.forEach(btn => {
    if (btn.dataset.note === noteName) btn.classList.add("selected");
    else btn.classList.remove("selected");
  });
}

function createNotesL1() {
  const count = getNoteCountL1();
  let pool = STAFF_CORE_POSITIONS.slice();

// determinare medaglie totali
let totalMedals = 0;
try {
  if (Array.isArray(sessions)) {
    totalMedals = sessions.reduce((acc,s)=>acc + (s.bronze||0) + (s.silver||0) + (s.gold||0), 0);
  }
} catch(e){}

  staffSvgL1.querySelectorAll(".note-circle, .error-x, .ledger-line").forEach(e => e.remove());
  clearHintL1();
  currentNotesL1 = [];
  currentIndexL1 = 0;
  consecutiveErrorsL1 = 0;
  updateStatusL1();

  if (hintBtnL1El) {
    hintBtnL1El.disabled = (hintCountL1 >= MAX_HINTS_L1);
    updateHintLabelL1();
  }

  const startX = 180;
  const endX = 820;
  const step = (endX - startX) / Math.max(1, (count - 1));

  let lastName = null;
  let lastOct = null;

  for (let i = 0; i < count; i++) {
    let p;
    let safety = 0;
    do {
      p = pool[Math.floor(Math.random() * pool.length)];
      safety++;
    } while (
      safety < 50 &&
      lastName !== null &&
      p.noteName === lastName &&
      p.octave === lastOct
    );

    let cx = startX + step * i;
    // Prima nota: spostata 10px a destra
    if (i === 0) { cx += 10;
    }
    // Ultima nota: spostata 10px a sinistra
    if (i === count - 1) {
      cx -= 10;
    }
    const cy = p.y;

    const noteName = p.noteName;
    const octave = p.octave;
    lastName = noteName;
    lastOct = octave;

    const baseFreq = NOTE_FREQS[noteName] || 440;
    const freq = baseFreq * (octave === 2 ? 2 : 1);

    const circle = document.createElementNS("http://www.w3.org/2000/svg","circle");
    circle.setAttribute("cx", cx);
    circle.setAttribute("cy", cy);
    circle.setAttribute("r", 9);
    circle.classList.add("note-circle");
    circle.dataset.noteName = noteName;
    circle.dataset.octave = octave;
    staffSvgL1.appendChild(circle);

    const obj = { element: circle, cx, cy, noteName, octave, freq, solved: false };
    currentNotesL1.push(obj);

    circle.onclick = () => {
      playTone(freq);
      handleAnswerL1(obj);
    };
  }

  currentNotesL1.sort((a,b) => a.cx - b.cx);
  setCurrentTargetL1();
}

function setCurrentTargetL1() {
  currentNotesL1.forEach(n => n.element.classList.remove("target"));
  while (currentIndexL1 < currentNotesL1.length && currentNotesL1[currentIndexL1].solved) currentIndexL1++;
  if (currentIndexL1 >= currentNotesL1.length) {
    showRainbowL1();
    return;
  }
  currentNotesL1[currentIndexL1].element.classList.add("target");
  updateStatusL1();
}

function softResetLevel1() {
  if (!staffSvgL1) return;
  currentIndexL1 = 0;
  consecutiveErrorsL1 = 0;
  createNotesL1();
}

function handleAnswerL1(clickedNoteObj) {
  if (currentIndexL1 >= currentNotesL1.length) return;
  const target = currentNotesL1[currentIndexL1];

  if (clickedNoteObj !== target) {
    playError();
    consecutiveErrorsL1++;
    updateStatusL1();
    if (consecutiveErrorsL1 >= MAX_CONSECUTIVE_ERRORS_L1) {
      // Dopo troppi errori consecutivi, il livello 1 ricomincia con un nuovo spartito
      setTimeout(() => { softResetLevel1(); }, 650);
    }
    const x = document.createElementNS("http://www.w3.org/2000/svg","text");
    x.setAttribute("x", clickedNoteObj.cx + 12);
    x.setAttribute("y", clickedNoteObj.cy + 6);
    x.classList.add("error-x");
    x.textContent = "‚úó";
    staffSvgL1.appendChild(x);
    setTimeout(() => x.remove(), 600);
    return;
  }

  if (!selectedColorL1) {
    playError();
    consecutiveErrorsL1++;
    updateStatusL1();
    if (consecutiveErrorsL1 >= MAX_CONSECUTIVE_ERRORS_L1) {
      // Dopo troppi errori consecutivi, il livello 1 ricomincia con un nuovo spartito
      setTimeout(() => { softResetLevel1(); }, 650);
    }
    const x = document.createElementNS("http://www.w3.org/2000/svg","text");
    x.setAttribute("x", target.cx + 12);
    x.setAttribute("y", target.cy + 6);
    x.classList.add("error-x");
    x.textContent = "‚úó";
    staffSvgL1.appendChild(x);
    setTimeout(() => x.remove(), 600);
    return;
  }

  
  if (selectedColorL1 === target.noteName) {
    const col = getNoteColor(target.noteName);

    // Colora il pallino con il colore della nota
    target.element.classList.remove("target");
    try {
      if (target.element.setAttribute) {
        target.element.setAttribute("fill", col);
        target.element.setAttribute("stroke", col);
      } else {
        target.element.style.fill = col;
        target.element.style.stroke = col;
      }
    } catch (e) {
      target.element.style.fill = col;
      target.element.style.stroke = col;
    }

    // Effetto flash + pulsazione semplice compatibile anche su iPad (senza CSS filter/transform)
    const baseR = parseFloat(target.element.getAttribute("r") || "6");
    const baseStroke = parseFloat(target.element.getAttribute("stroke-width") || "2.4");

    const pulses = [
      { r: baseR * 1.5, sw: baseStroke + 3 },
      { r: baseR * 1.0, sw: baseStroke },
      { r: baseR * 1.3, sw: baseStroke + 2 },
      { r: baseR * 1.0, sw: baseStroke }
    ];

    let step = 0;
    function applyPulse() {
      if (!target.element) return;
      if (step >= pulses.length) return;
      const p = pulses[step++];
      target.element.setAttribute("r", p.r);
      target.element.setAttribute("stroke-width", p.sw);
      setTimeout(applyPulse, 90);
    }
    applyPulse();

    target.solved = true;
    const noteDurationMs = (target.beats || 1) * getBeatIntervalMsL4();
    playTone(target.freq, noteDurationMs);
    consecutiveErrorsL1 = 0;
    currentIndexL1++;
    setTimeout(setCurrentTargetL1, 250);
  } else {

    playError();
    consecutiveErrorsL1++;
    updateStatusL1();
    if (consecutiveErrorsL1 >= MAX_CONSECUTIVE_ERRORS_L1) {
      // Dopo troppi errori consecutivi, il livello 1 ricomincia con un nuovo spartito
      setTimeout(() => { softResetLevel1(); }, 650);
    }
    const x = document.createElementNS("http://www.w3.org/2000/svg","text");
    x.setAttribute("x", target.cx + 12);
    x.setAttribute("y", target.cy + 6);
    x.classList.add("error-x");
    x.textContent = "‚úó";
    staffSvgL1.appendChild(x);
    setTimeout(() => x.remove(), 600);
  }
}

function handleAutoColorL1(colorNoteName) {
  if (currentIndexL1 >= currentNotesL1.length) return;
  const target = currentNotesL1[currentIndexL1];

  if (colorNoteName === target.noteName) {
    const col = getNoteColor(target.noteName);
    target.element.style.fill = col;
    target.element.classList.remove("target");
    target.element.style.stroke = "#111827";
    target.element.style.filter = "none";
    target.element.style.strokeWidth = 2;
    target.solved = true;
    const noteDurationMs = (target.beats || 1) * getBeatIntervalMsL4();
    playTone(target.freq, noteDurationMs);
    consecutiveErrorsL1 = 0;
    currentIndexL1++;
    setTimeout(setCurrentTargetL1, 250);
  } else {
    playError();
    consecutiveErrorsL1++;
    updateStatusL1();
    if (consecutiveErrorsL1 >= MAX_CONSECUTIVE_ERRORS_L1) {
      // Dopo troppi errori consecutivi, il livello 1 ricomincia con un nuovo spartito
      setTimeout(() => { softResetLevel1(); }, 650);
    }
    const x = document.createElementNS("http://www.w3.org/2000/svg","text");
    x.setAttribute("x", target.cx + 12);
    x.setAttribute("y", target.cy + 6);
    x.classList.add("error-x");
    x.textContent = "‚úó";
    staffSvgL1.appendChild(x);
    setTimeout(() => x.remove(), 600);
  }
}

function addMedalIconL1(index) {
  const medal = document.createElement("div");
  medal.className = "medal-icon bronze";
  medal.textContent = index;
  medalsPanelL1.appendChild(medal);
}

function playVictoryMelodyL1() {
  if (!currentNotesL1.length) return 0;

  const step = MELODY_STEP_MS;

  // prepara stato jingle per LIVELLO 1
  clearJingleTimeouts();
  isJinglePlaying = true;
  currentJingleLevel = 1;

  currentNotesL1.forEach((n, idx) => {
    const delay = idx * step;
    const timeoutId = setTimeout(() => {
      if (!isJinglePlaying || currentJingleLevel !== 1) return;
      playTone(n.freq);
    }, delay);
    activeJingleTimeouts.push(timeoutId);
  });

  const totalMs = step * currentNotesL1.length;
  const endId = setTimeout(() => {
    if (currentJingleLevel === 1) {
      isJinglePlaying = false;
    }
    clearJingleTimeouts();
  }, totalMs + 120);
  activeJingleTimeouts.push(endId);

  return totalMs;
}

function showRainbowL1() {
  rainbowsL1++;
  totalBronze++;
  incrementSessionMedal("bronze");

  if (rainbowWinIndexL1) rainbowWinIndexL1.textContent = rainbowsL1;
  addMedalIconL1(rainbowsL1);
  consecutiveErrorsL1 = 0;
  updateStatusL1();
  updateRainbowCountersGlobal();
  checkForNewToken();

  const totalDuration = MELODY_STEP_MS * currentNotesL1.length + 600;

  if (rainbowsL1 >= 10) {
    setFinalOverlayTexts(1);
    finalOverlayL1.classList.add("active");
    playVictoryMelodyL1();
    if (typeof nextScoreTimeoutL1 !== "undefined" && nextScoreTimeoutL1) {
      clearTimeout(nextScoreTimeoutL1);
      nextScoreTimeoutL1 = null;
    }
    nextScoreTimeoutL1 = setTimeout(() => {
      finalOverlayL1.classList.remove("active");
      level1PageEl.style.display = "none";
      level2PageEl.style.display = "flex";
      level3PageEl.style.display = "none";
      playPageEl.style.display  = "none";
      lastGamePageId = "level2Page";
      softResetLevel2();
      nextScoreTimeoutL1 = null;
    }, totalDuration);
  } else {
    setNormalOverlayTexts(1);
    rainbowOverlayL1.classList.add("active");
    playVictoryMelodyL1();
    if (typeof nextScoreTimeoutL1 !== "undefined" && nextScoreTimeoutL1) {
      clearTimeout(nextScoreTimeoutL1);
      nextScoreTimeoutL1 = null;
    }
    nextScoreTimeoutL1 = setTimeout(() => {
      rainbowOverlayL1.classList.remove("active");
      createNotesL1();
      nextScoreTimeoutL1 = null;
    }, totalDuration);
  }
}

function animateNoteButtonPressL1(btn) {
  if (!btn) return;
  btn.classList.add("note-pressed");
  setTimeout(() => {
    btn.classList.remove("note-pressed");
  }, 300);
}

noteButtonsL1.forEach(btn => {
  btn.addEventListener("click", () => {
    // Animazione "pressione verso il basso" per il Livello 1
    animateNoteButtonPressL1(btn);

    const note = btn.dataset.note;
    const freq = NOTE_FREQS[note] || 440;
    playTone(freq);
    setSelectedColorL1(note);
    if (autoColorL1) handleAutoColorL1(note);
  });
});

if (staffSvgL1) {
  createNotesL1();
  updateStatusL1();
}

/* ===========================
   LIVELLO 2
   =========================== */

const staffSvg    = document.getElementById("staffSvg");
const statusBarEl = document.getElementById("statusBar");
const errorPillL2 = document.getElementById("errorPillL2");
const pianoKeysEl = document.getElementById("pianoKeys");
const resetBtn    = document.getElementById("resetBtn");
const rainbowWinIndex = document.getElementById("rainbowWinIndex");
const medalsPanel  = document.getElementById("medalsPanel");
const rainbowOverlay = document.getElementById("rainbowOverlay");
const finalOverlayL2 = document.getElementById("finalOverlayL2");

let currentNotes = [];
let currentIndex = 0;
let rainbows = 0;
let consecutiveErrors = 0;
const MAX_CONSECUTIVE_ERRORS_L2 = 5;

function getNoteCount() {
  const base = 10;
  const increment = 1;
  const max = 24;
  return Math.min(base + rainbows * increment, max);
}

function getLevel() {
  return (rainbows >= 10) ? 2 : 1;
}

function updateStatus() {
  updateErrorPill(errorPillL2, consecutiveErrors, 7);
}

function playVictoryMelody() {
  if (!currentNotes.length) return 0;

  const step = MELODY_STEP_MS;

  // prepara stato jingle per LIVELLO 2
  clearJingleTimeouts();
  isJinglePlaying = true;
  currentJingleLevel = 2;

  currentNotes.forEach((n, idx) => {
    const delay = idx * step;
    const timeoutId = setTimeout(() => {
      if (!isJinglePlaying || currentJingleLevel !== 2) return;
      playTone(n.freq);
    }, delay);
    activeJingleTimeouts.push(timeoutId);
  });

  const totalMs = step * currentNotes.length;
  const endId = setTimeout(() => {
    if (currentJingleLevel === 2) {
      isJinglePlaying = false;
    }
    clearJingleTimeouts();
  }, totalMs + 120);
  activeJingleTimeouts.push(endId);

  return totalMs;
}


function animateKeyPress(keyEl) {
  if (!keyEl) return;

  const isLevel2Key = !!keyEl.closest("#level2Page");
  const isLevel3Key = !!keyEl.closest("#level3Page");
  const isLevel4Key = !!keyEl.closest("#level4Page");
  const isGamePianoKey = isLevel2Key || isLevel3Key || isLevel4Key;

  let prevBoxShadow = null;
  let prevFilter = null;

  if (isGamePianoKey) {
    prevBoxShadow = keyEl.style.boxShadow;
    prevFilter = keyEl.style.filter;

    // Colore del bagliore basato sulla nota (do, re, mi, fa, sol, la, si)
    let noteName = (keyEl.dataset.noteName || "").toLowerCase();
    // Normalizza: "do#", "do‚ôØ" -> "do"
    noteName = noteName.replace("‚ôØ", "").replace("#", "");

    let glowColor = "#f97316"; // default arancione RE
    switch (noteName) {
      case "do":  glowColor = "#ef4444"; break; // rosso
      case "re":  glowColor = "#f97316"; break; // arancione
      case "mi":  glowColor = "#eab308"; break; // giallo
      case "fa":  glowColor = "#22c55e"; break; // verde
      case "sol": glowColor = "#38bdf8"; break; // azzurro
      case "la":  glowColor = "#a855f7"; break; // viola
      case "si":  glowColor = "#4f46e5"; break; // blu
    }

    // Glow quasi totalmente del colore della nota (la luce bianca √® minima)
    keyEl.style.boxShadow =
      "0 0 14px " + glowColor + "," +
      "0 0 32px " + glowColor + "," +
      "inset 0 0 3px rgba(255,255,255,0.05)";
    keyEl.style.filter = "brightness(1.05)";
  }

  keyEl.classList.add("key-pressed");
  setTimeout(() => {
    keyEl.classList.remove("key-pressed");
    if (isGamePianoKey) {
      keyEl.style.boxShadow = prevBoxShadow;
      keyEl.style.filter = prevFilter;
    }
  }, 300);
}
function renderPiano() {
  pianoKeysEl.innerHTML = "";
  const whiteNotesOrder = ["do","re","mi","fa","sol","la","si"];
  const totalWhite = 14;

  for (let octave = 1; octave <= 2; octave++) {
    whiteNotesOrder.forEach(noteName => {
      const label = noteName.toUpperCase();
      let baseFreq = NOTE_FREQS[noteName] || 440;
      if (octave === 2) baseFreq *= 2;

      const whiteKey = document.createElement("div");
      whiteKey.className = "white-key";
      whiteKey.dataset.noteName = noteName;
      whiteKey.dataset.octave = String(octave);
      whiteKey.dataset.freq = baseFreq;
      whiteKey.textContent = label;

      // Colore base per il tasto (tinta unita)
      const col = getNoteColor(noteName);

      // Effetto "vetro acidato / liquid glass" per i tasti del livello 2:
      // tinta unita leggermente traslucida, bordo chiaro e bagliore interno.
      whiteKey.style.background = col;
      whiteKey.style.border = "2px solid rgba(255,255,255,0.85)";
      whiteKey.style.boxShadow =
        "0 8px 16px rgba(15,23,42,0.45), inset 0 0 12px rgba(255,255,255,0.65)";
      whiteKey.style.backdropFilter = "blur(10px)";
      whiteKey.style.webkitBackdropFilter = "blur(10px)";
      whiteKey.style.opacity = "0.96";

      whiteKey.onclick = () => {
        animateKeyPress(whiteKey);
        playTone(baseFreq);
        handleAnswer(noteName, octave);
      };

      pianoKeysEl.appendChild(whiteKey);
    });
  }

  const blackLayout = [
    { name:"do#", whiteIndex:0, octave:1 },
    { name:"re#", whiteIndex:1, octave:1 },
    { name:"fa#", whiteIndex:3, octave:1 },
    { name:"sol#",whiteIndex:4, octave:1 },
    { name:"la#", whiteIndex:5, octave:1 },
    { name:"do#", whiteIndex:7, octave:2 },
    { name:"re#", whiteIndex:8, octave:2 },
    { name:"fa#", whiteIndex:10, octave:2 },
    { name:"sol#",whiteIndex:11, octave:2 },
    { name:"la#", whiteIndex:12, octave:2 }
  ];

  blackLayout.forEach(b => {
    const baseFreq = NOTE_FREQS[b.name] || 440;
    const freq = baseFreq * (b.octave === 2 ? 2 : 1);
    const blackKey = document.createElement("div");
    blackKey.className = "black-key";
    blackKey.dataset.noteName = b.name;
    blackKey.textContent = b.name.replace("#","‚ôØ");

    const leftPercent = ((b.whiteIndex + 1) / totalWhite) * 100;
    blackKey.style.left = leftPercent + "%";

    blackKey.onclick = (ev) => {
      ev.stopPropagation();
      animateKeyPress(blackKey);
      playTone(freq);
    };

    pianoKeysEl.appendChild(blackKey);
  });
}

function createNotes() {
  const count = getNoteCount();
  const useLedger = (getLevel() >= 2);

  let pool = STAFF_CORE_POSITIONS.slice();
  if (useLedger) {
    pool = pool.concat(STAFF_LEDGER_LOW, STAFF_LEDGER_HIGH);
  }

  staffSvg.querySelectorAll(".note-circle, .error-x, .ledger-line").forEach(e => e.remove());
  currentNotes = [];
  currentIndex = 0;
  consecutiveErrors = 0;
  updateStatus();

  const startX = 180;
  const endX = 820;
  const step = (endX - startX) / Math.max(1, (count - 1));

  let lastName = null;
  let lastOct = null;

  for (let i = 0; i < count; i++) {
    let p;
    let safety = 0;
    do {
      p = pool[Math.floor(Math.random() * pool.length)];
      safety++;
    } while (
      safety < 50 &&
      lastName !== null &&
      p.noteName === lastName &&
      p.octave === lastOct
    );

    let cx = startX + step * i;
    // Prima nota: spostata 10px a destra
    if (i === 0) { cx += 10;
    }
    // Ultima nota: spostata 10px a sinistra
    if (i === count - 1) {
      cx -= 10;
    }
    const cy = p.y;

    const noteName = p.noteName;
    const octave = p.octave;
    lastName = noteName;
    lastOct = octave;

    const baseFreq = NOTE_FREQS[noteName] || 440;
    const freq = baseFreq * (octave === 2 ? 2 : 1);

    if ((cy > 200 || cy < 120) && !(noteName === "re" && octave === 1) && !(noteName === "sol" && octave === 2)) {
      const ledger = document.createElementNS("http://www.w3.org/2000/svg","line");
      ledger.setAttribute("x1", cx - 16);
      ledger.setAttribute("x2", cx + 16);
      ledger.setAttribute("y1", cy);
      ledger.setAttribute("y2", cy);
      ledger.classList.add("ledger-line");
      staffSvg.appendChild(ledger);
    }

    const circle = document.createElementNS("http://www.w3.org/2000/svg","circle");
    circle.setAttribute("cx", cx);
    circle.setAttribute("cy", cy);
    circle.setAttribute("r", 9);
    circle.classList.add("note-circle");
    circle.dataset.noteName = noteName;
    circle.dataset.octave = octave;
    staffSvg.appendChild(circle);

    const obj = { element: circle, cx, cy, noteName, octave, freq, solved: false };
    currentNotes.push(obj);

    circle.onclick = () => {
      playTone(freq);
    };
  }

  currentNotes.sort((a,b) => a.cx - b.cx);
  setCurrentTarget();
}

function setCurrentTarget() {
  currentNotes.forEach(n => n.element.classList.remove("target"));
  while (currentIndex < currentNotes.length && currentNotes[currentIndex].solved) currentIndex++;
  if (currentIndex >= currentNotes.length) {
    showRainbow();
    return;
  }
  currentNotes[currentIndex].element.classList.add("target");
  updateStatus();
}

function softResetLevel2() {
  if (!staffSvg) return;
  currentIndex = 0;
  consecutiveErrors = 0;
  createNotes();
}

function handleAnswer(answerNoteName, answerOctave) {
  if (currentIndex >= currentNotes.length) return;
  const target = currentNotes[currentIndex];

  if (answerNoteName === target.noteName && answerOctave === target.octave) {
    const col = getNoteColor(target.noteName);
    target.element.style.fill = col;
    target.element.classList.remove("target");
    target.element.style.stroke = "#111827";
    target.element.style.filter = "none";
    target.element.style.strokeWidth = 2;
    target.solved = true;
    const noteDurationMs = (target.beats || 1) * getBeatIntervalMsL4();
    playTone(target.freq, noteDurationMs);
    consecutiveErrors = 0;
    currentIndex++;
    setTimeout(setCurrentTarget, 250);
  } else {
    playError();
    consecutiveErrors++;
    updateStatus();
    if (consecutiveErrors >= MAX_CONSECUTIVE_ERRORS_L2) {
      // Dopo troppi errori consecutivi, il livello 2 ricomincia con un nuovo spartito
      setTimeout(() => { softResetLevel2(); }, 650);
      return;
    }
    const x = document.createElementNS("http://www.w3.org/2000/svg","text");
    x.setAttribute("x", target.cx + 12);
    x.setAttribute("y", target.cy + 6);
    x.classList.add("error-x");
    x.textContent = "‚úó";
    staffSvg.appendChild(x);
    setTimeout(() => x.remove(), 600);

    if (consecutiveErrors >= 10) {
      resetAllLevels();
    }
  }
}

function addMedalIcon(index) {
  const medal = document.createElement("div");
  medal.className = "medal-icon silver";
  medal.textContent = index;
  medalsPanel.appendChild(medal);
}

function showRainbow() {
  rainbows++;
  totalSilver++;
  incrementSessionMedal("silver");

  if (rainbowWinIndex) rainbowWinIndex.textContent = rainbows;
  addMedalIcon(rainbows);
  consecutiveErrors = 0;
  updateStatus();
  updateRainbowCountersGlobal();
  checkForNewToken();

  const totalDuration = MELODY_STEP_MS * currentNotes.length + 600;

  if (rainbows >= 10) {
    setFinalOverlayTexts(2);
    finalOverlayL2.classList.add("active");
    playVictoryMelody();
    if (typeof nextScoreTimeoutL2 !== "undefined" && nextScoreTimeoutL2) {
      clearTimeout(nextScoreTimeoutL2);
      nextScoreTimeoutL2 = null;
    }
    nextScoreTimeoutL2 = setTimeout(() => {
      finalOverlayL2.classList.remove("active");
      level2PageEl.style.display = "none";
      level3PageEl.style.display = "flex";
      playPageEl.style.display  = "none";
      lastGamePageId = "level3Page";
      softResetLevel3();
      nextScoreTimeoutL2 = null;
    }, totalDuration);
  } else {
    setNormalOverlayTexts(2);
    rainbowOverlay.classList.add("active");
    playVictoryMelody();
    if (typeof nextScoreTimeoutL2 !== "undefined" && nextScoreTimeoutL2) {
      clearTimeout(nextScoreTimeoutL2);
      nextScoreTimeoutL2 = null;
    }
    nextScoreTimeoutL2 = setTimeout(() => {
      rainbowOverlay.classList.remove("active");
      createNotes();
      nextScoreTimeoutL2 = null;
    }, totalDuration);
  }
}

if (pianoKeysEl && staffSvg) {
  renderPiano();
  createNotes();
  updateStatus();
}

/* ===========================
   LIVELLO 3
   =========================== */

const staffSvgL3    = document.getElementById("staffSvgL3");
const statusBarElL3 = document.getElementById("statusBarL3");
const errorPillL3   = document.getElementById("errorPillL3");
const pianoKeysElL3 = document.getElementById("pianoKeysL3");
const resetBtnL3    = document.getElementById("resetBtnL3");
const rainbowWinIndexL3 = document.getElementById("rainbowWinIndexL3");
const medalsPanelL3  = document.getElementById("medalsPanelL3");
const rainbowOverlayL3 = document.getElementById("rainbowOverlayL3");
const finalOverlayL3 = document.getElementById("finalOverlayL3");

let currentNotesL3 = [];
let currentIndexL3 = 0;
let rainbowsL3 = 0;
let consecutiveErrorsL3 = 0;
const MAX_CONSECUTIVE_ERRORS_L3 = 5;

function getNoteCountL3() {
  const base = 10;
  const increment = 1;
  const max = 24;
  return Math.min(base + rainbowsL3 * increment, max);
}

function getLevelL3() {
  return (rainbowsL3 >= 10) ? 2 : 1;
}

function updateStatusL3() {
  updateErrorPill(errorPillL3, consecutiveErrorsL3, 7);
}

function playVictoryMelodyL3() {
  if (!currentNotesL3.length) return 0;

  const step = MELODY_STEP_MS;

  // prepara stato jingle per LIVELLO 3
  clearJingleTimeouts();
  isJinglePlaying = true;
  currentJingleLevel = 3;

  currentNotesL3.forEach((n, idx) => {
    const delay = idx * step;
    const timeoutId = setTimeout(() => {
      if (!isJinglePlaying || currentJingleLevel !== 3) return;
      playTone(n.freq);
    }, delay);
    activeJingleTimeouts.push(timeoutId);
  });

  const totalMs = step * currentNotesL3.length;
  const endId = setTimeout(() => {
    if (currentJingleLevel === 3) {
      isJinglePlaying = false;
    }
    clearJingleTimeouts();
  }, totalMs + 120);
  activeJingleTimeouts.push(endId);

  return totalMs;
}

function renderPianoL3() {
  pianoKeysElL3.innerHTML = "";
  const whiteNotesOrder = ["do","re","mi","fa","sol","la","si"];
  const totalWhite = 14;

  for (let octave = 1; octave <= 2; octave++) {
    whiteNotesOrder.forEach(noteName => {
      let baseFreq = NOTE_FREQS[noteName] || 440;
      if (octave === 2) baseFreq *= 2;

      const whiteKey = document.createElement("div");
      whiteKey.className = "white-key";
      whiteKey.dataset.noteName = noteName;
      whiteKey.dataset.octave = String(octave);
      whiteKey.dataset.freq = baseFreq;
      whiteKey.textContent = "";

      whiteKey.style.background = "linear-gradient(to bottom, #ffffff 0%, #f3f4f6 40%, #e5e7eb 100%)";

      whiteKey.onclick = () => {
        animateKeyPress(whiteKey);
        playTone(baseFreq);
        handleAnswerL3(noteName, octave);
      };

      pianoKeysElL3.appendChild(whiteKey);
    });
  }

  const blackLayout = [
    { name:"do#", whiteIndex:0, octave:1 },
    { name:"re#", whiteIndex:1, octave:1 },
    { name:"fa#", whiteIndex:3, octave:1 },
    { name:"sol#",whiteIndex:4, octave:1 },
    { name:"la#", whiteIndex:5, octave:1 },
    { name:"do#", whiteIndex:7, octave:2 },
    { name:"re#", whiteIndex:8, octave:2 },
    { name:"fa#", whiteIndex:10, octave:2 },
    { name:"sol#",whiteIndex:11, octave:2 },
    { name:"la#", whiteIndex:12, octave:2 }
  ];

  blackLayout.forEach(b => {
    const baseFreq = NOTE_FREQS[b.name] || 440;
    const freq = baseFreq * (b.octave === 2 ? 2 : 1);
    const blackKey = document.createElement("div");
    blackKey.className = "black-key";
    blackKey.dataset.noteName = b.name;
    blackKey.textContent = "";

    const leftPercent = ((b.whiteIndex + 1) / totalWhite) * 100;
    blackKey.style.left = leftPercent + "%";

    blackKey.onclick = (ev) => {
      ev.stopPropagation();
      animateKeyPress(blackKey);
      playTone(freq);
    };

    pianoKeysElL3.appendChild(blackKey);
  });
}

function createNotesL3() {
  const count = getNoteCountL3();
  const useLedger = (getLevelL3() >= 2);

  let pool = STAFF_CORE_POSITIONS.slice();
  if (useLedger) {
    pool = pool.concat(STAFF_LEDGER_LOW, STAFF_LEDGER_HIGH);
  }

  staffSvgL3.querySelectorAll(".note-circle, .error-x, .ledger-line").forEach(e => e.remove());
  currentNotesL3 = [];
  currentIndexL3 = 0;
  consecutiveErrorsL3 = 0;
  updateStatusL3();

  const startX = 180;
  const endX = 820;
  const step = (endX - startX) / Math.max(1, (count - 1));

  let lastName = null;
  let lastOct = null;

  for (let i = 0; i < count; i++) {
    let p;
    let safety = 0;
    do {
      p = pool[Math.floor(Math.random() * pool.length)];
      safety++;
    } while (
      safety < 50 &&
      lastName !== null &&
      p.noteName === lastName &&
      p.octave === lastOct
    );

    let cx = startX + step * i;
    // Prima nota: spostata 10px a destra
    if (i === 0) { cx += 10;
    }
    // Ultima nota: spostata 10px a sinistra
    if (i === count - 1) {
      cx -= 10;
    }
    const cy = p.y;

    const noteName = p.noteName;
    const octave = p.octave;
    lastName = noteName;
    lastOct = octave;

    const baseFreq = NOTE_FREQS[noteName] || 440;
    const freq = baseFreq * (octave === 2 ? 2 : 1);

    if ((cy > 200 || cy < 120) && !(noteName === "re" && octave === 1) && !(noteName === "sol" && octave === 2)) {
      const ledger = document.createElementNS("http://www.w3.org/2000/svg","line");
      ledger.setAttribute("x1", cx - 16);
      ledger.setAttribute("x2", cx + 16);
      ledger.setAttribute("y1", cy);
      ledger.setAttribute("y2", cy);
      ledger.classList.add("ledger-line");
      staffSvgL3.appendChild(ledger);
    }

    const circle = document.createElementNS("http://www.w3.org/2000/svg","circle");
    circle.setAttribute("cx", cx);
    circle.setAttribute("cy", cy);
    circle.setAttribute("r", 9);
    circle.classList.add("note-circle");
    circle.dataset.noteName = noteName;
    circle.dataset.octave = octave;
    staffSvgL3.appendChild(circle);

    const obj = { element: circle, cx, cy, noteName, octave, freq, solved: false };
    currentNotesL3.push(obj);

    circle.onclick = () => {
      playTone(freq);
    };
  }

  currentNotesL3.sort((a,b) => a.cx - b.cx);
  setCurrentTargetL3();
}

function setCurrentTargetL3() {
  currentNotesL3.forEach(n => n.element.classList.remove("target"));
  while (currentIndexL3 < currentNotesL3.length && currentNotesL3[currentIndexL3].solved) currentIndexL3++;
  if (currentIndexL3 >= currentNotesL3.length) {
    showRainbowL3();
    return;
  }
  currentNotesL3[currentIndexL3].element.classList.add("target");
  updateStatusL3();
}

function softResetLevel3() {
  if (!staffSvgL3) return;
  currentIndexL3 = 0;
  consecutiveErrorsL3 = 0;
  createNotesL3();
}


function handleAnswerL3(answerNoteName, answerOctave) {
  if (currentIndexL3 >= currentNotesL3.length) return;
  const target = currentNotesL3[currentIndexL3];

  if (answerNoteName === target.noteName && answerOctave === target.octave) {
    const col = getNoteColor(target.noteName);
    target.element.style.fill = col;
    target.element.classList.remove("target");
    target.element.style.stroke = "#111827";
    target.element.style.filter = "none";
    target.element.style.strokeWidth = 2;
    target.solved = true;
    const noteDurationMs = (target.beats || 1) * getBeatIntervalMsL4();
    playTone(target.freq, noteDurationMs);
    consecutiveErrorsL3 = 0;
    currentIndexL3++;
    setTimeout(setCurrentTargetL3, 250);
  } else {
    playError();
    consecutiveErrorsL3++;
    updateStatusL3();
    if (consecutiveErrorsL3 >= MAX_CONSECUTIVE_ERRORS_L3) {
      // Dopo troppi errori consecutivi, il livello 3 ricomincia con un nuovo spartito
      setTimeout(() => { createNotesL3(); }, 650);
      return;
    }
    const x = document.createElementNS("http://www.w3.org/2000/svg","text");
    x.setAttribute("x", target.cx + 12);
    x.setAttribute("y", target.cy + 6);
    x.classList.add("error-x");
    x.textContent = "‚úó";
    staffSvgL3.appendChild(x);
    setTimeout(() => x.remove(), 600);

    if (consecutiveErrorsL3 >= 10) {
      resetAllLevels();
    }
  }
}
function addMedalIconL3(index) {
  const medal = document.createElement("div");
  medal.className = "medal-icon gold";
  medal.textContent = index;
  medalsPanelL3.appendChild(medal);
}

function showRainbowL3() {
  rainbowsL3++;
  totalGold++;
  incrementSessionMedal("gold");

  if (rainbowWinIndexL3) rainbowWinIndexL3.textContent = rainbowsL3;
  addMedalIconL3(rainbowsL3);
  consecutiveErrorsL3 = 0;
  updateStatusL3();
  updateRainbowCountersGlobal();
  checkForNewToken();

  const totalDuration = MELODY_STEP_MS * currentNotesL3.length + 600;

  if (rainbowsL3 >= 10) {
    setFinalOverlayTexts(3);
    finalOverlayL3.classList.add("active");
    playVictoryMelodyL3();
    if (typeof nextScoreTimeoutL3 !== "undefined" && nextScoreTimeoutL3) {
      clearTimeout(nextScoreTimeoutL3);
      nextScoreTimeoutL3 = null;
    }
    nextScoreTimeoutL3 = setTimeout(() => {
      finalOverlayL3.classList.remove("active");
      createNotesL3();
      nextScoreTimeoutL3 = null;
    }, totalDuration);
  } else {
    setNormalOverlayTexts(3);
    rainbowOverlayL3.classList.add("active");
    playVictoryMelodyL3();
    if (typeof nextScoreTimeoutL3 !== "undefined" && nextScoreTimeoutL3) {
      clearTimeout(nextScoreTimeoutL3);
      nextScoreTimeoutL3 = null;
    }
    nextScoreTimeoutL3 = setTimeout(() => {
      rainbowOverlayL3.classList.remove("active");
      createNotesL3();
      nextScoreTimeoutL3 = null;
    }, totalDuration);
  }
}

if (pianoKeysElL3 && staffSvgL3) {
  renderPianoL3();
  createNotesL3();
  updateStatusL3();
}


/* ===========================
   LIVELLO 4 - RITMO
   =========================== */

const staffSvgL4    = document.getElementById("staffSvgL4");
const staffGroupL4  = document.getElementById("staffL4Group");
const statusBarElL4 = document.getElementById("statusBarL4");
const errorPillL4   = document.getElementById("errorPillL4");
const pianoKeysElL4 = document.getElementById("pianoKeysL4");
const resetBtnL4    = document.getElementById("resetBtnL4");
const rainbowWinIndexL4 = document.getElementById("rainbowWinIndexL4");
const medalsPanelL4  = document.getElementById("medalsPanelL4");
const rainbowOverlayL4 = document.getElementById("rainbowOverlayL4");
const finalOverlayL4 = null;
const bpmInputL4 = document.getElementById("bpmInputL4");
const metronomeDotL4 = document.getElementById("metronomeDotL4");

let currentNotesL4 = [];
let currentIndexL4 = 0;
let consecutiveErrorsL4 = 0;
let lastHitTimeL4 = null;
let metronomeIntervalIdL4 = null;
let metronomeToggleBtnL4 = null;
let bpmL4 = 80;
const TOLERANCE_MS_L4 = 340;
let rainbowsL4Local = 0;

function addMedalIconL4(index) {
  if (!medalsPanelL4) return;
  const medal = document.createElement("div");
  medal.className = "medal-icon green";
  medal.textContent = index;
  medalsPanelL4.appendChild(medal);
}


function playVictoryPatternL4() {
  if (!currentNotesL4.length) return 0;
  const beatMs = getBeatIntervalMsL4();
  let offset = 0;

  // reset stato jingle e timeouts
  clearJingleTimeouts();
  isJinglePlaying = true;
  currentJingleLevel = 4;

  currentNotesL4.forEach((n) => {
    const noteDurationMs = (n.beats || 1) * beatMs;
    const timeoutId = setTimeout(() => {
      if (!isJinglePlaying) return;
      try {
        playTone(n.freq, noteDurationMs);
      } catch (e) {
        // ignora eventuali errori audio
      }
    }, offset);
    activeJingleTimeouts.push(timeoutId);
    offset += noteDurationMs;
  });

  // durata totale della melodia (in ms)
  const totalMs = currentNotesL4.reduce(
    (acc, n) => acc + ((n.beats || 1) * beatMs),
    0
  );

  // al termine naturale della melodia, pulisci lo stato
  const endId = setTimeout(() => {
    isJinglePlaying = false;
    clearJingleTimeouts();
  }, totalMs + 100);
  activeJingleTimeouts.push(endId);

  return totalMs;
}


function onPatternCompletedL4() {
  // Il metronomo continua a suonare fino alla fine della nota finale

  // Aggiorna il contatore locale e il numero nell'arco
  rainbowsL4Local++;
  if (rainbowWinIndexL4) {
    rainbowWinIndexL4.textContent = rainbowsL4Local;
  }

  // Aggiungi una piccola medaglia nel pannello del livello 4
  addMedalIconL4(rainbowsL4Local);

  // Aggiorna lo scrigno di sessione con una medaglia del livello 4 (verde)
  incrementSessionMedal("green");
  updateRainbowCountersGlobal();
  checkForNewToken();

  // Prepara il popup della medaglia (stile oro) ‚Äî lo mostriamo SOLO quando l'ultima nota smette di suonare
  setNormalOverlayTexts(4);

  // Calcola quanto deve durare ancora l'ultima nota
  let lastNoteDelay = 0;
  if (currentNotesL4.length) {
    const last = currentNotesL4[currentNotesL4.length - 1];
    lastNoteDelay = (last.beats || 1) * getBeatIntervalMsL4();
  }

  // Riproduci la melodia come ricompensa solo dopo la fine della nota finale
  setTimeout(() => {
    // Mostra il popup SOLO ora (fine ultima nota)
    if (rainbowOverlayL4) {
      rainbowOverlayL4.classList.add("active");
    }

    // Ora possiamo fermare il metronomo del livello 4
    stopMetronomeL4();
    const melodyDuration = playVictoryPatternL4() || 0;

    // Dopo la melodia, genera un nuovo pentagramma/ritmo
    const totalDuration = melodyDuration + 600;

    if (typeof nextScoreTimeoutL4 !== "undefined" && nextScoreTimeoutL4) {
      clearTimeout(nextScoreTimeoutL4);
      nextScoreTimeoutL4 = null;
    }

    nextScoreTimeoutL4 = setTimeout(() => {
      if (rainbowOverlayL4) {
        rainbowOverlayL4.classList.remove("active");
      }
      createNotesL4();
      nextScoreTimeoutL4 = null;
    }, totalDuration);
  }, lastNoteDelay);
}


const DURATIONS_L4 = [
  { name: "semibreve",   beats: 4 },
  { name: "minima",      beats: 2 },
  { name: "semiminima",  beats: 1 }
];

const SYMBOLS_L4 = {
  semibreve:   "ùÖù",
  minima:      "ùÖû",
  semiminima:  "ùÖü",
  croma:       "ùÖ†"
};




function pickMeasurePatternL4(durationsPool) {
  const targetBeats = 4;
  const maxNotes = 8;
  if (!Array.isArray(durationsPool) || !durationsPool.length) {
    durationsPool = DURATIONS_L4.slice();
  }

  let pattern = [];
  let sum = 0;
  let safety = 0;
  let lastName = null;

  while (sum < targetBeats && safety < 1000 && pattern.length < maxNotes) {
    const remaining = targetBeats - sum;
    // scegli solo durate che non superano il totale della battuta
    let candidates = durationsPool.filter(d => d.beats <= remaining);
    if (!candidates.length) break;

    // prova ad alternare la figura rispetto alla precedente
    if (lastName !== null) {
      const alt = candidates.filter(d => d.name !== lastName);
      if (alt.length > 0) {
        candidates = alt;
      }
    }

    const d = candidates[Math.floor(Math.random() * candidates.length)];
    pattern.push(d);
    sum += d.beats;
    lastName = d.name;
    safety++;
  }

  if (Math.abs(sum - targetBeats) < 0.0001 && pattern.length > 0) {
    return pattern;
  }

  // Fallback: 4/4 pieno con semiminime
  const semiminima = DURATIONS_L4.find(d => d.name === "semiminima") || { name: "semiminima", beats: 1 };
  return [semiminima, semiminima, semiminima, semiminima];
}

function getBeatIntervalMsL4() {
  return 60000 / bpmL4;
}

function clickMetronomeL4() {
  if (!metronomeDotL4) return;

  // Click visivo
  metronomeDotL4.classList.add("active");
  setTimeout(() => {
    if (metronomeDotL4) metronomeDotL4.classList.remove("active");
  }, 90);

  // Click sonoro (solo se l'audio √® attivo)
  if (typeof audioEnabled !== "undefined" && audioEnabled) {
    try {
      // Click breve e secco
      playTone(1200, 120);
    } catch (e) {
      // ignora eventuali errori audio
    }
  }
}

function startMetronomeL4() {
  stopMetronomeL4();
  if (!metronomeDotL4) return;

  // Primo click immediato, in sincro con la prima nota
  clickMetronomeL4();

  // Click successivi ad ogni battito
  metronomeIntervalIdL4 = setInterval(() => {
    clickMetronomeL4();
  }, getBeatIntervalMsL4());

  if (metronomeToggleBtnL4) metronomeToggleBtnL4.checked = true;
}

function stopMetronomeL4() {
  if (metronomeIntervalIdL4) {
    clearInterval(metronomeIntervalIdL4);
    metronomeIntervalIdL4 = null;
  }
  if (metronomeDotL4) {
    metronomeDotL4.classList.remove("active");
  }
  if (metronomeToggleBtnL4) metronomeToggleBtnL4.checked = false;
}




// Geometria nota livello 4: pallino + gambo
const NOTE_HEAD_RX = 10.5;   // raggio orizzontale pallino
const NOTE_HEAD_RY = 7.5;   // raggio verticale pallino
const STEM_X       = NOTE_HEAD_RX; // gambo tangente al bordo destro del pallino

function createNotesL4() {
  if (!staffSvgL4) return;

  // Solo note sulle 5 linee/spazi: da mi1 a fa2
  let pool = STAFF_CORE_POSITIONS.slice();

  // Conta il numero totale di medaglie per calibrare il ritmo
  let totalMedals = 0;
  try {
    if (Array.isArray(sessions)) {
      totalMedals = sessions.reduce(
        (acc, s) => acc + (s.bronze || 0) + (s.silver || 0) + (s.gold || 0),
        0
      );
    }
  } catch (e) {
    // in caso di problemi, manteniamo totalMedals = 0
  }

  // Pool di durate nel livello 4 (solo semibrevi, minime e semiminime)
  let durationsPool = DURATIONS_L4.slice();

  // Pulisci vecchie note/segni di errore
  staffSvgL4
    .querySelectorAll(".note-circle, .note-symbol, .error-x, .ledger-line, .note-stem, .note-flag, .measure-bar-l4")
    .forEach(e => e.remove());
  currentNotesL4 = [];
  currentIndexL4 = 0;
  consecutiveErrorsL4 = 0;
  lastHitTimeL4 = null;
  updateErrorPill(errorPillL4, consecutiveErrorsL4, 7);

  const startX = 180;
  const endX = 820;

  // Decidi il numero di battute in base alle medaglie vinte
  const measureCount = (totalMedals >= 5) ? 3 : 2;

  // Calcola le posizioni delle linee di battuta
  const barPositions = [];
  const span = endX - startX;
  for (let i = 1; i < measureCount; i++) {
    const x = startX + (span * i) / measureCount;
    barPositions.push(x);
  }

  // Una sola linea di battuta tra le battute (indipendente dalle medaglie)
  const barsPerSeparator = 1;

  // Disegna le linee di battuta
  const barGap = 6;
  barPositions.forEach((barX) => {
    const totalWidth = barGap * (barsPerSeparator - 1);
    const firstX = barX - totalWidth / 2;
    for (let i = 0; i < barsPerSeparator; i++) {
      const x = firstX + i * barGap;
      const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
      line.setAttribute("x1", x);
      line.setAttribute("x2", x);
      // Allinea la linea di battuta alle 5 linee del pentagramma (92.31‚Äì153.85)
      line.setAttribute("y1", 92.31);
      line.setAttribute("y2", 153.85);
      line.setAttribute("stroke", "#111827");
      line.setAttribute("stroke-width", "2");
      line.classList.add("measure-bar-l4");
      (staffGroupL4 || staffSvgL4).appendChild(line);
    }
  });

  // Genera le battute da 4/4
  const measure1 = pickMeasurePatternL4(durationsPool);
  const measure2 = pickMeasurePatternL4(durationsPool);
  const measure3 = (measureCount === 3) ? pickMeasurePatternL4(durationsPool) : null;

  const count1 = measure1.length;
  const count2 = measure2.length;
  const count3 = measure3 ? measure3.length : 0;

  let lastName = null;
  let lastOct = null;

  function takeRandomPositionFromPool() {
    if (!pool.length) {
      pool = STAFF_CORE_POSITIONS.slice();
    }
    const idx = Math.floor(Math.random() * pool.length);
    return pool.splice(idx, 1)[0];
  }

  function placeMeasure(pattern, fromX, toX) {
    const count = pattern.length;
    if (count === 0) return;
    for (let i = 0; i < count; i++) {
      const p = takeRandomPositionFromPool();
      const t = (count === 1) ? 0.5 : (i / Math.max(1, count - 1));
      const margin = 25;
      const leftX  = fromX + margin;
      const rightX = toX - margin;
      const cx = leftX + (rightX - leftX) * t;
      const cy = getStaffY(p.noteName, p.octave);

      const noteName = p.noteName;
      const octave = p.octave;
      lastName = noteName;
      lastOct = octave;

      const baseFreq = NOTE_FREQS[noteName] || 440;
      const freq = baseFreq * (octave === 2 ? 2 : 1);

      // Linee aggiuntive per note molto alte/basse
      if (
        (cy > 200 || cy < 120) &&
        !(noteName === "re" && octave === 1) &&
        !(noteName === "sol" && octave === 2)
      ) {
        const ledger = document.createElementNS("http://www.w3.org/2000/svg", "line");
        ledger.setAttribute("x1", cx - 16);
        ledger.setAttribute("x2", cx + 16);
        ledger.setAttribute("y1", cy);
        ledger.setAttribute("y2", cy);
        ledger.classList.add("ledger-line");
        (staffGroupL4 || staffSvgL4).appendChild(ledger);
      }

            const duration = pattern[i];
      const beats = duration.beats;
      const durationName = duration.name;

      const group = document.createElementNS("http://www.w3.org/2000/svg", "g");
      group.classList.add("note-symbol");
      group.setAttribute("transform", "translate(" + cx + ", " + cy + ")");

      // Testa della nota (ovale)
      const head = document.createElementNS("http://www.w3.org/2000/svg", "ellipse");
      head.setAttribute("cx", 0);
      head.setAttribute("cy", 0);
      head.setAttribute("rx", NOTE_HEAD_RX);
      head.setAttribute("ry", NOTE_HEAD_RY);
      // leggera rotazione per avvicinarsi alla forma delle note reali
      head.setAttribute("transform", "rotate(-15)");
      head.classList.add("note-head");
      if (durationName === "semiminima" || durationName === "croma") {
        head.classList.add("filled");
      }
      group.appendChild(head);

      // Puntino per le figure puntate (se mai usate nel livello 4)
      if (durationName === "minima_puntata" || durationName === "semiminima_puntata") {
        const dot = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        dot.setAttribute("cx", STEM_X + NOTE_HEAD_RX + 4);
        dot.setAttribute("cy", 0);
        dot.setAttribute("r", 3);
        dot.classList.add("note-head");
        dot.classList.add("filled");
        group.appendChild(dot);
      }

      // Gambo per tutte tranne la semibreve
      if (durationName !== "semibreve") {
        const stem = document.createElementNS("http://www.w3.org/2000/svg", "line");
        // gambo tangente al bordo destro del pallino
        stem.setAttribute("x1", STEM_X);
        stem.setAttribute("y1", 0);
        stem.setAttribute("x2", STEM_X);
        stem.setAttribute("y2", -42);
        stem.classList.add("note-stem");
        group.appendChild(stem);

        // Bandierina solo per la croma
        if (durationName === "croma") {
          const flag = document.createElementNS("http://www.w3.org/2000/svg", "path");
          // bandierina agganciata al gambo in x = STEM_X
          flag.setAttribute(
            "d",
            "M " + STEM_X + " -42 Q " + (STEM_X + 12) + " -38, " +
                         (STEM_X + 12) + " -30"
          );
          flag.classList.add("note-flag");
          group.appendChild(flag);
        }
      }

      (staffGroupL4 || staffSvgL4).appendChild(group);

      const obj = {
        cx,
        cy,
        noteName,
        octave,
        freq,
        beats,
        durationName: durationName,
        element: group
      };
      currentNotesL4.push(obj);
    }
  }

  // Colloca le battute sul pentagramma
  if (measureCount === 2) {
    // Due battute: [startX, barPositions[0]] e [barPositions[0], endX]
    placeMeasure(measure1, startX, barPositions[0]);
    placeMeasure(measure2, barPositions[0], endX);
  } else {
    // Tre battute: [startX, barPositions[0]], [barPositions[0], barPositions[1]], [barPositions[1], endX]
    placeMeasure(measure1, startX, barPositions[0]);
    placeMeasure(measure2, barPositions[0], barPositions[1]);
    placeMeasure(measure3, barPositions[1], endX);
  }

  // Ordina da sinistra a destra (per sicurezza)
  currentNotesL4.sort((a, b) => a.cx - b.cx);
  updateErrorPill(errorPillL4, consecutiveErrorsL4, 7);
  stopMetronomeL4();
}


function restartSamePatternL4() {
  currentIndexL4 = 0;
  consecutiveErrorsL4 = 0;
  lastHitTimeL4 = null;
  if (Array.isArray(currentNotesL4)) {
    currentNotesL4.forEach(n => {
      if (n.element) {
        const el = n.element;
        const head = el.querySelector(".note-head");
        const parts = el.querySelectorAll(".note-stem, .note-flag");

        if (head) {
          head.style.stroke = "";
          head.style.fill = "";
        }
        parts.forEach(p => {
          p.style.stroke = "";
        });

        if (el.classList) {
          el.classList.remove("note-played");
        }
      }
    });
  }
  updateErrorPill(errorPillL4, consecutiveErrorsL4, 7);
}

function handleAnswerL4(answerNoteName, answerOctave) {
  if (!currentNotesL4.length) return;

  const target = currentNotesL4[currentIndexL4];
  if (!target) return;

  const now = performance.now();
  // Nel livello 4 devono coincidere sia il nome della nota sia l'ottava (bassa o alta).
  const inPitch = (answerNoteName === target.noteName && answerOctave === target.octave);

  let inTime = false;
  if (currentIndexL4 === 0 || lastHitTimeL4 == null) {
    inTime = true;
  } else {
    const prev = currentNotesL4[currentIndexL4 - 1];
    const expectedInterval = prev.beats * getBeatIntervalMsL4();
    const actualInterval = now - lastHitTimeL4;
    const delta = Math.abs(actualInterval - expectedInterval);

    // Tolleranza pi√π ampia sull'ultima nota della sequenza
    const isLastNote = (currentIndexL4 === currentNotesL4.length - 1);
    const effectiveTolerance = isLastNote ? (TOLERANCE_MS_L4 * 2.4) : TOLERANCE_MS_L4;

    inTime = (delta <= effectiveTolerance);
  }

  if (inPitch && inTime) {
    // Se √® la primissima nota dello spartito e il metronomo √® fermo, avvialo ora
    if (currentIndexL4 === 0 && !metronomeIntervalIdL4) {
      startMetronomeL4();
    }

    const noteDurationMs = (target.beats || 1) * getBeatIntervalMsL4();
    playTone(target.freq, noteDurationMs);
    // Colora la nota con il suo colore (do=rosso, re=arancione, ecc.)
    colorNoteElementByName(target);
    lastHitTimeL4 = now;
    currentIndexL4++;

    if (currentIndexL4 >= currentNotesL4.length) {
      onPatternCompletedL4();
      return;
    }
  } else {
    playError();
    consecutiveErrorsL4++;
    updateErrorPill(errorPillL4, consecutiveErrorsL4, 7);
    restartSamePatternL4();
  }
}


function renderPianoL4() {
  if (!pianoKeysElL4) return;
  pianoKeysElL4.innerHTML = "";
  const whiteNotesOrder = ["do","re","mi","fa","sol","la","si"];
  const totalWhite = 14;

  for (let octave = 1; octave <= 2; octave++) {
    whiteNotesOrder.forEach(noteName => {
      let baseFreq = NOTE_FREQS[noteName] || 440;
      if (octave === 2) baseFreq *= 2;

      const whiteKey = document.createElement("div");
      whiteKey.className = "white-key";
      whiteKey.dataset.noteName = noteName;
      whiteKey.dataset.octave = String(octave);
      whiteKey.dataset.freq = baseFreq;
      whiteKey.textContent = "";

      whiteKey.style.background = "linear-gradient(to bottom, #ffffff 0%, #f3f4f6 40%, #e5e7eb 100%)";

      whiteKey.onclick = () => {
        animateKeyPress(whiteKey);
        playTone(baseFreq);
        handleAnswerL4(noteName, octave);
      };

      pianoKeysElL4.appendChild(whiteKey);
    });
  }

  const blackLayout = [
    { name:"do#", whiteIndex:0, octave:1 },
    { name:"re#", whiteIndex:1, octave:1 },
    { name:"fa#", whiteIndex:3, octave:1 },
    { name:"sol#",whiteIndex:4, octave:1 },
    { name:"la#", whiteIndex:5, octave:1 },
    { name:"do#", whiteIndex:7, octave:2 },
    { name:"re#", whiteIndex:8, octave:2 },
    { name:"fa#", whiteIndex:10, octave:2 },
    { name:"sol#",whiteIndex:11, octave:2 },
    { name:"la#", whiteIndex:12, octave:2 }
  ];

  blackLayout.forEach(b => {
    const baseFreq = NOTE_FREQS[b.name] || 440;
    const freq = baseFreq * (b.octave === 2 ? 2 : 1);
    const blackKey = document.createElement("div");
    blackKey.className = "black-key";
    blackKey.dataset.noteName = b.name;
    blackKey.textContent = "";

    const leftPercent = ((b.whiteIndex + 1) / totalWhite) * 100;
    blackKey.style.left = leftPercent + "%";

    blackKey.onclick = (ev) => {
      ev.stopPropagation();
      animateKeyPress(blackKey);
      playTone(freq);
      handleAnswerL4(b.name, b.octave);
    };

    pianoKeysElL4.appendChild(blackKey);
  });
}


function softResetLevel4() {
  if (!staffSvgL4) return;
  // Ferma il metronomo e rigenera un nuovo spartito del livello 4
  stopMetronomeL4();
  currentNotesL4 = [];
  currentIndexL4 = 0;
  consecutiveErrorsL4 = 0;
  lastHitTimeL4 = null;
  updateErrorPill(errorPillL4, consecutiveErrorsL4, 7);
  createNotesL4();
  // La tastiera viene ricostruita per sicurezza (svuotando i tasti precedenti)
  renderPianoL4();
}

if (resetBtnL4) resetBtnL4.onclick = resetAllLevels;
if (bpmInputL4) {
  bpmInputL4.addEventListener("change", () => {
    let v = parseInt(bpmInputL4.value, 10);
    if (isNaN(v)) v = 80;
    v = Math.max(40, Math.min(160, v));
    bpmInputL4.value = v;
    bpmL4 = v;
    // Se il metronomo √® gi√† in funzione, riavvialo con il nuovo BPM.
    // Se √® fermo, non lo avviamo: partir√† solo quando il bimbo suona la prima nota.
    if (metronomeIntervalIdL4) {
      startMetronomeL4();
    }
  });
}

// Clic sul pallino del metronomo: spegne il metronomo e ricomincia lo spartito
if (metronomeDotL4) {
  metronomeDotL4.addEventListener("click", () => {
    stopMetronomeL4();
    softResetLevel4();
  });
}

// Inizializza livello 4 se presente
if (staffSvgL4 && pianoKeysElL4) {
  bpmL4 = bpmInputL4 ? parseInt(bpmInputL4.value, 10) || 80 : 80;
  updateErrorPill(errorPillL4, consecutiveErrorsL4, 7);
  createNotesL4();
  renderPianoL4();
}


/* ===========================
   IMPARA TEMPO - RITMO GUIDATO
   =========================== */

const staffSvgTempo    = document.getElementById("staffSvgTempo");
const staffGroupTempo  = document.getElementById("staffTempoGroup");
const statusBarElTempo = document.getElementById("statusBarTempo");
const errorPillTempo   = document.getElementById("errorPillTempo");
const resetBtnTempo    = document.getElementById("resetBtnTempo");
const bpmInputTempo    = document.getElementById("bpmInputTempo");
const metronomeDotTempo = document.getElementById("metronomeDotTempo");
const tempoActionBtn   = document.getElementById("tempoActionBtn");

let currentNotesTempo = [];
let currentIndexTempo = 0;
let consecutiveErrorsTempo = 0;
let lastHitTimeTempo = null;
let bpmTempo = 80;
let metronomeIntervalIdTempo = null;
let metronomeToggleBtnTempo = null;
let metronomeStopTimeoutTempo = null;

const TOLERANCE_MS_TEMPO = (typeof TOLERANCE_MS_L4 !== "undefined" ? TOLERANCE_MS_L4 : 340);

function getBeatIntervalMsTempo() {
  return 60000 / bpmTempo;
}

function clickMetronomeTempo() {
  if (!metronomeDotTempo) return;
  // click visivo
  metronomeDotTempo.classList.add("active");
  setTimeout(() => {
    if (metronomeDotTempo) metronomeDotTempo.classList.remove("active");
  }, 90);
  // click sonoro se l'audio √® attivo
  if (typeof audioEnabled !== "undefined" && audioEnabled) {
    try {
      playTone(1200, 120);
    } catch (e) {
      // ignora errori audio
    }
  }
}

function startMetronomeTempo() {
  if (!bpmInputTempo) return;
  const v = parseInt(bpmInputTempo.value, 10) || 80;
  bpmTempo = v;

  // Se c'√® un timer programmato per spegnere il metronomo (ultima nota), annullalo
  if (typeof metronomeStopTimeoutTempo !== "undefined" && metronomeStopTimeoutTempo) {
    clearTimeout(metronomeStopTimeoutTempo);
    metronomeStopTimeoutTempo = null;
  }

  if (metronomeIntervalIdTempo) {
    clearInterval(metronomeIntervalIdTempo);
    metronomeIntervalIdTempo = null;
  }
  clickMetronomeTempo();
  const interval = getBeatIntervalMsTempo();
  metronomeIntervalIdTempo = setInterval(clickMetronomeTempo, interval);

  if (metronomeToggleBtnTempo) metronomeToggleBtnTempo.checked = true;
}


function stopMetronomeTempo() {
  if (metronomeIntervalIdTempo) {
    clearInterval(metronomeIntervalIdTempo);
    metronomeIntervalIdTempo = null;
  }
  if (typeof metronomeStopTimeoutTempo !== "undefined" && metronomeStopTimeoutTempo) {
    clearTimeout(metronomeStopTimeoutTempo);
    metronomeStopTimeoutTempo = null;
  }
  if (metronomeDotTempo) {
    metronomeDotTempo.classList.remove("active");
  }
  if (metronomeToggleBtnTempo) metronomeToggleBtnTempo.checked = false;
}



function restartSamePatternTempo() {
  currentIndexTempo = 0;
  lastHitTimeTempo = null;
  if (Array.isArray(currentNotesTempo)) {
    currentNotesTempo.forEach(n => {
      if (!n.element) return;
      const el = n.element;
      const head = el.querySelector(".note-head");
      const parts = el.querySelectorAll(".note-stem, .note-flag");
      if (head) {
        head.style.fill = "";
        head.style.stroke = "";
      }
      parts.forEach(p => {
        p.style.stroke = "";
      });
      if (el.classList) {
        el.classList.remove("note-played");
      }
    });
  }
  updateErrorPill(errorPillTempo, consecutiveErrorsTempo, 7);
}

function createNotesTempo() {
  if (!staffSvgTempo) return;

  staffSvgTempo
    .querySelectorAll(".note-head, .note-symbol, .error-x, .ledger-line, .note-stem, .note-flag, .measure-bar-l4")
    .forEach(e => e.remove());

  currentNotesTempo = [];
  currentIndexTempo = 0;
  consecutiveErrorsTempo = 0;
  lastHitTimeTempo = null;
  updateErrorPill(errorPillTempo, consecutiveErrorsTempo, 7);

  const startX = 180;
  const endX = 820;

  const measureCount = 2;

  const barPositions = [];
  const span = endX - startX;
  for (let i = 1; i < measureCount; i++) {
    const x = startX + (span * i) / measureCount;
    barPositions.push(x);
  }

  barPositions.forEach((barX) => {
    const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
    line.setAttribute("x1", barX);
    line.setAttribute("x2", barX);
    // Allinea la linea di battuta alle 5 linee del pentagramma (92.31‚Äì153.85)
    line.setAttribute("y1", 92.31);
    line.setAttribute("y2", 153.85);
    line.setAttribute("stroke", "#111827");
    line.setAttribute("stroke-width", "2");
    line.classList.add("measure-bar-l4");
    (staffGroupTempo || staffSvgTempo).appendChild(line);
  });

  const durationsPool = (typeof DURATIONS_L4 !== "undefined" && Array.isArray(DURATIONS_L4))
    ? DURATIONS_L4.slice()
    : [
      { name:"semibreve",  beats:4 },
      { name:"minima",     beats:2 },
      { name:"semiminima", beats:1 }
    ];

  function pickMeasurePatternTempo() {
    const targetBeats = 4;
    const maxNotes = 7;
    let pattern = [];
    let sum = 0;
    let safety = 0;
    let lastName = null;

    while (sum < targetBeats && safety < 1000 && pattern.length < maxNotes) {
      const remaining = targetBeats - sum;
      let candidates = durationsPool.filter(d => d.beats <= remaining);
      if (!candidates.length) break;

      if (lastName !== null) {
        const alt = candidates.filter(d => d.name !== lastName);
        if (alt.length) {
          candidates = alt;
        }
      }

      const d = candidates[Math.floor(Math.random() * candidates.length)];
      pattern.push(d);
      sum += d.beats;
      lastName = d.name;
      safety++;
    }

    if (Math.abs(sum - targetBeats) < 0.0001 && pattern.length > 0) {
      return pattern;
    }

    const semiminima = durationsPool.find(d => d.name === "semiminima") || { name:"semiminima", beats:1 };
    return [semiminima, semiminima, semiminima, semiminima];
  }

  const measure1 = pickMeasurePatternTempo();
  const measure2 = pickMeasurePatternTempo();

  let pool = STAFF_CORE_POSITIONS.slice();

  function takeRandomPositionFromPool() {
    if (!pool.length) {
      pool = STAFF_CORE_POSITIONS.slice();
    }
    const idx = Math.floor(Math.random() * pool.length);
    return pool.splice(idx, 1)[0];
  }

  function placeMeasureTempo(pattern, fromX, toX) {
    const count = pattern.length;
    if (count === 0) return;
    for (let i = 0; i < count; i++) {
      const p = takeRandomPositionFromPool();
      const t = (count === 1) ? 0.5 : (i / Math.max(1, count - 1));
      const margin = 25;
      const leftX  = fromX + margin;
      const rightX = toX - margin;
      const cx = leftX + (rightX - leftX) * t;
      const cy = getStaffY(p.noteName, p.octave);

      const noteName = p.noteName;
      const octave = p.octave;

      const baseFreq = NOTE_FREQS[noteName] || 440;
      const freq = baseFreq * (octave === 2 ? 2 : 1);

      if (
        (cy > 200 || cy < 120) &&
        !(noteName === "re" && octave === 1) &&
        !(noteName === "fa" && octave === 2)
      ) {
        const neededY = cy;
        const refY = (neededY < 120) ? 120 : 200;
        const dir = (neededY < 120) ? -1 : 1;
        for (let ly = refY; dir < 0 ? ly >= neededY : ly <= neededY; ly += 10 * dir) {
          const ledger = document.createElementNS("http://www.w3.org/2000/svg", "line");
          ledger.setAttribute("x1", cx - 14);
          ledger.setAttribute("x2", cx + 14);
          ledger.setAttribute("y1", ly);
          ledger.setAttribute("y2", ly);
          ledger.setAttribute("stroke", "#111827");
          ledger.setAttribute("stroke-width", "2");
          ledger.classList.add("ledger-line");
          (staffGroupTempo || staffSvgTempo).appendChild(ledger);
        }
      }

      const duration = pattern[i];
      const beats = duration.beats;
      const durationName = duration.name;

      const group = document.createElementNS("http://www.w3.org/2000/svg", "g");
      group.classList.add("note-symbol");
      group.setAttribute("transform", "translate(" + cx + ", " + cy + ")");

      const head = document.createElementNS("http://www.w3.org/2000/svg", "ellipse");
      head.setAttribute("cx", 0);
      head.setAttribute("cy", 0);
      head.setAttribute("rx", NOTE_HEAD_RX);
      head.setAttribute("ry", NOTE_HEAD_RY);
      head.setAttribute("transform", "rotate(-15)");
      head.classList.add("note-head");
      if (durationName === "semiminima") {
        head.classList.add("filled");
      }
      group.appendChild(head);

      if (durationName === "minima_puntata" || durationName === "semiminima_puntata") {
        const dot = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        dot.setAttribute("cx", STEM_X + NOTE_HEAD_RX + 4);
        dot.setAttribute("cy", 0);
        dot.setAttribute("r", 3);
        dot.classList.add("note-head");
        dot.classList.add("filled");
        group.appendChild(dot);
      }

      if (durationName !== "semibreve") {
        const stem = document.createElementNS("http://www.w3.org/2000/svg", "line");
        stem.setAttribute("x1", STEM_X);
        stem.setAttribute("y1", 0);
        stem.setAttribute("x2", STEM_X);
        stem.setAttribute("y2", -42);
        stem.classList.add("note-stem");
        group.appendChild(stem);
      }

      (staffGroupTempo || staffSvgTempo).appendChild(group);

      const obj = {
        cx,
        cy,
        noteName,
        octave,
        freq,
        beats,
        durationName,
        element: group
      };
      currentNotesTempo.push(obj);
    }
  }

  placeMeasureTempo(measure1, startX, barPositions[0] || endX);
  placeMeasureTempo(measure2, barPositions[0] || startX, endX);
}

function handleTapTempo() {
  if (!currentNotesTempo.length) return;

  const target = currentNotesTempo[currentIndexTempo];
  if (!target) return;

  const now = performance.now();

  let inTime = false;
  if (currentIndexTempo === 0 || lastHitTimeTempo == null) {
    inTime = true;
  } else {
    const prev = currentNotesTempo[currentIndexTempo - 1];
    const expectedInterval = prev.beats * getBeatIntervalMsTempo();
    const actualInterval = now - lastHitTimeTempo;
    const delta = Math.abs(actualInterval - expectedInterval);
    const isLastNote = (currentIndexTempo === currentNotesTempo.length - 1);
    const effectiveTolerance = isLastNote ? (TOLERANCE_MS_TEMPO * 2.4) : TOLERANCE_MS_TEMPO;
    inTime = (delta <= effectiveTolerance);
  }

  if (inTime) {
    if (currentIndexTempo === 0 && !metronomeIntervalIdTempo) {
      startMetronomeTempo();
    }

    const noteDurationMs = (target.beats || 1) * getBeatIntervalMsTempo();
    playTone(target.freq, noteDurationMs);
    colorNoteElementByName(target);
    lastHitTimeTempo = now;
    currentIndexTempo++;

    if (currentIndexTempo >= currentNotesTempo.length) {
      // Ultima nota: il metronomo deve continuare a scandire per tutta la durata della nota
      if (typeof metronomeStopTimeoutTempo !== "undefined" && metronomeStopTimeoutTempo) {
        clearTimeout(metronomeStopTimeoutTempo);
        metronomeStopTimeoutTempo = null;
      }

      const stopDelay = noteDurationMs;
      metronomeStopTimeoutTempo = setTimeout(() => {
        stopMetronomeTempo();
      }, stopDelay);

      // Possiamo gi√† preparare un nuovo pattern, il metronomo si fermer√† solo a fine nota
      createNotesTempo();
      return;
    }
  } else {
    playError();
    consecutiveErrorsTempo++;
    updateErrorPill(errorPillTempo, consecutiveErrorsTempo, 7);
    stopMetronomeTempo();
    restartSamePatternTempo();
  }
}

if (tempoActionBtn && staffSvgTempo) {
  tempoActionBtn.addEventListener("click", handleTapTempo);
}

if (resetBtnTempo && staffSvgTempo) {
  resetBtnTempo.addEventListener("click", () => {
    stopMetronomeTempo();
    createNotesTempo();
  });
}

if (bpmInputTempo) {
  bpmInputTempo.addEventListener("change", () => {
    let v = parseInt(bpmInputTempo.value, 10);
    if (isNaN(v)) v = 80;
    v = Math.max(40, Math.min(160, v));
    bpmInputTempo.value = v;
    bpmTempo = v;
    if (metronomeIntervalIdTempo) {
      startMetronomeTempo();
    }
  });
}

if (metronomeDotTempo) {
  metronomeDotTempo.addEventListener("click", () => {
    stopMetronomeTempo();
    createNotesTempo();
  });
}

if (staffSvgTempo) {
  bpmTempo = bpmInputTempo ? parseInt(bpmInputTempo.value, 10) || 80 : 80;
  createNotesTempo();
}
/* ===========================
   MODALIT√Ä PLAY
   =========================== */

const staffSvgPlay  = document.getElementById("staffSvgPlay");
const pianoKeysPlay = document.getElementById("pianoKeysPlay");
const resetBtnPlay  = document.getElementById("resetBtnPlay");

let playNotes = [];
let playNoteIndex = 0;
const PLAY_MAX_NOTES = 16;
const PLAY_START_X = 220;
const PLAY_END_X   = 780;
const PLAY_STEP    = (PLAY_END_X - PLAY_START_X) / (PLAY_MAX_NOTES - 1);

function clearPlayStaff() {
  if (!staffSvgPlay) return;
  staffSvgPlay.querySelectorAll(".note-circle[data-play='1'], .ledger-line[data-play='1']").forEach(e => e.remove());
  playNotes = [];
  playNoteIndex = 0;
}

function addPlayNote(noteName, octave) {
  if (!staffSvgPlay) return;
  if (!playSessionActive && !testPlayUnlocked) return;
  const y = getStaffY(noteName, octave);
  if (y == null) return;

  if (playNoteIndex >= PLAY_MAX_NOTES) {
    clearPlayStaff();
  }

  const cx = PLAY_START_X + PLAY_STEP * playNoteIndex;
  const cy = y;

  if ((cy > 200 || cy < 120) && !(noteName === "re" && octave === 1) && !(noteName === "sol" && octave === 2)) {
    const ledger = document.createElementNS("http://www.w3.org/2000/svg","line");
    ledger.setAttribute("x1", cx - 16);
    ledger.setAttribute("x2", cx + 16);
    ledger.setAttribute("y1", cy);
    ledger.setAttribute("y2", cy);
    ledger.classList.add("ledger-line");
    ledger.dataset.play = "1";
    staffSvgPlay.appendChild(ledger);
  }

  const circle = document.createElementNS("http://www.w3.org/2000/svg","circle");
  circle.setAttribute("cx", cx);
  circle.setAttribute("cy", cy);
  circle.setAttribute("r", 9);
  circle.classList.add("note-circle");
  circle.dataset.play = "1";
  const col = getNoteColor(noteName);
  circle.style.fill = col;
  circle.style.stroke = "#111827";
  staffSvgPlay.appendChild(circle);

  playNotes.push({ element: circle, cx, cy, noteName, octave });
  playNoteIndex++;
}

function renderPianoPlay() {
  if (!pianoKeysPlay) return;
  pianoKeysPlay.innerHTML = "";
  const whiteNotesOrder = ["do","re","mi","fa","sol","la","si"];
  const totalWhite = 14;

  for (let octave = 1; octave <= 2; octave++) {
    whiteNotesOrder.forEach(noteName => {
      let baseFreq = NOTE_FREQS[noteName] || 440;
      if (octave === 2) baseFreq *= 2;

      const whiteKey = document.createElement("div");
      whiteKey.className = "white-key";
      whiteKey.dataset.noteName = noteName;
      whiteKey.dataset.octave = String(octave);
      whiteKey.dataset.freq = baseFreq;
      whiteKey.textContent = "";

      whiteKey.style.background = "linear-gradient(to bottom, #ffffff 0%, #f3f4f6 40%, #e5e7eb 100%)";

      whiteKey.onclick = () => {
        animateKeyPress(whiteKey);
        playTone(baseFreq);
        addPlayNote(noteName, octave);
      };

      pianoKeysPlay.appendChild(whiteKey);
    });
  }

  const blackLayout = [
    { name:"do#", whiteIndex:0, octave:1 },
    { name:"re#", whiteIndex:1, octave:1 },
    { name:"fa#", whiteIndex:3, octave:1 },
    { name:"sol#",whiteIndex:4, octave:1 },
    { name:"la#", whiteIndex:5, octave:1 },
    { name:"do#", whiteIndex:7, octave:2 },
    { name:"re#", whiteIndex:8, octave:2 },
    { name:"fa#", whiteIndex:10, octave:2 },
    { name:"sol#",whiteIndex:11, octave:2 },
    { name:"la#", whiteIndex:12, octave:2 }
  ];

  blackLayout.forEach(b => {
    const baseFreq = NOTE_FREQS[b.name] || 440;
    const freq = baseFreq * (b.octave === 2 ? 2 : 1);
    const blackKey = document.createElement("div");
    blackKey.className = "black-key";
    blackKey.textContent = "";

    const leftPercent = ((b.whiteIndex + 1) / totalWhite) * 100;
    blackKey.style.left = leftPercent + "%";

    blackKey.onclick = (ev) => {
      ev.stopPropagation();
      animateKeyPress(blackKey);
      playTone(freq);
      // tasti neri non scrivono
    };

    pianoKeysPlay.appendChild(blackKey);
  });
}

if (pianoKeysPlay && staffSvgPlay) {
  renderPianoPlay();
}

/* ===========================
   RESET GLOBALE
   =========================== */

function resetAllLevels() {
  // L1
  rainbowsL1 = 0;
  consecutiveErrorsL1 = 0;
  currentIndexL1 = 0;
  selectedColorL1 = null;
  if (rainbowWinIndexL1) rainbowWinIndexL1.textContent = "0";
  if (medalsPanelL1) medalsPanelL1.innerHTML = "";
  noteButtonsL1.forEach(btn => btn.classList.remove("selected"));
  if (staffSvgL1) {
    createNotesL1();
    updateStatusL1();
  }
  clearHintL1();

  // L2
  rainbows = 0;
  consecutiveErrors = 0;
  currentIndex = 0;
  if (rainbowWinIndex) rainbowWinIndex.textContent = "0";
  if (medalsPanel) medalsPanel.innerHTML = "";
  if (staffSvg) {
    createNotes();
    updateStatus();
  }

  // L3
  rainbowsL3 = 0;
  consecutiveErrorsL3 = 0;
  currentIndexL3 = 0;
  if (rainbowWinIndexL3) rainbowWinIndexL3.textContent = "0";
  if (medalsPanelL3) medalsPanelL3.innerHTML = "";
  if (staffSvgL3) {
    createNotesL3();
    updateStatusL3();
  }

  // L4
  rainbowsL4Local = 0;
  consecutiveErrorsL4 = 0;
  currentIndexL4 = 0;
  lastHitTimeL4 = null;
  if (rainbowWinIndexL4) rainbowWinIndexL4.textContent = "0";
  if (medalsPanelL4) medalsPanelL4.innerHTML = "";
  if (typeof softResetLevel4 === "function") {
    softResetLevel4();
  } else {
    if (staffSvgL4 && pianoKeysElL4) {
      stopMetronomeL4();
      updateErrorPill(errorPillL4, consecutiveErrorsL4, 7);
      createNotesL4();
      renderPianoL4();
    }
  }

  // Play
  clearPlayStaff();

  updateRainbowCountersGlobal();
}

if (resetBtnL1)   resetBtnL1.onclick   = resetAllLevels;
if (resetBtn)     resetBtn.onclick     = resetAllLevels;
if (resetBtnL3)   resetBtnL3.onclick   = resetAllLevels;
if (resetBtnPlay) resetBtnPlay.onclick = () => clearPlayStaff();


/* ===========================
   PAGINA TROFEI
   =========================== */

const trophyContentEl = document.getElementById("trophyContent");
const chestGridEl     = document.getElementById("chestGrid");
const clearChestsBtn  = document.getElementById("clearChestsBtn");
const trophyBackBtn   = document.getElementById("trophyBackBtn");
const trophyHomeBtn   = document.getElementById("trophyHomeBtn");
const trophyOverlayEl = document.getElementById("trophyOverlay");
const trophyOverlayContentEl = document.getElementById("trophyOverlayContent");
const trophyOverlayCloseBtn = document.getElementById("trophyOverlayClose");


function showChestDetails(session) {
  if (!trophyOverlayEl || !trophyOverlayContentEl || !session) return;

  const bronzeCount = Number(session.bronze) || 0;
  const silverCount = Number(session.silver) || 0;
  const goldCount   = Number(session.gold)   || 0;
  const greenCount  = Number(session.green)  || 0;

  const labelNumber = (typeof session.displayNumber === "number")
    ? session.displayNumber
    : session.id;

  // Pulisci contenuto precedente
  trophyOverlayContentEl.textContent = "";

  // Sezione medaglie
  const section = document.createElement("div");
  section.className = "trophy-section";
  const h2 = document.createElement("h2");
  h2.textContent = `Scrigno ${labelNumber}`;
  section.appendChild(h2);

  const row = document.createElement("div");
  row.className = "trophy-medals-row";

  const totalCoins = bronzeCount + silverCount + goldCount + greenCount;
  if (totalCoins === 0) {
    const empty = document.createElement("div");
    empty.className = "trophy-empty";
    empty.textContent = "Nessuna medaglia in questa sessione.";
    row.appendChild(empty);
  } else {
    const addMedal = (cls, count) => {
      for (let i = 0; i < count; i++) {
        const d = document.createElement("div");
        d.className = `medal-icon ${cls}`;
        d.textContent = "‚óè";
        row.appendChild(d);
      }
    };
    addMedal("bronze", bronzeCount);
    addMedal("silver", silverCount);
    addMedal("gold", goldCount);
    addMedal("green", greenCount);
  }

  section.appendChild(row);
  trophyOverlayContentEl.appendChild(section);

  // Gettoni Play legati a questa sessione
  const tokens = (typeof session.tokens === "number") ? session.tokens : 0;
  if (tokens > 0) {
    const tokenSection = document.createElement("div");
    tokenSection.className = "trophy-section";
    const th2 = document.createElement("h2");
    th2.textContent = "Gettoni Play";
    tokenSection.appendChild(th2);

    const trow = document.createElement("div");
    trow.className = "trophy-medals-row";
    for (let i = 0; i < tokens; i++) {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "token-icon-btn";
      btn.dataset.sessionId = String(session.id);
      // SVG markup interno (controllato)
      btn.innerHTML = getTokenSvgMarkup("token-svg");
      btn.addEventListener("click", () => {
        const sid = parseInt(btn.dataset.sessionId || "", 10);
        if (!isNaN(sid)) spendTokenFromSession(sid);
      });
      trow.appendChild(btn);
    }

    tokenSection.appendChild(trow);
    trophyOverlayContentEl.appendChild(tokenSection);
  }

  trophyOverlayEl.classList.add("active");
}


function renderChestGrid() {
  if (!chestGridEl) return;
  chestGridEl.innerHTML = "";
  const maxSlots = 18;

  // prendi solo le sessioni che hanno almeno una medaglia
  const filled = sessions
    .filter(s => ((s.bronze || 0) + (s.silver || 0) + (s.gold || 0) + (s.green || 0)) > 0)
    .sort((a, b) => a.id - b.id);

  for (let i = 0; i < maxSlots; i++) {
    const btn = document.createElement("button");
    btn.type = "button";

    if (i < filled.length) {
      const session = filled[i];
      const labelNumber = (typeof session.displayNumber === "number")
        ? session.displayNumber
        : session.id;
      btn.className = "chest-btn chest-btn-filled";
      btn.innerHTML = `<div style="position:relative; width:100%; display:flex; justify-content:center; align-items:center;">  <span style="font-size:4rem; line-height:1;">üß∞</span>  <span style="position:absolute; font-size:2rem; font-weight:bold; color:#fff; transform: translateY(5px);">${labelNumber}</span></div>`;
      btn.addEventListener("click", () => {
        showChestDetails(session);
      });
    } else {
      btn.className = "chest-btn chest-btn-empty";
      btn.disabled = true;
      btn.innerHTML = "&nbsp;";
    }


if (trophyOverlayCloseBtn && trophyOverlayEl) {
  trophyOverlayCloseBtn.addEventListener("click", () => {
    trophyOverlayEl.classList.remove("active");
  });
}

if (trophyOverlayEl) {
  trophyOverlayEl.addEventListener("click", (ev) => {
    if (ev.target === trophyOverlayEl) {
      trophyOverlayEl.classList.remove("active");
    }
  });
}
    chestGridEl.appendChild(btn);
  }
}

if (clearChestsBtn) {
  clearChestsBtn.addEventListener("click", () => {
    const conferma = window.confirm("Cancellare tutto?");
    if (!conferma) return;

    // Svuota tutte le sessioni esistenti
    clearAllSessionChests();

    // Crea subito una nuova sessione vuota per la stessa partita
    startNewSessionChest();

    if (trophyContentEl) {
      trophyContentEl.style.display = "none";
      trophyContentEl.innerHTML = "";
    }
    // Aggiorna la griglia degli scrigni
    renderChestGrid();
    alert("Tutti gli scrigni sono stati cancellati.");
  });
}
/* ===========================
   HOME, MENU, TROFEI, SUGGERIMENTO
   =========================== */

let lastGamePageId = "level2Page";
let homePlayBtn = null;

document.addEventListener("DOMContentLoaded", function() {
  // Responsive layout: staff centered, keyboard anchored bottom with 10px margins (no deformation)
  function _mr_getDirectChildren(appEl){ return Array.from(appEl.children); }

  function _mr_setupMiddleArea(appEl){
    if(!appEl) return;
    if(appEl.querySelector(':scope > .middle-area')) return;

    const topPanel = appEl.querySelector(':scope > .top-panel');
    if(!topPanel) return;

    const kids = _mr_getDirectChildren(appEl);
    const kbCandidates = kids.filter(el => el.classList.contains('keyboard-container') || el.classList.contains('note-buttons-container'));
    if(!kbCandidates.length) return;

    const keyboardEl = kbCandidates[kbCandidates.length - 1];
    const startIndex = kids.indexOf(topPanel) + 1;
    const endIndex = kids.indexOf(keyboardEl);
    if(endIndex <= startIndex) return;

    const middle = document.createElement('div');
    middle.className = 'middle-area';
    kids.slice(startIndex, endIndex).forEach(n => middle.appendChild(n));
    appEl.insertBefore(middle, keyboardEl);
  }

  function _mr_updatePianoSizing(){
    document.querySelectorAll('.piano-keys').forEach(el=>{
      const w = el.clientWidth || 0;
      if(!w) return;
      const h = Math.round(Math.min(260, Math.max(150, w * 0.22)));
      el.style.setProperty('--pianoKeysH', h + 'px');
    });
  }

  function _mr_applyResponsiveLayout(){
    document.querySelectorAll('.page-container .app').forEach(appEl=>_mr_setupMiddleArea(appEl));
    _mr_updatePianoSizing();
  }

  window.addEventListener('resize', _mr_applyResponsiveLayout, {passive:true});
  window.addEventListener('orientationchange', _mr_applyResponsiveLayout, {passive:true});
  _mr_applyResponsiveLayout();

  loadSessionsFromStorage();
  renderChestGrid();
  startNewSessionChest();
  updateTokensUIAll();

  const homeScreen = document.getElementById("homeScreen");
  const btnLevel1  = document.getElementById("btnLevel1");
  const btnLevel2  = document.getElementById("btnLevel2");
  const btnLevel3  = document.getElementById("btnLevel3");
  const btnLevel4  = document.getElementById("btnLevel4");
  const level1Page = document.getElementById("level1Page");
  const level2Page = document.getElementById("level2Page");
  const level3Page = document.getElementById("level3Page");
  const level4Page = document.getElementById("level4Page");
  const learnTempoPage = document.getElementById("learnTempoPage");
  const playPage   = document.getElementById("playPage");

  homePlayBtn = document.getElementById("homePlayBtn");

  const homeTestToggle = document.getElementById("homeTestToggle");
  if (homeTestToggle) {
    homeTestToggle.addEventListener("change", function() {
      testPlayUnlocked = homeTestToggle.checked;
      updateHomePlayButtonState();
    });
  }


  const levelSelectOverlay = document.getElementById("levelSelectOverlay");
  const btnOpenLevelSelect = document.getElementById("btnOpenLevelSelect");
  const btnLevelSelectClose = document.getElementById("btnLevelSelectClose");
  const levelSelectButtons = document.querySelectorAll(".level-select-btn");

  const learnSelectOverlay = document.getElementById("learnSelectOverlay");
  const homeLearnMainBtn   = document.getElementById("homeLearnMainBtn");
  const btnLearnSelectClose = document.getElementById("learnSelectClose");

  const menuBtnL1   = document.getElementById("menuBtnL1");
  const menuBtnL2   = document.getElementById("menuBtnL2");
  const menuBtnL3   = document.getElementById("menuBtnL3");
  const menuBtnL4   = document.getElementById("menuBtnL4");
  const menuBtnPlay = document.getElementById("menuBtnPlay");
  const menuBtnTempo = document.getElementById("menuBtnTempo");
  const learnNotesPage = document.getElementById("learnNotesPage");
  const menuBtnLearn = document.getElementById("menuBtnLearn");
  const homeLearnNotesBtn = document.getElementById("homeLearnNotesBtn");
  const homeLearnTempoBtn = document.getElementById("homeLearnTempoBtn");

  const trophyBtnL1   = document.getElementById("trophyBtnL1");
  const trophyBtnL2   = document.getElementById("trophyBtnL2");
  const trophyBtnL3   = document.getElementById("trophyBtnL3");
  const trophyBtnL4   = document.getElementById("trophyBtnL4");
  const trophyBtnPlay = document.getElementById("trophyBtnPlay");
  const trophyBtnTempo = document.getElementById("trophyBtnTempo");

  const clefTrebleButtons = document.querySelectorAll(".clef-treble-btn");
  const clefBassButtons   = document.querySelectorAll(".clef-bass-btn");

  function refreshClefButtons() {
    const isTreble = (currentClef === CLEF_TREBLE);

    // Regola richiesta:
    // - Se siamo in chiave di violino (treble), sullo schermo deve esserci SOLO il tasto della chiave di basso (opposta)
    // - Se siamo in chiave di basso, deve esserci SOLO il tasto della chiave di violino (opposta)

    clefTrebleButtons.forEach(btn => {
      // Mostra il tasto "violino" SOLO quando siamo in basso (serve per tornare al violino)
      btn.classList.toggle("clef-hidden", isTreble);
      btn.classList.remove("active-clef");
      btn.setAttribute("aria-label", "Passa alla chiave di violino");
    });

    clefBassButtons.forEach(btn => {
      // Mostra il tasto "basso" SOLO quando siamo in violino (serve per passare al basso)
      btn.classList.toggle("clef-hidden", !isTreble);
      btn.classList.remove("active-clef");
      btn.setAttribute("aria-label", "Passa alla chiave di basso");
    });
  }

  function updateLearnNotesView() {
    const groupTreble = document.getElementById("learnNotesGroupTreble");
    const groupBass   = document.getElementById("learnNotesGroupBass");
    if (!groupTreble || !groupBass) return;

    if (currentClef === CLEF_TREBLE) {
      groupTreble.style.display = "";
      groupBass.style.display = "none";
    } else if (currentClef === CLEF_BASS) {
      groupTreble.style.display = "none";
      groupBass.style.display = "";
    }
  }


function regenerateNotesForCurrentPage() {
    if (lastGamePageId === "level1Page") {
      if (typeof softResetLevel1 === "function") softResetLevel1();
    } else if (lastGamePageId === "level2Page") {
      if (typeof softResetLevel2 === "function") softResetLevel2();
    } else if (lastGamePageId === "level3Page") {
      if (typeof softResetLevel3 === "function") softResetLevel3();
    } else if (lastGamePageId === "level4Page") {
      if (typeof softResetLevel4 === "function") softResetLevel4();
    } else if (lastGamePageId === "playPage") {
      if (typeof clearPlayStaff === "function") clearPlayStaff();
    }
  }

  clefTrebleButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      setClef(CLEF_TREBLE);
      refreshClefButtons();
      regenerateNotesForCurrentPage();
      updateLearnNotesView();
    });
  });

  clefBassButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      setClef(CLEF_BASS);
      refreshClefButtons();
      regenerateNotesForCurrentPage();
      updateLearnNotesView();
    });
  });

  // allinea UI e simboli alla chiave iniziale
  refreshClefButtons();
  updateStaffClefSymbols();
  updateLearnNotesView();


  const hintBtnL1 = document.getElementById("hintBtnL1");

  const nameInput = document.getElementById("playerNameInput");
  const genderRadios = document.querySelectorAll('input[name="gender"]');
  const genderOptionLabels = document.querySelectorAll(".home-gender-option");
  const homeTrophyBtn = document.getElementById("homeTrophyBtn");
  const audioResetBtn = document.getElementById("audioResetBtn");
  const resetAudioBtnL1 = document.getElementById("resetAudioBtnL1");
  const resetAudioBtnL2 = document.getElementById("resetAudioBtnL2");
  const resetAudioBtnL3 = document.getElementById("resetAudioBtnL3");
  const resetAudioBtnL4 = document.getElementById("resetAudioBtnL4");
  const resetAudioBtnPlay = document.getElementById("resetAudioBtnPlay");
  const resetAudioBtnTempo = document.getElementById("resetAudioBtnTempo");
  const resetAudioBtnLearn = document.getElementById("resetAudioBtnLearn");


  metronomeToggleBtnL4 = document.getElementById("metronomeToggleSwitchL4");
  metronomeToggleBtnTempo = document.getElementById("metronomeToggleSwitchTempo");

  if (metronomeToggleBtnL4) {
    metronomeToggleBtnL4.addEventListener("change", () => {
      if (metronomeToggleBtnL4.checked) startMetronomeL4();
      else stopMetronomeL4();
    });
    // Allinea lo stato iniziale
    metronomeToggleBtnL4.checked = !!metronomeIntervalIdL4;
  }

  if (metronomeToggleBtnTempo) {
    metronomeToggleBtnTempo.addEventListener("change", () => {
      if (metronomeToggleBtnTempo.checked) startMetronomeTempo();
      else stopMetronomeTempo();
    });
    // Allinea lo stato iniziale
    metronomeToggleBtnTempo.checked = !!metronomeIntervalIdTempo;
  }

  function refreshGenderButtons() {
    genderOptionLabels.forEach(label => {
      const input = label.querySelector('input[type="radio"]');
      if (input && input.checked) label.classList.add("active");
      else label.classList.remove("active");
    });
  }

  if (nameInput) {
    nameInput.addEventListener("input", () => {
      playerName = nameInput.value.trim();
    });
  }

  if (genderRadios) {
    genderRadios.forEach(radio => {
      radio.addEventListener("change", () => {
        if (radio.checked) {
          playerGender = radio.value === "F" ? "F" : "M";
          refreshGenderButtons();
        }
      });
    });
  }

  refreshGenderButtons();

  

  // ===========================
  // FIT TITOLI (per livello) - massimizza senza invadere i tasti
  // ===========================
  function fitLevelTitleInTopRow(pageEl) {
    if (!pageEl) return;
    const topRow = pageEl.querySelector(".top-row");
    if (!topRow) return;

    const title = topRow.querySelector("h1.rainbow-title-level");
    const left  = topRow.querySelector(".top-left-controls");
    const right = topRow.querySelector(".top-right-controls");
    if (!title || !left || !right) return;

    title.style.whiteSpace = "nowrap";
    title.style.margin = "0";
    title.style.padding = "0";
    title.style.minWidth = "0";

    const rowRect = topRow.getBoundingClientRect();
    const leftRect = left.getBoundingClientRect();
    const rightRect = right.getBoundingClientRect();

    const safetyPad = 14; // px
    const availableWidth = Math.max(80, rowRect.width - leftRect.width - rightRect.width - safetyPad);
    title.style.maxWidth = availableWidth + "px";

    const targetHeight = Math.max(leftRect.height, rightRect.height);

    const minPx = 18;
    const maxPx = Math.min(84, Math.floor(window.innerHeight * 0.18));

    let lo = minPx, hi = maxPx, best = minPx;
    while (lo <= hi) {
      const mid = (lo + hi) >> 1;
      title.style.fontSize = mid + "px";

      const w = title.scrollWidth;
      const h = title.getBoundingClientRect().height;

      if (w <= availableWidth && h <= targetHeight + 2) {
        best = mid;
        lo = mid + 1;
      } else {
        hi = mid - 1;
      }
    }
    title.style.fontSize = best + "px";
  }

  function fitVisibleLevelTitles() {
    const visiblePages = Array.from(document.querySelectorAll(".page-container"))
      .filter(el => window.getComputedStyle(el).display !== "none");

    visiblePages.forEach(pageEl => fitLevelTitleInTopRow(pageEl));
  }

function hideAllPages() {
    level1Page.style.display = "none";
    level2Page.style.display = "none";
    level3Page.style.display = "none";
    level4Page.style.display = "none";
    playPage.style.display   = "none";
    trophyPageEl.style.display = "none";
    if (learnNotesPage) learnNotesPage.style.display = "none";
    if (learnTempoPage) learnTempoPage.style.display = "none";
  }

  function showHome() {
    hideAllPages();
    homeScreen.style.display = "flex";
    // La musichetta introduttiva parte al primo sblocco audio (gestito da unlockAudioOnce)
  }

  function showLevel(pageId) {
    hideAllPages();
    homeScreen.style.display = "none";
    const pageMap = {
      "level1Page": level1Page,
      "level2Page": level2Page,
      "level3Page": level3Page,
      "level4Page": level4Page
    };
    if (pageMap[pageId]) {
      pageMap[pageId].style.display = "flex";
      requestAnimationFrame(() => fitVisibleLevelTitles());
      requestAnimationFrame(() => { try { window.__fitPianos && window.__fitPianos(); } catch(e){} });
      lastGamePageId = pageId;
      if (pageId === "level1Page") softResetLevel1();
      if (pageId === "level2Page") softResetLevel2();
      if (pageId === "level3Page") softResetLevel3();
      if (pageId === "level4Page") softResetLevel4();
    }
  }

  function showLearnNotes() {
    hideAllPages();
    homeScreen.style.display = "none";
    if (learnNotesPage) {
      learnNotesPage.style.display = "flex";
      requestAnimationFrame(() => fitVisibleLevelTitles());
    }
  }

  function showLearnTempo() {
    hideAllPages();
    homeScreen.style.display = "none";
    if (learnTempoPage) {
      learnTempoPage.style.display = "flex";
      requestAnimationFrame(() => fitVisibleLevelTitles());
    }
  }

  function showTrophyPage() {
    homeScreen.style.display = "none";
    level1Page.style.display = "none";
    level2Page.style.display = "none";
    level3Page.style.display = "none";
    level4Page.style.display = "none";
    playPage.style.display   = "none";
    if (learnNotesPage) learnNotesPage.style.display = "none";
    if (learnTempoPage) learnTempoPage.style.display = "none";
    trophyPageEl.style.display = "flex";
    if (trophyContentEl) {
      trophyContentEl.style.display = "none";
      trophyContentEl.innerHTML = "";
    }
    renderChestGrid();
    updateTokensUIAll();
  }


  if (btnOpenLevelSelect && levelSelectOverlay) {
    btnOpenLevelSelect.addEventListener("click", () => {
      levelSelectOverlay.classList.add("active");
    });
  }

  if (btnLevelSelectClose && levelSelectOverlay) {
    btnLevelSelectClose.addEventListener("click", () => {
      levelSelectOverlay.classList.remove("active");
    });
  }

  if (levelSelectButtons && levelSelectButtons.length > 0) {
    levelSelectButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const target = btn.getAttribute("data-level");
        if (target) {
          showLevel(target);
          if (levelSelectOverlay) levelSelectOverlay.classList.remove("active");
        }
      });
    });
  }

  

  if (homeLearnMainBtn && learnSelectOverlay) {
    homeLearnMainBtn.addEventListener("click", () => {
      learnSelectOverlay.classList.add("active");
    });
  }

  if (btnLearnSelectClose && learnSelectOverlay) {
    btnLearnSelectClose.addEventListener("click", () => {
      learnSelectOverlay.classList.remove("active");
    });
  }

  // Mappa delle note: evidenziazione dei pallini sul pentagramma
  const learnNoteButtons = (learnNotesPage)
    ? learnNotesPage.querySelectorAll(".note-button")
    : [];

  function highlightLearnNote(noteName) {
    if (!learnStaffSvg) return;
    const allCircles = learnStaffSvg.querySelectorAll(".learn-note circle");
    allCircles.forEach(c => c.classList.remove("learn-highlight"));
    if (!noteName) return;
    const targetClass = "learn-" + noteName;
    const targets = learnStaffSvg.querySelectorAll(".learn-note circle." + targetClass);
    targets.forEach(c => c.classList.add("learn-highlight"));
  }

  learnNoteButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      const noteName = btn.getAttribute("data-note");

      // Comportamento identico alla tastiera del Livello 1
      animateNoteButtonPressL1(btn);
      const freq = NOTE_FREQS[noteName] || 440;
      playTone(freq);
      setSelectedColorL1(noteName);
      if (autoColorL1) handleAutoColorL1(noteName);

      // Comportamento specifico della mappa: evidenzia la nota sul pentagramma
      highlightLearnNote(noteName);
    });
  });

if (btnLevel1) btnLevel1.addEventListener("click", () => { showLevel("level1Page"); });
  if (btnLevel2) btnLevel2.addEventListener("click", () => { showLevel("level2Page"); });
  if (btnLevel3) btnLevel3.addEventListener("click", () => { showLevel("level3Page"); });
  if (btnLevel4) btnLevel4.addEventListener("click", () => { showLevel("level4Page"); });
  if (homeTrophyBtn) homeTrophyBtn.addEventListener("click", showTrophyPage);

  if (homeLearnNotesBtn) homeLearnNotesBtn.addEventListener("click", () => {
    if (learnSelectOverlay) learnSelectOverlay.classList.remove("active");
    showLearnNotes();
  });
  if (homeLearnTempoBtn) homeLearnTempoBtn.addEventListener("click", () => {
    if (learnSelectOverlay) learnSelectOverlay.classList.remove("active");
    showLearnTempo();
  });

  if (menuBtnL1)   menuBtnL1.addEventListener("click", showHome);
  if (menuBtnL2)   menuBtnL2.addEventListener("click", showHome);
  if (menuBtnL3)   menuBtnL3.addEventListener("click", showHome);
  if (menuBtnL4)   menuBtnL4.addEventListener("click", showHome);
  if (menuBtnPlay) menuBtnPlay.addEventListener("click", showHome);
  if (menuBtnTempo) menuBtnTempo.addEventListener("click", showHome);
  if (menuBtnLearn) menuBtnLearn.addEventListener("click", showHome);

  if (trophyBtnL1)   trophyBtnL1.addEventListener("click", showTrophyPage);
  if (trophyBtnL2)   trophyBtnL2.addEventListener("click", showTrophyPage);
  if (trophyBtnL3)   trophyBtnL3.addEventListener("click", showTrophyPage);
  if (trophyBtnL4)   trophyBtnL4.addEventListener("click", showTrophyPage);
  if (trophyBtnPlay) trophyBtnPlay.addEventListener("click", showTrophyPage);
  if (trophyBtnTempo) trophyBtnTempo.addEventListener("click", showTrophyPage);
  if (homePlayBtn) {
    homePlayBtn.addEventListener("click", () => {
      // In modalit√† TEST, il toggle pu√≤ sbloccare la pagina play anche senza sessione attiva
      if (!playSessionActive && !testPlayUnlocked) return;

      // Quando si entra in modalit√† Play, attiva automaticamente l'audio
// solo se l'utente non ha gi√† scelto esplicitamente lo stato audio.
      if (!audioEnabled && !audioPreferenceExplicit) {
        setAudioEnabled(true, false);
      }
homeScreen.style.display = "none";
      level1Page.style.display = "none";
      level2Page.style.display = "none";
      level3Page.style.display = "none";
      trophyPageEl.style.display = "none";
      if (playPage) {
        playPage.style.display = "flex";
        lastGamePageId = "playPage";
      }
    });
  }

  updateHomePlayButtonState();

  if (trophyBackBtn) {
    trophyBackBtn.addEventListener("click", () => {
      if (lastGamePageId) {
        trophyPageEl.style.display = "none";
        if (lastGamePageId === "level1Page") level1Page.style.display = "flex";
        if (lastGamePageId === "level2Page") level2Page.style.display = "flex";
        if (lastGamePageId === "level3Page") level3Page.style.display = "flex";
        if (lastGamePageId === "level4Page") level4Page.style.display = "flex";
        if (lastGamePageId === "playPage")   playPage.style.display   = "flex";
      } else {
        showHome();
      }
    });
  }

  if (trophyHomeBtn) {
    trophyHomeBtn.addEventListener("click", showHome);
  }

  if (hintBtnL1) {
    hintBtnL1El = hintBtnL1;
    updateHintLabelL1();
    hintBtnL1.addEventListener("click", handleHintClickL1);
  }

  if (audioResetBtn) {
    audioResetBtn.addEventListener("click", toggleAudio);
  }
  if (resetAudioBtnL1) resetAudioBtnL1.addEventListener("click", toggleAudio);
  if (resetAudioBtnL2) resetAudioBtnL2.addEventListener("click", toggleAudio);
  if (resetAudioBtnL3) resetAudioBtnL3.addEventListener("click", toggleAudio);
  if (resetAudioBtnL4) resetAudioBtnL4.addEventListener("click", toggleAudio);
  if (resetAudioBtnPlay) resetAudioBtnPlay.addEventListener("click", toggleAudio);
  if (resetAudioBtnTempo) resetAudioBtnTempo.addEventListener("click", toggleAudio);
  if (resetAudioBtnLearn) resetAudioBtnLearn.addEventListener("click", toggleAudio);
  
  

  // Imposta audio da preferenza (persistente) e aggiorna subito i pulsanti
  const _initialAudio = audioEnabled;
  audioEnabled = false;
  setAudioEnabled(_initialAudio, false);
  isAudioInit = false;
// Inizializza sistema gettoni (non persistenti)
  lastTotalMedalsForTokens = getTotalMedalsCount();
  updateTokensUIAll();

  showHome();
  updateRainbowCountersGlobal();

  // Re-fit titoli quando cambia orientamento / dimensione (iOS incluso)
  window.addEventListener("resize", () => {
    requestAnimationFrame(() => fitVisibleLevelTitles());
  });
  window.addEventListener("orientationchange", () => {
    setTimeout(() => fitVisibleLevelTitles(), 80);
  });


});
</script>


<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", async () => {
      try {
        const reg = await navigator.serviceWorker.register("./service-worker.js");

        // Se c'√® gi√† un SW in attesa, forzalo subito
        if (reg.waiting) {
          reg.waiting.postMessage({ type: "SKIP_WAITING" });
        }

        // Quando arriva un update, forzalo
        reg.addEventListener("updatefound", () => {
          const newWorker = reg.installing;
          if (!newWorker) return;
          newWorker.addEventListener("statechange", () => {
            if (newWorker.state === "installed") {
              if (navigator.serviceWorker.controller) {
                try { newWorker.postMessage({ type: "SKIP_WAITING" }); } catch (e) {}
              }
            }
          });
        });

        // Ricarica UNA sola volta quando il nuovo SW prende il controllo
        navigator.serviceWorker.addEventListener("controllerchange", () => {
          if (sessionStorage.getItem("swReloadedOnce")) return;
          sessionStorage.setItem("swReloadedOnce", "1");
          window.location.reload();
        });
      } catch (err) {
        console.log("Service worker registration failed:", err);
      }
    });
  }
</script>


<script>
// Fix 100vh su Safari / iOS usando una variabile CSS --vh
(() => {
  const updateViewportVH = () => {
    const h = (window.visualViewport && window.visualViewport.height)
      ? window.visualViewport.height
      : window.innerHeight;
    const vh = h * 0.01;
    document.documentElement.style.setProperty("--vh", `${vh}px`);
  };

  // Aggiornamenti standard
  window.addEventListener("resize", updateViewportVH);
  window.addEventListener("orientationchange", updateViewportVH);

  // Aggiornamenti specifici per Safari/iOS (barre dinamiche / viewport visuale)
  if (window.visualViewport) {
    window.visualViewport.addEventListener("resize", updateViewportVH);
    window.visualViewport.addEventListener("scroll", updateViewportVH);
  }

  // prima chiamata
  updateViewportVH();
})();
</script>

</body>
</html>
